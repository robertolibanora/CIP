{% extends "auth/base_auth.html" %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-cream-50 via-white to-primary-50 relative overflow-hidden py-8">
  <!-- Background decorative elements -->
  <div class="absolute inset-0 overflow-hidden">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-primary-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-green-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
    <div class="absolute top-1/2 left-1/2 w-80 h-80 bg-green-300 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-blob animation-delay-4000"></div>
  </div>

  <!-- Main content -->
  <div class="relative z-10 w-full max-w-2xl px-4 sm:px-6 lg:px-8">
    <!-- Logo and Title -->
    <div class="text-center mb-8">
      <div class="mx-auto h-16 w-16 mb-4">
        <img src="{{ url_for('assets', filename='logo.png') }}" alt="CIP Academy" class="h-full w-full object-contain">
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Crea il tuo account</h1>
      <p class="text-gray-600">Unisciti a CIP Network e inizia il tuo percorso</p>
    </div>

    <!-- Registration Form Card -->
    <div class="card p-8 shadow-2xl border-0 bg-white/80 backdrop-blur-sm">
      <form method="POST" action="{{ url_for('auth.register') }}" class="space-y-6" id="registerForm" autocomplete="off" novalidate>
        <!-- Referral code -->
        <div class="space-y-2">
          <label for="referral_code" class="block text-sm font-semibold text-gray-700">
            Codice Referral (opzionale)
          </label>
          <div class="flex items-center space-x-2">
            <input
              type="text"
              id="referral_code"
              name="referral_code"
              class="flex-1 input-field bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Inserisci il codice referral"
            />
          </div>
          <div id="referral_info" class="mt-2 p-3 rounded-lg border hidden"></div>
          <p class="text-xs text-gray-500">Se lasci vuoto, verrai inserito automaticamente sotto il primo utente registrato.</p>
        </div>
        <!-- CSRF Token removed - not configured -->

        <!-- Name Fields -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label for="nome" class="block text-sm font-semibold text-gray-700">
              Nome *
            </label>
            <input
              type="text"
              name="nome"
              id="nome"
              required
              class="input-field bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Inserisci il tuo nome"
              value="{{ form_data.nome if form_data else '' }}"
            />
            <p id="error-nome" class="text-red-500 text-xs mt-1 hidden"></p>
          </div>

          <div class="space-y-2">
            <label for="cognome" class="block text-sm font-semibold text-gray-700">
              Cognome *
            </label>
            <input
              type="text"
              name="cognome"
              id="cognome"
              required
              class="input-field bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Inserisci il tuo cognome"
              value="{{ form_data.cognome if form_data else '' }}"
            />
            <p id="error-cognome" class="text-red-500 text-xs mt-1 hidden"></p>
          </div>
        </div>

        <!-- Telegram Username -->
        <div class="space-y-2">
          <label for="telegram" class="block text-sm font-semibold text-gray-700">
            Nome Telegram *
          </label>
          <div class="input-field-container">
            <div class="left-icon">
              <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
              </svg>
            </div>
            <input
              type="text"
              name="telegram"
              id="telegram"
              required
              class="input-field input-with-left-icon bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Inserisci il tuo nome telegram"
              value="{{ form_data.telegram if form_data else '' }}"
            />
          </div>
          <p class="text-xs text-gray-500 mt-1 flex items-center">
            <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Esempio: @mariorossi98
          </p>
          <p id="error-telegram" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <!-- Phone -->
        <div class="space-y-2">
          <label for="telefono" class="block text-sm font-semibold text-gray-700">
            Numero di telefono *
          </label>
          <div class="input-field-container">
            <div class="left-icon">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
            </div>
            <input
              type="tel"
              name="telefono"
              id="telefono"
              required
              class="input-field input-with-left-icon bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Es. +39 123 456 7890"
              value="{{ form_data.telefono if form_data else '' }}"
            />
          </div>
          <p id="error-telefono" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <!-- Email -->
        <div class="space-y-2">
          <label for="email" class="block text-sm font-semibold text-gray-700">
            Email *
          </label>
          <div class="input-field-container">
            <div class="left-icon">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m6.5-1.206a8.959 8.959 0 01-4.5 1.207" />
              </svg>
            </div>
            <input
              type="email"
              name="email"
              id="email"
              required
              class="input-field input-with-left-icon bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Inserisci la tua email"
              value="{{ form_data.email if form_data else '' }}"
            />
          </div>
          <p id="error-email" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <!-- Password -->
        <div class="space-y-2">
          <label for="password" class="block text-sm font-semibold text-gray-700">
            Password *
              </label>
        <div class="input-field-container">
    <div class="left-icon">
      <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
    </div>
    <input
      type="password"
      name="password"
      id="password"
      autocomplete="new-password"
      autocapitalize="off"
      spellcheck="false"
      inputmode="text"
      required
      class="input-field input-with-left-icon input-with-right-icon bg-gray-50 focus:bg-white transition-colors duration-200"
      placeholder="Password"
    />
    <button
      type="button"
      class="right-icon"
      onclick="togglePassword()"
      title="Mostra/Nascondi password"
      style="display: none;"
    >
      <i id="eye-icon" class="fas fa-eye h-5 w-5 text-gray-400 hover:text-gray-600 transition-colors duration-200"></i>
    </button>
  </div>
  <p id="error-password" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <!-- Confirm Password -->
        <div class="space-y-2">
          <label for="confirm_password" class="block text-sm font-semibold text-gray-700">
            Conferma Password *
          </label>
          <div class="input-field-container">
            <input
              type="password"
              name="confirm_password"
              id="confirm_password"
              autocomplete="new-password"
              autocapitalize="off"
              spellcheck="false"
              inputmode="text"
              required
              class="input-field input-with-right-icon bg-gray-50 focus:bg-white transition-colors duration-200"
              placeholder="Conferma la tua password"
            />
            <button
              type="button"
              class="right-icon"
              onclick="toggleConfirmPassword()"
              title="Mostra/Nascondi password"
              style="display: none;"
            >
              <i id="confirm-eye-icon" class="fas fa-eye h-5 w-5 text-gray-400 hover:text-gray-600 transition-colors duration-200"></i>
            </button>
          </div>
          <p id="error-confirm_password" class="text-red-500 text-xs mt-1 hidden"></p>
        </div>

        <!-- Terms and Conditions -->
        <div class="flex items-start space-x-3">
          <div class="flex items-center h-5">
            <input
              id="terms"
              name="terms"
              type="checkbox"
              required
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            />
          </div>
          <div class="text-sm">
            <label for="terms" class="text-gray-700">
              Accetto i 
              <a href="{{ url_for('auth.terms') }}" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium cursor-pointer">
                Termini e Condizioni
              </a>
              e la 
              <a href="{{ url_for('auth.privacy') }}" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium cursor-pointer">
                Privacy Policy
              </a>
            </label>
          </div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit" id="registerSubmit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200"
        >
          Crea Account
        </button>
        <p id="registerError" class="mt-2 text-sm text-red-600 hidden"></p>
      </form>

      <!-- Footer Links -->
      <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="text-center space-y-3">
          <p class="text-gray-600">
            Hai già un account? 
            <a href="{{ url_for('auth.login') }}" class="text-blue-600 hover:text-blue-700 font-semibold transition-colors duration-200">
              Accedi qui
            </a>
          </p>
        </div>
      </div>
    </div>

    <!-- Additional Info -->
    <div class="mt-6 text-center">
      <p class="text-xs text-gray-500">
        I tuoi dati sono protetti e utilizzati solo per l'accesso alla piattaforma
      </p>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="fixed top-4 right-4 z-50">
          <div class="rounded-md p-4 {% if category == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-green-50 border border-green-200 text-green-800{% endif %} shadow-lg">
            <p class="text-sm font-medium">{{ message }}</p>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<script>
// Mostra le icone toggle solo quando FontAwesome è caricato
document.addEventListener('DOMContentLoaded', function() {
  const eyeButtons = document.querySelectorAll('.right-icon');
  
  eyeButtons.forEach(eyeButton => {
    if (eyeButton) {
      // Verifica se FontAwesome è caricato
      const testIcon = document.createElement('i');
      testIcon.className = 'fas fa-eye';
      testIcon.style.display = 'none';
      document.body.appendChild(testIcon);
      
      // Controlla se l'icona è renderizzata correttamente
      const computedStyle = window.getComputedStyle(testIcon, ':before');
      if (computedStyle.content !== 'none') {
        eyeButton.style.display = 'block';
      } else {
        // Fallback: mostra dopo 1 secondo
        setTimeout(() => {
          eyeButton.style.display = 'block';
        }, 1000);
      }
      
      document.body.removeChild(testIcon);
    }
  });
});

function togglePassword() {
  const passwordInput = document.getElementById('password');
  const eyeIcon = document.getElementById('eye-icon');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    eyeIcon.classList.remove('fa-eye');
    eyeIcon.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    eyeIcon.classList.remove('fa-eye-slash');
    eyeIcon.classList.add('fa-eye');
  }
}

function toggleConfirmPassword() {
  const confirmPasswordInput = document.getElementById('confirm_password');
  const confirmEyeIcon = document.getElementById('confirm-eye-icon');
  
  if (confirmPasswordInput.type === 'password') {
    confirmPasswordInput.type = 'text';
    confirmEyeIcon.classList.remove('fa-eye');
    confirmEyeIcon.classList.add('fa-eye-slash');
  } else {
    confirmPasswordInput.type = 'password';
    confirmEyeIcon.classList.remove('fa-eye-slash');
    confirmEyeIcon.classList.add('fa-eye');
  }
}

// Form validation
document.getElementById('registerForm').addEventListener('submit', function(e) {
  let hasErrors = false;
  const submitBtn = document.getElementById('registerSubmit');
  const globalErr = document.getElementById('registerError');
  if (globalErr){ globalErr.classList.add('hidden'); globalErr.textContent=''; }
  
  // Reset all error messages
  document.querySelectorAll('[id^="error-"]').forEach(el => {
    el.classList.add('hidden');
  });
  
  // Validate required fields
  const requiredFields = ['nome', 'cognome', 'telegram', 'telefono', 'email', 'password', 'confirm_password'];
  requiredFields.forEach(field => {
    const input = document.getElementById(field);
    const errorEl = document.getElementById(`error-${field}`);
    
    if (!input.value.trim()) {
      errorEl.textContent = 'Questo campo è obbligatorio';
      errorEl.classList.remove('hidden');
      hasErrors = true;
    }
  });
  
  // Validate password match
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirm_password').value;
  if (password !== confirmPassword) {
    document.getElementById('error-confirm_password').textContent = 'Le password non coincidono';
    document.getElementById('error-confirm_password').classList.remove('hidden');
    hasErrors = true;
  }
  
  // Validate email format
  const email = document.getElementById('email').value;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (email && !emailRegex.test(email)) {
    document.getElementById('error-email').textContent = 'Formato email non valido';
    document.getElementById('error-email').classList.remove('hidden');
    hasErrors = true;
  }
  
  if (hasErrors) {
    e.preventDefault();
    return;
  }
  if (submitBtn){
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-80');
    submitBtn.innerHTML = '<span class="inline-flex items-center gap-2"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg> Creazione...</span>';
  }
});

// Auto-hide flash messages after 5 seconds
setTimeout(function() {
  const flashMessages = document.querySelectorAll('.fixed.top-4.right-4');
  flashMessages.forEach(function(message) {
    message.style.opacity = '0';
    setTimeout(function() {
      message.remove();
    }, 300);
  });
}, 5000);
</script>

<script>
// Verifica referral via API automaticamente con debounce
const referralInput = document.getElementById('referral_code');
const referralInfo = document.getElementById('referral_info');
let referralDebounce;

async function validateReferral(code) {
  // Rimuovi tutte le classi di colore e styling
  referralInfo.classList.remove('text-red-600', 'text-green-600', 'text-blue-600', 
                               'bg-red-50', 'bg-green-50', 'bg-blue-50', 
                               'border-red-200', 'border-green-200', 'border-blue-200');
  
  if (!code) {
    referralInfo.innerHTML = `
      <div class="flex items-center">
        <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="font-medium text-blue-800">Nessun codice inserito</span>
      </div>
      <div class="mt-1 text-sm text-blue-700">
        Verrai assegnato a: <span class="font-semibold">Marco Trapella</span>
      </div>
    `;
    referralInfo.classList.add('bg-blue-50', 'border-blue-200');
    referralInfo.classList.remove('hidden');
    return;
  }
  try {
    const res = await fetch(`/auth/referral/validate?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    if (res.ok && data.valid) {
      referralInfo.innerHTML = `
        <div class="flex items-center">
          <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span class="font-medium text-green-800">Codice valido!</span>
        </div>
        <div class="mt-1 text-sm text-green-700">
          Sarai invitato da: <span class="font-semibold">${data.user.nome} ${data.user.cognome}</span>
        </div>
      `;
      referralInfo.classList.add('bg-green-50', 'border-green-200');
      referralInfo.classList.remove('hidden');
    } else {
      referralInfo.innerHTML = `
        <div class="flex items-center">
          <svg class="w-4 h-4 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          <span class="font-medium text-red-800">Codice referral non valido</span>
        </div>
        <div class="mt-1 text-sm text-red-700">Verifica che il codice sia corretto</div>
      `;
      referralInfo.classList.add('bg-red-50', 'border-red-200');
      referralInfo.classList.remove('hidden');
    }
  } catch (e) {
    referralInfo.innerHTML = `
      <div class="flex items-center">
        <svg class="w-4 h-4 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="font-medium text-red-800">Errore di connessione</span>
      </div>
      <div class="mt-1 text-sm text-red-700">Riprova tra qualche secondo</div>
    `;
    referralInfo.classList.add('bg-red-50', 'border-red-200');
    referralInfo.classList.remove('hidden');
  }
}

function scheduleReferralValidation() {
  clearTimeout(referralDebounce);
  referralDebounce = setTimeout(() => validateReferral(referralInput.value.trim()), 400);
}

referralInput.addEventListener('input', scheduleReferralValidation);
referralInput.addEventListener('blur', () => validateReferral(referralInput.value.trim()));

// Se il campo è precompilato (URL con codice o dati del form), valida subito
if (referralInput.value.trim()) {
  validateReferral(referralInput.value.trim());
}

// Gestisci anche il caso in cui l'utente arriva con un parametro URL
// ma il campo non è ancora stato precompilato dal server
const urlParams = new URLSearchParams(window.location.search);
const refFromUrl = urlParams.get('ref');
if (refFromUrl && !referralInput.value.trim()) {
  referralInput.value = refFromUrl;
  validateReferral(refFromUrl);
}
</script>

<style>
@keyframes blob {
  0% { transform: translate(0px, 0px) scale(1); }
  33% { transform: translate(30px, -50px) scale(1.1); }
  66% { transform: translate(-20px, 20px) scale(0.9); }
  100% { transform: translate(0px, 0px) scale(1); }
}

.animate-blob {
  animation: blob 7s infinite;
}

.animation-delay-2000 {
  animation-delay: 2s;
}

.animation-delay-4000 {
  animation-delay: 4s;
}
</style>


{% endblock %}
