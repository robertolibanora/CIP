{% extends "layouts/user_base.html" %}

{% block title %}Profilo - CIP Immobiliare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('assets', filename='css/profile-fix.css') }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white pb-24">
    <!-- Header -->
    <div class="px-6 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Il Mio Profilo</h1>
        <p class="text-gray-600">Gestisci le informazioni del tuo account e verifica identità</p>
    </div>

    {% if user.kyc_status != 'verified' %}
    <!-- KYC: link pagina dedicata (solo per utenti non verificati) -->
    <div class="px-6 pb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-6 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Verifica Identità (KYC)</h2>
                <p class="text-gray-600 mt-1">Gestisci la verifica nella pagina dedicata.</p>
            </div>
            <a href="{{ url_for('user.kyc_page') }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors">Verifica identità</a>
        </div>
    </div>
    {% else %}
    <!-- Utente già verificato: nessuna sezione KYC -->
    {% endif %}

    <!-- Informazioni profilo -->
    <div class="px-6 pb-8">
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni Personali</h2>
            
            <form id="profile-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Email
                        </label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               value="{{ user.email or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                               readonly>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" value="{{ user.nome or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label>
                        <input type="text" value="{{ user.cognome or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Telegram</label>
                        <input type="text" value="{{ user.nome_telegram or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
                        <input type="text" value="{{ user.telefono or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                

                <div>
                    <label for="referral_code" class="block text-sm font-medium text-gray-700 mb-2">
                        Codice Referral
                    </label>
                    <div class="flex">
                        <input type="text" 
                               id="referral_code" 
                               value="{{ user.referral_code or '' }}"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50"
                               readonly>
                        <button type="button" onclick="copyReferralCode()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors">
                            Copia
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Condividi questo codice con amici per ricevere bonus</p>
                </div>
                
                <p class="text-sm text-gray-500 mt-4">Per cambiare i propri dati è necessario contattare un amministratore, per farlo basta unirsi al gruppo telegram.</p>
            </form>
        </div>
        
        <!-- Cambio password -->
        <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Cambio Password</h2>
            <p class="text-gray-600 mb-4">Clicca qui per cambiare la tua password</p>
            <a href="{{ url_for('user.change_password') }}" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
                Cambia Password
            </a>
        </div>
        
        <!-- Informazioni account -->
        <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni Account</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <p class="text-sm text-gray-500">Data Registrazione</p>
                    <p class="font-semibold text-gray-900">
                        {{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'N/A' }}
                    </p>
                </div>
                
            </div>
            
            <!-- Separatore -->
        </div>
    </div>
</div>

<script>
// Referral copy using modern Clipboard API with fallback
function copyReferralCode() {
  const input = document.getElementById('referral_code');
  const text = input ? input.value : '';
  if (!text) return;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      showTempToast('Codice copiato!');
    }).catch(() => legacyCopy(input));
  } else {
    legacyCopy(input);
  }
}

function legacyCopy(input) {
  input.select();
  document.execCommand('copy');
  showTempToast('Codice copiato!');
}

function showTempToast(message) {
  const n = document.createElement('div');
  n.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow z-50';
  n.textContent = message;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 2000);
}

// Mostra le icone toggle solo quando FontAwesome è caricato
document.addEventListener('DOMContentLoaded', function() {
  const eyeButtons = document.querySelectorAll('button[onclick*="togglePasswordVisibility"]');
  
  eyeButtons.forEach(eyeButton => {
    if (eyeButton) {
      // Verifica se FontAwesome è caricato
      const testIcon = document.createElement('i');
      testIcon.className = 'fas fa-eye';
      testIcon.style.display = 'none';
      document.body.appendChild(testIcon);
      
      // Controlla se l'icona è renderizzata correttamente
      const computedStyle = window.getComputedStyle(testIcon, ':before');
      if (computedStyle.content !== 'none') {
        eyeButton.style.display = 'block';
      } else {
        // Fallback: mostra dopo 1 secondo
        setTimeout(() => {
          eyeButton.style.display = 'block';
        }, 1000);
      }
      
      document.body.removeChild(testIcon);
    }
  });
});

// Toggle visibility for password fields
function togglePasswordVisibility(inputId, eyeId) {
    const input = document.getElementById(inputId);
    const eye = document.getElementById(eyeId);
    if (!input || !eye) return;
    if (input.type === 'password') {
        input.type = 'text';
        eye.classList.remove('fa-eye');
        eye.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        eye.classList.remove('fa-eye-slash');
        eye.classList.add('fa-eye');
    }
}

// Gestione form profilo
document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        full_name: formData.get('full_name'),
        email: formData.get('email')
    };
    
    try {
        const response = await fetch('{{ url_for("user.profile_update") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Profilo aggiornato con successo!');
            location.reload();
        } else {
            alert('Errore: ' + result.error);
        }
    } catch (error) {
        alert('Errore durante l\'aggiornamento del profilo');
    }
});

// Il cambio password è ora gestito nella pagina dedicata

// KYC è gestito nella pagina dedicata /user/kyc
// Nessuna inizializzazione KYC necessaria qui
</script>
{% endblock %}