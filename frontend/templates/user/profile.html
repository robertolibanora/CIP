{% extends "layouts/base.html" %}

{% block title %}Profilo - CIP Immobiliare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('assets', filename='css/profile-fix.css') }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <!-- Header -->
    <div class="px-6 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Il Mio Profilo</h1>
        <p class="text-gray-600">Gestisci le informazioni del tuo account e verifica identità</p>
    </div>

    <!-- Status KYC -->
    <div class="px-6 pb-6">
        <div id="kyc-status-card" class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Stato Verifica Identità (KYC)</h2>
                <div id="kyc-status-badge" class="px-3 py-1 rounded-full text-sm font-medium">
                    <!-- Status badge verrà popolato via JavaScript -->
                </div>
            </div>
            
            <div id="kyc-status-content">
                <!-- Contenuto status KYC verrà popolato via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Upload Documenti KYC -->
    <div class="px-6 pb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Carica Documenti Identità</h2>
            
            <form id="kyc-upload-form" class="space-y-6">
                <div>
                    <label for="document_category" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo Documento
                    </label>
                    <select id="document_category" 
                            name="category" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required>
                        <option value="">Seleziona tipo documento</option>
                        <option value="id_card">Carta d'Identità</option>
                        <option value="drivers_license">Patente di Guida</option>
                        <option value="passport">Passaporto</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        File Documento
                    </label>
                    
                    <!-- Fronte del documento -->
                    <div class="mb-4">
                        <label for="document_file_front" class="block text-xs font-medium text-gray-600 mb-2">
                            📄 Fronte del documento *
                        </label>
                        <div id="drop-zone-front" class="flex justify-center px-4 pt-4 pb-4 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors">
                            <div id="drop-zone-content-front" class="space-y-1 text-center">
                                <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="text-sm text-gray-600">
                                    <label for="document_file_front" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                        <span>Carica fronte</span>
                                        <input id="document_file_front" 
                                               name="file_front" 
                                               type="file" 
                                               class="sr-only" 
                                               accept=".pdf,.png,.jpg,.jpeg,.gif"
                                               capture="environment"
                                               required>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500">PDF, PNG, JPG fino a 16MB</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Retro del documento -->
                    <div class="mb-4">
                        <label for="document_file_back" class="block text-xs font-medium text-gray-600 mb-2">
                            📄 Retro del documento (opzionale)
                        </label>
                        <div id="drop-zone-back" class="flex justify-center px-4 pt-4 pb-4 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors">
                            <div id="drop-zone-content-back" class="space-y-1 text-center">
                                <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="text-sm text-gray-600">
                                    <label for="document_file_back" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                        <span>Carica retro</span>
                                        <input id="document_file_back" 
                                               name="file_back" 
                                               type="file" 
                                               class="sr-only" 
                                               accept=".pdf,.png,.jpg,.jpeg,.gif"
                                               capture="environment">
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500">PDF, PNG, JPG fino a 16MB</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview Area -->
                    <div id="file-preview" class="mt-4 hidden">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 mb-3">Anteprima documenti:</h4>
                            <div id="preview-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Preview content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button type="submit" 
                            id="upload-btn"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Carica Documento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Documenti Caricati -->
    <div class="px-6 pb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Documenti Caricati</h2>
            
            <div id="kyc-documents-list" class="space-y-4">
                <!-- Lista documenti verrà popolata via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Informazioni profilo -->
    <div class="px-6 pb-8">
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni Personali</h2>
            
            <form id="profile-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="full_name" class="block text-sm font-medium text-gray-700 mb-2">
                            Nome Completo
                        </label>
                        <input type="text" 
                               id="full_name" 
                               name="full_name" 
                               value="{{ user.full_name or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               required>
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Email
                        </label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               value="{{ user.email or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               required>
                    </div>
                </div>
                
                <div>
                    <label for="referral_code" class="block text-sm font-medium text-gray-700 mb-2">
                        Codice Referral
                    </label>
                    <div class="flex">
                        <input type="text" 
                               id="referral_code" 
                               value="{{ user.referral_code or '' }}"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50"
                               readonly>
                        <button type="button" onclick="copyReferralCode()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors">
                            Copia
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Condividi questo codice con amici per ricevere bonus</p>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                        Aggiorna Profilo
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Cambio password -->
        <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Cambio Password</h2>
            
            <form id="password-form" class="space-y-6">
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-700 mb-2">
                        Password Attuale
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="current_password" 
                               name="current_password"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                               required>
                        <button type="button" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                onclick="togglePasswordVisibility('current_password','eye_current')">
                            <svg id="eye_current" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268-2.943 9.542-7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                        Nuova Password
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="new_password" 
                               name="new_password"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                               required>
                        <button type="button" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                onclick="togglePasswordVisibility('new_password','eye_new')">
                            <svg id="eye_new" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268-2.943 9.542-7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button type="submit" 
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                        Salva Nuova Password
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Informazioni account -->
        <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni Account</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <p class="text-sm text-gray-500">Data Registrazione</p>
                    <p class="font-semibold text-gray-900">
                        {{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'N/A' }}
                    </p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">ID Utente</p>
                    <p class="font-semibold text-gray-900">{{ user.id or 'N/A' }}</p>
                </div>
            </div>
            
            <!-- Separatore -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Azioni Account</h3>
                
                <!-- Pulsante Logout -->
                <div class="flex justify-center">
                    <a href="{{ url_for('auth.logout') }}" 
                       class="inline-flex items-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-xl transition-all duration-300 shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Esci dall'Account
                    </a>
                </div>
                
                <p class="text-xs text-gray-500 text-center mt-3">
                    Clicca per terminare la sessione e tornare alla pagina di login
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Referral copy using modern Clipboard API with fallback
function copyReferralCode() {
  const input = document.getElementById('referral_code');
  const text = input ? input.value : '';
  if (!text) return;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      showTempToast('Codice copiato!');
    }).catch(() => legacyCopy(input));
  } else {
    legacyCopy(input);
  }
}

function legacyCopy(input) {
  input.select();
  document.execCommand('copy');
  showTempToast('Codice copiato!');
}

function showTempToast(message) {
  const n = document.createElement('div');
  n.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow z-50';
  n.textContent = message;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 2000);
}
// Toggle visibility for password fields
function togglePasswordVisibility(inputId, eyeId) {
    const input = document.getElementById(inputId);
    const eye = document.getElementById(eyeId);
    if (!input || !eye) return;
    if (input.type === 'password') {
        input.type = 'text';
        eye.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />';
    } else {
        input.type = 'password';
        eye.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268-2.943 9.542-7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
    }
}

// Gestione sistema KYC
class KYCManager {
    constructor() {
        this.selectedFiles = {
            front: null,
            back: null
        };
        this.processedFiles = new Set(); // Set per tracciare i file già processati
        
        this.init();
    }
    
    async init() {
        await this.loadKYCCategories();
        await this.loadKYCStatus();
        await this.loadKYCDocuments();
        this.setupEventListeners();
    }
    
    async loadKYCCategories() {
        try {
            const response = await fetch('/kyc/api/categories');
            const data = await response.json();
            
            const select = document.getElementById('document_category');
            select.innerHTML = '<option value="">Seleziona tipo documento</option>';
            
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.slug;
                option.textContent = category.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Errore caricamento categorie:', error);
        }
    }
    
    async loadKYCStatus() {
        try {
            const response = await fetch('/kyc/api/status');
            const data = await response.json();
            
            this.updateKYCStatusUI(data);
        } catch (error) {
            console.error('Errore caricamento status KYC:', error);
        }
    }
    
    async loadKYCDocuments() {
        try {
            const response = await fetch('/kyc/api/documents');
            const data = await response.json();
            
            this.updateDocumentsList(data.documents);
        } catch (error) {
            console.error('Errore caricamento documenti:', error);
        }
    }
    
    updateKYCStatusUI(statusData) {
        const badge = document.getElementById('kyc-status-badge');
        const content = document.getElementById('kyc-status-content');
        
        // Aggiorna badge
        let badgeClass = '';
        let badgeText = '';
        
        switch(statusData.kyc_status) {
            case 'unverified':
                badgeClass = 'bg-red-100 text-red-800';
                badgeText = 'Non Verificato';
                break;
            case 'pending':
                badgeClass = 'bg-yellow-100 text-yellow-800';
                badgeText = 'In Attesa';
                break;
            case 'verified':
                badgeClass = 'bg-green-100 text-green-800';
                badgeText = 'Verificato';
                break;
            case 'rejected':
                badgeClass = 'bg-red-100 text-red-800';
                badgeText = 'Rifiutato';
                break;
        }
        
        badge.className = `px-3 py-1 rounded-full text-sm font-medium ${badgeClass}`;
        badge.textContent = badgeText;
        
        // Aggiorna contenuto
        let contentHTML = '';
        
        if (statusData.kyc_status === 'unverified') {
            contentHTML = `
                <div class="text-sm text-gray-600">
                    <p>Per iniziare a investire devi verificare la tua identità caricando un documento.</p>
                    <p class="mt-2">Carica un documento d'identità valido (carta d'identità, passaporto o patente).</p>
                </div>
            `;
        } else if (statusData.kyc_status === 'pending') {
            contentHTML = `
                <div class="text-sm text-gray-600">
                    <p>I tuoi documenti sono stati ricevuti e sono in attesa di verifica da parte del nostro team.</p>
                    <p class="mt-2">Riceverai una notifica una volta completata la verifica.</p>
                </div>
            `;
        } else if (statusData.kyc_status === 'verified') {
            contentHTML = `
                <div class="text-sm text-green-600">
                    <p>✅ La tua identità è stata verificata con successo!</p>
                    <p class="mt-2">Ora puoi accedere a tutte le funzionalità di investimento.</p>
                </div>
            `;
        } else if (statusData.kyc_status === 'rejected') {
            contentHTML = `
                <div class="text-sm text-red-600">
                    <p>❌ La verifica della tua identità è stata rifiutata.</p>
                    <p class="mt-2">Carica un nuovo documento valido per riprovare.</p>
                </div>
            `;
        }
        
        content.innerHTML = contentHTML;
        
        // Nascondi form upload se già verificato
        const uploadForm = document.getElementById('kyc-upload-form').parentElement;
        if (statusData.kyc_status === 'verified') {
            uploadForm.style.display = 'none';
        } else {
            uploadForm.style.display = 'block';
        }
    }
    
    updateDocumentsList(documents) {
        const container = document.getElementById('kyc-documents-list');
        
        if (!documents || documents.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-900 mb-1">Nessun documento caricato</p>
                    <p class="text-xs text-gray-500">I tuoi documenti appariranno qui dopo il caricamento</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        documents.forEach(doc => {
            const statusClass = doc.verified_by_admin ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            const statusIcon = doc.verified_by_admin ? '✅' : '⏳';
            const statusText = doc.verified_by_admin ? 'Verificato' : 'In Attesa';
            const deleteBtn = doc.verified_by_admin ? '' : `
                <button onclick="kycManager.deleteDocument(${doc.id})" 
                        class="text-red-600 hover:text-red-800 text-sm font-medium ml-3">
                    Elimina
                </button>
            `;
            
            // Determine file type and create appropriate preview
            const isImage = doc.mime_type && doc.mime_type.startsWith('image/');
            const isPDF = doc.mime_type === 'application/pdf';
            const fileSize = doc.size_bytes ? (doc.size_bytes / (1024 * 1024)).toFixed(2) : '0.0';
            
            let previewElement = '';
            if (isImage) {
                previewElement = `
                    <div class="w-12 h-12 rounded-lg border border-gray-200 overflow-hidden bg-gray-50">
                        <img src="/uploads/${doc.file_path}" alt="${doc.title}" 
                             class="w-full h-full object-cover cursor-pointer hover:opacity-80 transition-opacity" 
                             onclick="window.open('/uploads/${doc.file_path}', '_blank')">
                    </div>
                `;
            } else if (isPDF) {
                previewElement = `
                    <div class="w-12 h-12 bg-red-100 rounded-lg border border-gray-200 flex items-center justify-center cursor-pointer hover:bg-red-200 transition-colors"
                         onclick="window.open('/uploads/${doc.file_path}', '_blank')">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                    </div>
                `;
            } else {
                previewElement = `
                    <div class="w-12 h-12 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                `;
            }
            
            html += `
                <div class="bg-white border border-gray-200 rounded-xl p-4 hover:border-gray-300 transition-colors">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            ${previewElement}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-medium text-gray-900 truncate">${doc.title}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ${doc.category_name} • ${fileSize} MB
                                    </p>
                                    <p class="text-xs text-gray-400">
                                        Caricato: ${new Date(doc.uploaded_at).toLocaleDateString('it-IT', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </p>
                                    ${doc.admin_notes ? `
                                        <p class="text-xs text-blue-600 mt-1 bg-blue-50 px-2 py-1 rounded">
                                            💬 ${doc.admin_notes}
                                        </p>
                                    ` : ''}
                                </div>
                                <div class="flex flex-col items-end space-y-2 ml-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusIcon} ${statusText}
                                    </span>
                                    <div class="flex items-center space-x-2">
                                        <a href="/uploads/${doc.file_path}" target="_blank" 
                                           class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                            Visualizza
                                        </a>
                                        ${deleteBtn}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    async uploadDocument(formData) {
        const uploadBtn = document.getElementById('upload-btn');
        const originalText = uploadBtn.textContent;
        
        try {
            // Show upload progress
            this.showUploadProgress(0);
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = `
                <div class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Caricamento in corso...
                </div>
            `;
            
            // Simulate upload progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                this.updateUploadProgress(progress);
            }, 200);
            
            const response = await fetch('/kyc/api/upload', {
                method: 'POST',
                body: formData
            });
            
            clearInterval(progressInterval);
            this.updateUploadProgress(100);
            
            const result = await response.json();
            
            if (result.success) {
                this.showAlert('success', '✅ Documento caricato con successo! Il documento è stato inviato per la verifica.');
                
                // Update preview to show uploaded status
                this.updatePreviewAfterUpload(result);
                
                // Clear form and reload data
                document.getElementById('kyc-upload-form').reset();
                this.clearFileSelection();
                
                // Pulisci il set dei file processati dopo upload riuscito
                if (this.processedFiles) {
                    this.processedFiles.clear();
                }
                
                // Reload KYC data
                await this.loadKYCStatus();
                await this.loadKYCDocuments();
                
            } else {
                this.showAlert('error', 'Errore durante il caricamento: ' + result.error);
            }
        } catch (error) {
            this.showAlert('error', 'Errore di connessione durante il caricamento del documento');
            console.error('Errore upload:', error);
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
            this.hideUploadProgress();
        }
    }
    
    showUploadProgress(progress) {
        const previewContainer = document.getElementById('file-preview');
        if (previewContainer && !previewContainer.classList.contains('hidden')) {
            const previewContent = document.getElementById('preview-content');
            
            // Add progress bar to preview
            let progressBar = previewContent.querySelector('.upload-progress');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.className = 'upload-progress mt-3';
                previewContent.appendChild(progressBar);
            }
            
            progressBar.innerHTML = `
                <div class="bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Caricamento in corso... ${Math.round(progress)}%</p>
            `;
        }
    }
    
    updateUploadProgress(progress) {
        const progressBar = document.querySelector('.upload-progress');
        if (progressBar) {
            const bar = progressBar.querySelector('.bg-blue-600');
            const text = progressBar.querySelector('p');
            
            if (bar) bar.style.width = `${progress}%`;
            if (text) text.textContent = `Caricamento in corso... ${Math.round(progress)}%`;
            
            if (progress >= 100) {
                if (text) text.textContent = 'Caricamento completato! 🎉';
                setTimeout(() => this.hideUploadProgress(), 1000);
            }
        }
    }
    
    hideUploadProgress() {
        const progressBar = document.querySelector('.upload-progress');
        if (progressBar) {
            progressBar.remove();
        }
    }
    
    updatePreviewAfterUpload(uploadResult) {
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            const statusSpan = previewContent.querySelector('span');
            if (statusSpan) {
                statusSpan.innerHTML = `
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ✅ Caricato
                    </span>
                `;
            }
        }
    }
    
    async deleteDocument(docId) {
        if (!confirm('Sei sicuro di voler eliminare questo documento?')) {
            return;
        }
        
        try {
            const response = await fetch(`/kyc/api/documents/${docId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showAlert('success', 'Documento eliminato con successo!');
                await this.loadKYCStatus();
                await this.loadKYCDocuments();
            } else {
                this.showAlert('error', 'Errore: ' + result.error);
            }
        } catch (error) {
            this.showAlert('error', 'Errore durante l\'eliminazione del documento');
            console.error('Errore eliminazione:', error);
        }
    }
    
    handleFileSelection(file, fileType = 'front') {
        if (!file) {
            this.clearFilePreview(fileType);
            return;
        }
        
        // Verifica se è lo stesso file già selezionato per evitare doppio processing
        const currentFile = this.selectedFiles[fileType];
        if (currentFile && currentFile.name === file.name && currentFile.size === file.size) {
            return; // Stesso file, non fare nulla
        }
        
        // Validate file
        const maxSize = 16 * 1024 * 1024; // 16MB
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
        
        if (file.size > maxSize) {
            this.showAlert('error', 'File troppo grande. Massimo 16MB');
            this.clearFileSelection(fileType);
            return;
        }
        
        if (!allowedTypes.includes(file.type)) {
            this.showAlert('error', 'Tipo file non supportato. Usa PDF o immagini (JPG, PNG, GIF)');
            this.clearFileSelection(fileType);
            return;
        }
        
        // Pulisci il file precedente dal set se esisteva
        if (currentFile && this.processedFiles) {
            const oldFileKey = `${currentFile.name}-${currentFile.size}-${fileType}`;
            this.processedFiles.delete(oldFileKey);
        }
        
        // Salva il file selezionato
        this.selectedFiles[fileType] = file;
        
        this.showFilePreview(file, fileType);
        this.updateDropZone(file, fileType);
    }
    
    showFilePreview(file, fileType) {
        const previewContainer = document.getElementById('file-preview');
        const previewContent = document.getElementById('preview-content');
        
        // Rimuovi preview esistente per questo tipo di file PRIMA di fare qualsiasi altra cosa
        const existingPreview = previewContent.querySelector(`[data-file-type="${fileType}"]`);
        if (existingPreview) {
            existingPreview.remove();
        }
        
        // Verifica se questo file è già stato processato per evitare duplicati
        const fileKey = `${file.name}-${file.size}-${fileType}`;
        if (this.processedFiles && this.processedFiles.has(fileKey)) {
            return; // File già processato, evita duplicato
        }
        
        // Inizializza set dei file processati se non esiste
        if (!this.processedFiles) {
            this.processedFiles = new Set();
        }
        this.processedFiles.add(fileKey);
        
        previewContainer.classList.remove('hidden');
        
        const fileName = file.name;
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        const category = document.getElementById('document_category');
        const categoryText = category.options[category.selectedIndex]?.text || 'Non selezionato';
        
        const fileTypeLabel = fileType === 'front' ? '📄 Fronte' : '📄 Retro';
        
        const createPreview = (imageSrc = null) => {
            const previewElement = document.createElement('div');
            previewElement.className = 'bg-white border border-gray-200 rounded-lg p-4';
            previewElement.setAttribute('data-file-type', fileType);
            
            let thumbnailHtml;
            if (imageSrc) {
                // Image preview
                thumbnailHtml = `
                    <img src="${imageSrc}" alt="Preview ${fileType}" 
                         class="w-full h-32 object-cover rounded-lg border border-gray-200 mb-3">
                `;
            } else if (file.type === 'application/pdf') {
                // PDF preview
                thumbnailHtml = `
                    <div class="w-full h-32 bg-red-100 rounded-lg border border-gray-200 flex items-center justify-center mb-3">
                        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                    </div>
                `;
            } else {
                // Generic file preview
                thumbnailHtml = `
                    <div class="w-full h-32 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center mb-3">
                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                `;
            }
            
            previewElement.innerHTML = `
                ${thumbnailHtml}
                <div class="text-center">
                    <h5 class="text-sm font-medium text-gray-900 mb-1">${fileTypeLabel}</h5>
                    <p class="text-xs text-gray-600 truncate">${fileName}</p>
                    <p class="text-xs text-gray-500">${fileSize} MB</p>
                    <div class="mt-2 flex justify-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            ⏳ In Attesa
                        </span>
                    </div>
                    <button type="button" onclick="kycManager.clearFileSelection('${fileType}')" 
                            class="text-xs text-red-600 hover:text-red-800 mt-2">
                        Rimuovi
                    </button>
                </div>
            `;
            
            previewContent.appendChild(previewElement);
        };
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => createPreview(e.target.result);
            reader.readAsDataURL(file);
        } else {
            createPreview();
        }
    }
    
    updateDropZone(file, fileType) {
        const dropZoneContent = document.getElementById(`drop-zone-content-${fileType}`);
        const fileName = file.name;
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        const label = fileType === 'front' ? 'fronte' : 'retro';
        
        dropZoneContent.innerHTML = `
            <svg class="mx-auto h-10 w-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm text-gray-900">
                <p class="font-medium truncate">${fileName}</p>
                <p class="text-gray-500">${fileSize} MB</p>
            </div>
            <p class="text-xs text-green-600">File selezionato ✓</p>
            <button type="button" onclick="kycManager.clearFileSelection('${fileType}')" class="text-xs text-gray-500 hover:text-gray-700 mt-2">
                Cambia ${label}
            </button>
        `;
    }
    
    clearFileSelection(fileType = null) {
        if (fileType) {
            // Clear specific file type
            const inputId = `document_file_${fileType}`;
            document.getElementById(inputId).value = '';
            this.selectedFiles[fileType] = null;
            this.clearFilePreview(fileType);
            this.resetDropZone(fileType);
            
            // Pulisci anche dal set dei file processati
            if (this.processedFiles) {
                // Rimuovi tutti i file di questo tipo dal set
                const toRemove = Array.from(this.processedFiles).filter(key => key.endsWith(`-${fileType}`));
                toRemove.forEach(key => this.processedFiles.delete(key));
            }
        } else {
            // Clear all files
            document.getElementById('document_file_front').value = '';
            document.getElementById('document_file_back').value = '';
            this.selectedFiles = { front: null, back: null };
            this.clearFilePreview();
            this.resetDropZone('front');
            this.resetDropZone('back');
            
            // Pulisci tutto il set dei file processati
            if (this.processedFiles) {
                this.processedFiles.clear();
            }
        }
    }
    
    clearFilePreview(fileType = null) {
        const previewContainer = document.getElementById('file-preview');
        const previewContent = document.getElementById('preview-content');
        
        if (fileType) {
            // Remove specific file preview
            const existingPreview = previewContent.querySelector(`[data-file-type="${fileType}"]`);
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Hide container if no more previews
            if (previewContent.children.length === 0) {
                previewContainer.classList.add('hidden');
            }
        } else {
            // Clear all previews
            previewContent.innerHTML = '';
            previewContainer.classList.add('hidden');
        }
    }
    
    resetDropZone(fileType) {
        const dropZoneContent = document.getElementById(`drop-zone-content-${fileType}`);
        const label = fileType === 'front' ? 'fronte' : 'retro';
        const inputId = `document_file_${fileType}`;
        
        dropZoneContent.innerHTML = `
            <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="text-sm text-gray-600">
                <label for="${inputId}" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                    <span>Carica ${label}</span>
                </label>
            </div>
            <p class="text-xs text-gray-500">PDF, PNG, JPG fino a 16MB</p>
        `;
    }
    
    showAlert(type, message) {
        // Create alert container if it doesn't exist
        let alertContainer = document.getElementById('kyc-alerts');
        if (!alertContainer) {
            alertContainer = document.createElement('div');
            alertContainer.id = 'kyc-alerts';
            alertContainer.className = 'px-6 mb-4';
            document.querySelector('.min-h-screen').insertBefore(alertContainer, document.querySelector('.min-h-screen').firstElementChild.nextSibling);
        }
        
        const alertId = 'alert-' + Date.now();
        const alertColors = {
            success: 'bg-green-50 text-green-800 border-green-200',
            error: 'bg-red-50 text-red-800 border-red-200',
            warning: 'bg-yellow-50 text-yellow-800 border-yellow-200',
            info: 'bg-blue-50 text-blue-800 border-blue-200'
        };
        
        alertContainer.innerHTML = `
            <div id="${alertId}" class="border-l-4 p-4 ${alertColors[type]} rounded-r-lg">
                <div class="flex items-start">
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm opacity-70 hover:opacity-100">×</button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, 5000);
    }
    
    setupEventListeners() {
        // Form upload KYC
        document.getElementById('kyc-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const frontFile = document.getElementById('document_file_front').files[0];
            const backFile = document.getElementById('document_file_back').files[0];
            const category = document.getElementById('document_category').value;
            
            if (!frontFile || !category) {
                this.showAlert('warning', 'Seleziona almeno il fronte del documento e una categoria');
                return;
            }
            
            formData.append('file_front', frontFile);
            if (backFile) {
                formData.append('file_back', backFile);
            }
            formData.append('category', category);
            
            await this.uploadDocument(formData);
        });
        
        // File selection preview per fronte
        document.getElementById('document_file_front').addEventListener('change', (e) => {
            this.handleFileSelection(e.target.files[0], 'front');
        });
        
        // File selection preview per retro
        document.getElementById('document_file_back').addEventListener('change', (e) => {
            this.handleFileSelection(e.target.files[0], 'back');
        });
        
        // Drag and drop per fronte
        const dropZoneFront = document.getElementById('drop-zone-front');
        this.setupDropZone(dropZoneFront, 'document_file_front', 'front');
        
        // Drag and drop per retro  
        const dropZoneBack = document.getElementById('drop-zone-back');
        this.setupDropZone(dropZoneBack, 'document_file_back', 'back');
        
        // Ottimizzazioni per mobile
        if ('ontouchstart' in window) {
            // Aggiungi feedback visivo per touch sui drop zones
            [dropZoneFront, dropZoneBack].forEach(zone => {
                zone.addEventListener('touchstart', () => {
                    zone.classList.add('bg-blue-50', 'scale-105');
                });
                
                zone.addEventListener('touchend', () => {
                    zone.classList.remove('bg-blue-50', 'scale-105');
                });
            });
        }
    }
    
    setupDropZone(dropZone, inputId, fileType) {
        // Eventi drag and drop per desktop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-blue-400', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById(inputId);
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;
                // Trigger only one handler to avoid duplicate previews
                fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }
}

// KYC Manager
class KYCManager {
    constructor() {
        console.log('KYCManager constructor chiamato');
        this.init();
    }
    
    async init() {
        await this.loadKYCStatus();
        await this.loadCategories();
        this.bindEvents();
    }
    
    async loadKYCStatus() {
        try {
            const response = await fetch('/kyc/api/status');
            if (response.ok) {
                const data = await response.json();
                this.renderKYCStatus(data);
            }
        } catch (error) {
            console.error('Errore nel caricamento stato KYC:', error);
        }
    }
    
    renderKYCStatus(data) {
        const badge = document.getElementById('kyc-status-badge');
        const content = document.getElementById('kyc-status-content');
        const uploadSection = document.getElementById('kyc-upload-section');
        
        const statusConfig = {
            'unverified': {
                color: 'bg-gray-100 text-gray-800',
                icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z',
                text: 'Non Verificato',
                message: 'Completa la verifica KYC per accedere alle funzionalità di investimento.'
            },
            'pending': {
                color: 'bg-yellow-100 text-yellow-800',
                icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                text: 'In Verifica',
                message: 'I tuoi documenti sono stati ricevuti e sono in fase di verifica. Riceverai una notifica una volta completata la verifica.'
            },
            'verified': {
                color: 'bg-green-100 text-green-800',
                icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
                text: 'Verificato',
                message: 'La tua identità è stata verificata. Puoi ora accedere a tutte le funzionalità di investimento.'
            },
            'rejected': {
                color: 'bg-red-100 text-red-800',
                icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z',
                text: 'Rifiutato',
                message: 'La verifica è stata rifiutata. Puoi caricare nuovi documenti per riprovare.'
            }
        };
        
        const config = statusConfig[data.kyc_status] || statusConfig['unverified'];
        
        badge.className = `px-3 py-1 rounded-full text-sm font-medium ${config.color}`;
        badge.innerHTML = `
            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${config.icon}"/>
            </svg>
            ${config.text}
        `;
        
        content.innerHTML = `
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-gray-700">${config.message}</p>
            </div>
        `;
        
        // Show/hide upload section
        if (data.kyc_status === 'verified') {
            uploadSection.style.display = 'none';
        } else {
            uploadSection.style.display = 'block';
        }
    }
    
    async loadCategories() {
        try {
            console.log('Caricamento categorie dal server...');
            const response = await fetch('/kyc/api/categories');
            console.log('Risposta categorie:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Categorie ricevute:', data);
                this.renderCategories(data.categories);
            } else {
                console.warn('Errore nel caricamento categorie dal server, uso fallback');
                this.renderCategories([]); // Usa le opzioni di fallback nel HTML
            }
        } catch (error) {
            console.error('Errore nel caricamento categorie:', error);
            console.log('Uso categorie di fallback dal HTML');
            this.renderCategories([]); // Usa le opzioni di fallback nel HTML
        }
    }
    
    renderCategories(categories) {
        const select = document.getElementById('document_category');
        if (!select) {
            console.error('Select categoria non trovato');
            return;
        }
        
        // Se non ci sono categorie dal server, usa quelle di fallback
        if (!categories || categories.length === 0) {
            console.log('Nessuna categoria dal server, uso fallback');
            return; // Le opzioni sono già nel HTML
        }
        
        // Altrimenti, aggiorna con quelle dal server
        select.innerHTML = '<option value="">Seleziona tipo documento</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.slug;
            option.textContent = category.name;
            select.appendChild(option);
        });
    }
    
    bindEvents() {
        console.log('Binding events...');
        
        // File input change
        const frontInput = document.getElementById('document_file_front');
        if (frontInput) {
            frontInput.addEventListener('change', (e) => {
                console.log('File front cambiato');
                this.handleFileSelect(e, 'front');
            });
        } else {
            console.error('Input file_front non trovato');
        }
        
        const backInput = document.getElementById('document_file_back');
        if (backInput) {
            backInput.addEventListener('change', (e) => {
                console.log('File back cambiato');
                this.handleFileSelect(e, 'back');
            });
        } else {
            console.error('Input file_back non trovato');
        }
        
        // Form submit
        const form = document.getElementById('kyc-upload-form');
        if (form) {
            form.addEventListener('submit', (e) => {
                console.log('Form submit event');
                e.preventDefault();
                this.handleUpload();
            });
        } else {
            console.error('Form KYC non trovato');
        }
    }
    
    handleFileSelect(event, side) {
        const file = event.target.files[0];
        if (file) {
            this.showFilePreview(file, side);
        }
    }
    
    showFilePreview(file, side) {
        const preview = document.getElementById('file-preview');
        const content = document.getElementById('preview-content');
        
        const fileInfo = document.createElement('div');
        fileInfo.className = 'bg-white border border-gray-200 rounded-lg p-3';
        fileInfo.innerHTML = `
            <div class="flex items-center">
                <svg class="w-8 h-8 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <div>
                    <p class="text-sm font-medium text-gray-900">${file.name}</p>
                    <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            </div>
        `;
        
        content.appendChild(fileInfo);
        preview.classList.remove('hidden');
    }
    
    async handleUpload() {
        console.log('handleUpload chiamato');
        
        const form = document.getElementById('kyc-upload-form');
        if (!form) {
            console.error('Form KYC non trovato');
            alert('Errore: Form non trovato');
            return;
        }
        
        const formData = new FormData();
        
        // Aggiungi categoria
        const categorySelect = form.querySelector('select[name="category"]');
        if (!categorySelect) {
            console.error('Select categoria non trovato');
            alert('Errore: Campo categoria non trovato');
            return;
        }
        
        const category = categorySelect.value;
        console.log('Categoria selezionata:', category);
        
        if (!category) {
            alert('Seleziona un tipo di documento');
            return;
        }
        formData.append('category', category);
        
        // Aggiungi file fronte (obbligatorio)
        const frontFileInput = form.querySelector('input[name="file_front"]');
        if (!frontFileInput) {
            console.error('Input file_front non trovato');
            alert('Errore: Campo file fronte non trovato');
            return;
        }
        
        const frontFile = frontFileInput.files[0];
        console.log('File fronte:', frontFile);
        
        if (!frontFile) {
            alert('Seleziona almeno il fronte del documento');
            return;
        }
        formData.append('file', frontFile);
        
        // Aggiungi file retro (opzionale)
        const backFileInput = form.querySelector('input[name="file_back"]');
        if (backFileInput) {
            const backFile = backFileInput.files[0];
            if (backFile) {
                console.log('File retro:', backFile);
                formData.append('file_back', backFile);
            }
        }
        
        const submitBtn = form.querySelector('button[type="submit"]');
        if (!submitBtn) {
            console.error('Pulsante submit non trovato');
            alert('Errore: Pulsante non trovato');
            return;
        }
        
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Caricamento...';
        submitBtn.disabled = true;
        
        console.log('Invio richiesta al server...');
        
        try {
            const response = await fetch('/kyc/api/documents/upload', {
                method: 'POST',
                body: formData
            });
            
            console.log('Risposta ricevuta:', response.status);
            
            const result = await response.json();
            console.log('Risultato:', result);
            
            if (response.ok) {
                alert('Documento caricato con successo!');
                form.reset();
                const preview = document.getElementById('file-preview');
                const content = document.getElementById('preview-content');
                if (preview) preview.classList.add('hidden');
                if (content) content.innerHTML = '';
                await this.loadKYCStatus();
            } else {
                alert('Errore: ' + (result.error || 'Errore sconosciuto'));
            }
        } catch (error) {
            console.error('Errore upload:', error);
            alert('Errore durante il caricamento del documento: ' + error.message);
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
}

// Inizializza gestore KYC
let kycManager;

// Gestione form profilo
document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        full_name: formData.get('full_name'),
        email: formData.get('email')
    };
    
    try {
        const response = await fetch('{{ url_for("user.profile_update") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Profilo aggiornato con successo!');
            location.reload();
        } else {
            alert('Errore: ' + result.error);
        }
    } catch (error) {
        alert('Errore durante l\'aggiornamento del profilo');
    }
});

// Gestione form password
document.getElementById('password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        current_password: formData.get('current_password'),
        new_password: formData.get('new_password')
    };
    
    try {
        const response = await fetch('{{ url_for("user.change_password") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Password cambiata con successo!');
            this.reset();
        } else {
            alert('Errore: ' + result.error);
        }
    } catch (error) {
        alert('Errore durante il cambio password');
    }
});

// Copia codice referral
function copyReferralCode() {
    const referralCode = document.getElementById('referral_code').value;
    if (referralCode) {
        navigator.clipboard.writeText(referralCode).then(function() {
            alert('Codice referral copiato negli appunti!');
        });
    }
}

// Inizializza quando la pagina è caricata
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM caricato, inizializzo KYCManager...');
    try {
        kycManager = new KYCManager();
        console.log('KYCManager inizializzato con successo');
    } catch (error) {
        console.error('Errore inizializzazione KYCManager:', error);
    }
});
</script>
{% endblock %}
