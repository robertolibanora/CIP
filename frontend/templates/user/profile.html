{% extends "layouts/base.html" %}

{% block title %}Profilo - CIP Immobiliare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('assets', filename='css/profile-fix.css') }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white">
    <!-- Header -->
    <div class="px-6 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Il Mio Profilo</h1>
        <p class="text-gray-600">Gestisci le informazioni del tuo account e verifica identità</p>
    </div>

    {% if user.kyc_status != 'verified' %}
    <!-- KYC: link pagina dedicata (solo per utenti non verificati) -->
    <div class="px-6 pb-6">
        <div class="bg-white rounded-xl border border-gray-200 p-6 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Verifica Identità (KYC)</h2>
                <p class="text-gray-600 mt-1">Gestisci la verifica nella pagina dedicata.</p>
            </div>
            <a href="{{ url_for('user.kyc_page') }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors">Verifica identità</a>
        </div>
    </div>
    {% else %}
    <!-- Utente già verificato: nessuna sezione KYC -->
    {% endif %}

    <!-- Informazioni profilo -->
    <div class="px-6 pb-8">
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni Personali</h2>
            
            <form id="profile-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Email
                        </label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               value="{{ user.email or '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                               readonly>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" value="{{ user.nome or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label>
                        <input type="text" value="{{ user.cognome or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Telegram</label>
                        <input type="text" value="{{ user.nome_telegram or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
                        <input type="text" value="{{ user.telefono or '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                

                <div>
                    <label for="referral_code" class="block text-sm font-medium text-gray-700 mb-2">
                        Codice Referral
                    </label>
                    <div class="flex">
                        <input type="text" 
                               id="referral_code" 
                               value="{{ user.referral_code or '' }}"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50"
                               readonly>
                        <button type="button" onclick="copyReferralCode()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors">
                            Copia
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Condividi questo codice con amici per ricevere bonus</p>
                </div>
                
                <p class="text-sm text-gray-500 mt-4">Per cambiare i propri dati è necessario contattare un amministratore.</p>
            </form>
        </div>
        
        <!-- Cambio password -->
        <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Cambio Password</h2>
            
            <form id="password-form" class="space-y-6">
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-700 mb-2">
                        Password Attuale
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="current_password" 
                               name="current_password"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                               required>
                        <button type="button" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                onclick="togglePasswordVisibility('current_password','eye_current')">
                            <svg id="eye_current" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268 2.943-9.542 7z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                        Nuova Password
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="new_password" 
                               name="new_password"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                               required>
                        <button type="button" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                onclick="togglePasswordVisibility('new_password','eye_new')">
                            <svg id="eye_new" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268 2.943-9.542 7z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button type="submit" id="password-submit"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                        Salva Nuova Password
                    </button>
                    <p id="password-error" class="mt-2 text-sm text-red-600 hidden"></p>
                    <p id="password-success" class="mt-2 text-sm text-green-600 hidden"></p>
                </div>
            </form>
        </div>
        
        <!-- Informazioni account -->
        <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Informazioni Account</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <p class="text-sm text-gray-500">Data Registrazione</p>
                    <p class="font-semibold text-gray-900">
                        {{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'N/A' }}
                    </p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">ID Utente</p>
                    <p class="font-semibold text-gray-900">{{ user.id or 'N/A' }}</p>
                </div>
            </div>
            
            <!-- Separatore -->
            <div class="border-t border-gray-200 pt-6">
                
                <!-- Pulsante Logout -->
                <div class="flex justify-center">
                    <a href="{{ url_for('auth.logout') }}" 
                       class="inline-flex items-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-xl transition-all duration-300 shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Esci dall'Account
                    </a>
                </div>
                
                <p class="text-xs text-gray-500 text-center mt-3">
                    Clicca per terminare la sessione e tornare alla pagina di login
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Referral copy using modern Clipboard API with fallback
function copyReferralCode() {
  const input = document.getElementById('referral_code');
  const text = input ? input.value : '';
  if (!text) return;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      showTempToast('Codice copiato!');
    }).catch(() => legacyCopy(input));
  } else {
    legacyCopy(input);
  }
}

function legacyCopy(input) {
  input.select();
  document.execCommand('copy');
  showTempToast('Codice copiato!');
}

function showTempToast(message) {
  const n = document.createElement('div');
  n.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow z-50';
  n.textContent = message;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 2000);
}

// Toggle visibility for password fields
function togglePasswordVisibility(inputId, eyeId) {
    const input = document.getElementById(inputId);
    const eye = document.getElementById(eyeId);
    if (!input || !eye) return;
    if (input.type === 'password') {
        input.type = 'text';
        eye.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />';
    } else {
        input.type = 'password';
        eye.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268 2.943-9.542 7z" />';
    }
}

// Gestione form profilo
document.getElementById('profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        full_name: formData.get('full_name'),
        email: formData.get('email')
    };
    
    try {
        const response = await fetch('{{ url_for("user.profile_update") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Profilo aggiornato con successo!');
            location.reload();
        } else {
            alert('Errore: ' + result.error);
        }
    } catch (error) {
        alert('Errore durante l\'aggiornamento del profilo');
    }
});

// Gestione form password
document.getElementById('password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        current_password: formData.get('current_password'),
        new_password: formData.get('new_password')
    };
    
    try {
        const btn = document.getElementById('password-submit');
        const err = document.getElementById('password-error');
        const ok = document.getElementById('password-success');
        if (err) { err.classList.add('hidden'); err.textContent=''; }
        if (ok) { ok.classList.add('hidden'); ok.textContent=''; }
        if (btn){ btn.disabled = true; btn.classList.add('opacity-80'); btn.textContent='Salvataggio...'; }

        const response = await fetch('{{ url_for("user.change_password") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (ok){ ok.textContent = 'Password cambiata con successo!'; ok.classList.remove('hidden'); }
            this.reset();
        } else {
            if (err){ err.textContent = result.error || 'Errore sconosciuto'; err.classList.remove('hidden'); }
        }
    } catch (error) {
        if (err){ err.textContent = 'Errore durante il cambio password'; err.classList.remove('hidden'); }
    }
    const btn = document.getElementById('password-submit');
    if (btn){ btn.disabled = false; btn.classList.remove('opacity-80'); btn.textContent='Salva Nuova Password'; }
});

// KYC è gestito nella pagina dedicata /user/kyc
// Nessuna inizializzazione KYC necessaria qui
</script>
{% endblock %}