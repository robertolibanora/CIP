{% extends "layouts/admin_base.html" %}

{% block title %}Dettaglio Progetto - Admin CIP Immobiliare{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="page-loading" class="text-center py-12" data-project-id="{{ project_id }}">
    <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-gray-500 bg-white">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Caricamento progetto...
    </div>
</div>

<!-- Project Content -->
<div id="project-content" class="hidden space-y-6">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div class="flex-1">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-bold text-gray-900" id="project-title">Dettaglio Progetto</h1>
                    <button onclick="openEditTitleModal()" class="text-gray-400 hover:text-blue-600 transition-colors" title="Modifica titolo">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600" id="project-subtitle">Gestione completa progetto immobiliare</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="px-3 py-1 rounded-full text-sm font-medium" id="project-status-badge">Status</span>
                <button onclick="openSellModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium" id="sell-btn">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                    Vendita
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alerts-container"></div>

    <!-- Project Details and Stats -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Project Info -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Informazioni Progetto</h2>
            </div>
            <div class="p-6">
                <form id="project-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Codice Progetto</label>
                            <input type="text" name="code" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-code">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stato</label>
                            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-status">
                                <option value="active">Attivo</option>
                                <option value="completed">Completato</option>
                                <option value="cancelled">Annullato</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Titolo</label>
                        <input type="text" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-title">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                        <textarea name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-description"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Informazioni Dettagliate</label>
                        <textarea name="project_details" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-project_details" placeholder="Inserisci informazioni dettagliate del progetto"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Importo Totale (€)</label>
                            <input type="number" name="total_amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-total_amount">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label>
                            <input type="date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-start_date">
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="pt-4 border-t border-gray-200 flex justify-end">
                        <button type="button" onclick="saveProject()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium" id="save-btn">
                            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stats Card -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Statistiche Investimenti</h2>
            </div>
            <div class="p-6">
                <div class="space-y-4" id="project-stats">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestione Galleria Immagini -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Gestisci Immagini</h2>
                <button onclick="openGalleryUploadModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Aggiungi Immagine
                </button>
            </div>
        </div>
        <div class="p-6">
            <!-- Gallery Images -->
            <div id="gallery-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Gallery images will be loaded here -->
            </div>
            
            <!-- No images message -->
            <div id="no-gallery-message" class="hidden text-center py-8">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-500 mb-2">Nessuna immagine nella galleria</h3>
                <p class="text-sm text-gray-400">Aggiungi immagini per mostrare una galleria completa ai clienti</p>
            </div>
        </div>
    </div>

    <!-- Cambia Immagine -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Cambia Immagine</h2>
                <button onclick="openImageUploadModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Cambia Immagine
                </button>
            </div>
        </div>
        <div class="p-6">
            <!-- Current Image Display -->
            <div id="current-image-container" class="mb-6">
                <div class="text-center">
                    <div id="current-image" class="inline-block relative">
                        <!-- Current image will be loaded here -->
                    </div>
                    <div id="no-image-message" class="hidden">
                        <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">Nessuna immagine</h3>
                        <p class="text-sm text-gray-400">Clicca "Cambia Immagine" per aggiungere una foto al progetto</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Investors List -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Investitori</h2>
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium" id="investors-count">0 investitori</span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="investors-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Investitore</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KYC</th>
                    </tr>
                </thead>
                <tbody id="investors-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Investors will be loaded here -->
                </tbody>
            </table>
            
            <div id="investors-empty" class="hidden text-center py-8">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-500">Nessun investitore</h3>
                <p class="text-sm text-gray-400">Non ci sono ancora investimenti per questo progetto</p>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div id="image-upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Cambia Immagine Progetto</h3>
                <button onclick="closeImageModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="image-upload-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Seleziona Immagine <span class="text-red-500">*</span></label>
                    <input type="file" name="image" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" accept=".jpg,.jpeg,.png" required id="image-input">
                    <p class="text-xs text-gray-500 mt-1">Formati supportati: JPG, PNG (max 5MB)</p>
                </div>
                
                <!-- Preview -->
                <div id="image-preview" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Anteprima</label>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <img id="preview-img" class="w-full h-32 object-cover rounded-lg" alt="Anteprima immagine">
                    </div>
                </div>
            </form>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeImageModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Annulla
                </button>
                <button type="button" onclick="submitImageUpload()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="image-upload-btn">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Cambia Immagine
                </button>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
// Project Detail Manager
class ProjectDetailManager {
    constructor(projectId) {
        this.projectId = projectId;
        this.projectData = null;
        this.originalData = {};
        
        this.init();
    }
    
    async init() {
        await this.loadProjectData();
        this.bindEvents();
    }
    
    async loadProjectData() {
        const pageLoading = document.getElementById('page-loading');
        const projectContent = document.getElementById('project-content');
        
        try {
            console.log(`Loading project data for ID: ${this.projectId}`);
            const response = await fetch(`/admin/projects/${this.projectId}?format=json`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            this.projectData = await response.json();
            console.log('Project data loaded:', this.projectData);
            
            this.renderProject();
            this.renderStats();
            this.renderCurrentImage();
            this.renderInvestors();
            
            // Carica galleria e informazioni dettagliate
            if (this.projectData.project) {
                this.renderProjectDetails();
                this.renderGallery();
            }
            
        } catch (error) {
            console.error('Error loading project:', error);
            this.showAlert('error', 'Errore nel caricamento del progetto: ' + error.message);
        } finally {
            if (pageLoading) pageLoading.classList.add('hidden');
            if (projectContent) projectContent.classList.remove('hidden');
        }
    }
    
    renderProject() {
        const project = this.projectData.project;
        
        // Update page title and breadcrumb
        const titleEl = document.getElementById('project-title');
        if (titleEl) titleEl.textContent = project.name || 'Progetto Senza Titolo';
        
        const subtitleEl = document.getElementById('project-subtitle');
        if (subtitleEl) subtitleEl.textContent = `Codice: ${project.code || 'N/A'}`;
        
        // Update status badge
        const statusBadge = document.getElementById('project-status-badge');
        const statusColors = {
            active: 'bg-blue-100 text-blue-800',
            completed: 'bg-purple-100 text-purple-800',
            sold: 'bg-green-100 text-green-800',
            cancelled: 'bg-red-100 text-red-800'
        };
        const statusLabels = {
            active: 'Attivo',
            completed: 'Completato',
            sold: 'Venduto',
            cancelled: 'Annullato'
        };
        
        statusBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${statusColors[project.status] || 'bg-gray-100 text-gray-800'}`;
        statusBadge.textContent = statusLabels[project.status] || project.status;
        
        
        // Fill form fields
        document.getElementById('field-code').value = project.code || '';
        document.getElementById('field-title').value = project.name || '';
        document.getElementById('field-description').value = project.description || '';
        document.getElementById('field-status').value = project.status || 'active';
        document.getElementById('field-total_amount').value = project.total_amount || project.target_amount || '';
        document.getElementById('field-start_date').value = project.start_date || '';
        
        // Store original data
        this.originalData = {
            code: project.code || '',
            title: project.name || '',
            description: project.description || '',
            status: project.status || 'active',
            total_amount: project.total_amount || project.target_amount || '',
            start_date: project.start_date || '',
        };
    }
    
    renderStats() {
        const stats = this.projectData.stats;
        const project = this.projectData.project;
        
        const targetAmount = parseFloat(project.total_amount || project.target_amount) || 0;
        const totalInvested = parseFloat(stats.total_invested) || 0;
        const percentage = targetAmount > 0 ? (totalInvested / targetAmount * 100) : 0;
        
        // Mostra statistiche standard del progetto
            document.getElementById('project-stats').innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Investitori:</span>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${stats.investors_count || 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Totale Investito:</span>
                        <span class="text-sm font-medium">€${totalInvested.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Target:</span>
                        <span class="text-sm">€${targetAmount.toLocaleString()}</span>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Progresso:</span>
                            <span class="text-sm font-medium">${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                 style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                    ${stats.avg_investment ? `
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Media Investimento:</span>
                        <span class="text-sm">€${parseFloat(stats.avg_investment).toLocaleString()}</span>
                    </div>
                    ` : ''}
                </div>
            `;
    }
    
    // ===== VENDITA: anteprima e invio =====
    openSellModal() {
        const modal = document.getElementById('sellModal');
        if (!modal) return;
        document.getElementById('sellPrice').value = '';
        document.getElementById('sellPreview').innerHTML = '';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    closeSellModal() {
        const modal = document.getElementById('sellModal');
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    updateSalePreview() {
        const price = parseFloat(document.getElementById('sellPrice').value || '0');
        const stats = this.projectData?.stats || {};
        const totalInvested = parseFloat(stats.total_invested || '0');
        if (price <= 0 || totalInvested <= 0) {
            document.getElementById('sellPreview').innerHTML = '';
            return;
        }
        const profit = price - totalInvested;
        const pct = totalInvested > 0 ? (profit / totalInvested) * 100 : 0;
        document.getElementById('sellPreview').innerHTML = `
            <div class="p-3 bg-gray-50 rounded border border-gray-200 text-sm">
                <div class="flex justify-between"><span>Totale Investito:</span><strong>€${totalInvested.toLocaleString()}</strong></div>
                <div class="flex justify-between"><span>Prezzo Vendita:</span><strong>€${price.toLocaleString()}</strong></div>
                <div class="flex justify-between"><span>Profitto previsto:</span><strong class="${profit>=0?'text-green-600':'text-red-600'}">€${profit.toLocaleString()} (${pct.toFixed(1)}%)</strong></div>
            </div>`;
    }

    async confirmSale() {
        const price = parseFloat(document.getElementById('sellPrice').value || '0');
        if (!price || price <= 0) {
            alert('Inserisci un prezzo valido');
            return;
        }
        if (!confirm(`Confermi la vendita per €${price.toLocaleString()}?`)) return;

        const btn = document.getElementById('sellConfirmBtn');
        this.setButtonLoading(btn, true, 'Vendendo...');
        try {
            const resp = await fetch(`/admin/projects/${this.projectId}/sell`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sale_price: price })
            });
            const result = await resp.json();
            if (resp.ok && result.success) {
                this.showAlert('success', result.message || 'Vendita completata');
                this.closeSellModal();
                await this.loadProjectData();
                // nascondi tasto se venduto
                const sellBtn = document.getElementById('sell-btn');
                if (sellBtn) sellBtn.style.display = 'none';
            } else {
                this.showAlert('error', result.error || 'Errore durante la vendita');
            }
        } catch (e) {
            this.showAlert('error', 'Errore di connessione');
        } finally {
            this.setButtonLoading(btn, false);
        }
    }
    renderCurrentImage() {
        // Ottieni l'immagine dalla struttura corretta dei dati
        let imageUrl = null;
        if (this.projectData && this.projectData.project && this.projectData.project.image_url) {
            imageUrl = this.projectData.project.image_url;
        } else if (this.projectData && this.projectData.image_url) {
            imageUrl = this.projectData.image_url;
        }
        
        console.log('Rendering current image:', imageUrl);
        console.log('Project data structure:', this.projectData);
        
        const currentImageContainer = document.getElementById('current-image');
        const noImageMessage = document.getElementById('no-image-message');
        
        if (imageUrl) {
            // Show current image
            noImageMessage.classList.add('hidden');
            currentImageContainer.classList.remove('hidden');
            
            const imageSrc = `/admin/projects/images/${imageUrl}`;
            console.log('Image source:', imageSrc);
            
            currentImageContainer.innerHTML = `
                <div class="relative">
                    <img src="${imageSrc}" alt="Immagine progetto" class="w-64 h-48 object-cover rounded-lg shadow-md" 
                         onload="console.log('Image loaded successfully');"
                         onerror="console.error('Image failed to load:', this.src); this.style.display='none';">
                    <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all duration-200 rounded-lg flex items-center justify-center">
                        <div class="opacity-0 hover:opacity-100 transition-opacity text-center text-white">
                            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <p class="text-sm">Clicca per ingrandire</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click to enlarge
            currentImageContainer.querySelector('img').addEventListener('click', () => {
                window.open(imageSrc, '_blank');
            });
        } else {
            // Show no image message
            currentImageContainer.classList.add('hidden');
            noImageMessage.classList.remove('hidden');
        }
    }
    
    renderDocumentCard(doc) {
        const isImage = ['jpg', 'jpeg', 'png'].includes(doc.file_type?.toLowerCase());
        const isPDF = doc.file_type?.toLowerCase() === 'pdf';
        
        return `
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="aspect-square mb-3 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                    ${isImage ? `
                        <img src="/admin/uploads/${doc.file_path}" alt="${doc.title}" 
                             class="w-full h-full object-cover cursor-pointer"
                             onclick="openImagePreview('/admin/uploads/${doc.file_path}', '${doc.title}')">
                    ` : `
                        <div class="text-center">
                            <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-xs text-gray-500">${doc.file_type?.toUpperCase() || 'FILE'}</span>
                        </div>
                    `}
                </div>
                <h4 class="text-sm font-medium mb-1 line-clamp-2">${doc.title || 'Documento'}</h4>
                <p class="text-xs text-gray-500 mb-3">
                    ${new Date(doc.uploaded_at).toLocaleDateString('it-IT')}
                </p>
                <div class="flex space-x-1">
                    <a href="/admin/uploads/${doc.file_path}" target="_blank" 
                       class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs text-center">
                        Visualizza
                    </a>
                    <button onclick="deleteDocument(${doc.id})" 
                            class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-xs">
                        ×
                    </button>
                </div>
            </div>
        `;
    }
    
    renderInvestors() {
        const investments = this.projectData.investments || [];
        const tbody = document.getElementById('investors-tbody');
        const empty = document.getElementById('investors-empty');
        const count = document.getElementById('investors-count');
        
        count.textContent = `${investments.length} investitori`;
        
        if (investments.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        
        empty.classList.add('hidden');
        
        tbody.innerHTML = investments.map(inv => {
            const statusColors = {
                pending: 'bg-yellow-100 text-yellow-800',
                active: 'bg-green-100 text-green-800',
                completed: 'bg-blue-100 text-blue-800',
                cancelled: 'bg-red-100 text-red-800'
            };
            
            const kycColors = {
                verified: 'bg-green-100 text-green-800',
                pending: 'bg-yellow-100 text-yellow-800',
                rejected: 'bg-red-100 text-red-800',
                unverified: 'bg-gray-100 text-gray-800'
            };
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <p class="text-sm font-medium text-gray-900">${inv.full_name || inv.nome || 'Investitore'}</p>
                            <p class="text-sm text-gray-500">${inv.email}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <input type="number" 
                                   value="${parseFloat(inv.amount)}" 
                                   class="investment-amount-input w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                                   data-investment-id="${inv.id}"
                                   data-user-id="${inv.user_id}"
                                   data-original-amount="${parseFloat(inv.amount)}"
                                   min="0" 
                                   step="0.01">
                            <button onclick="updateInvestmentAmount(${inv.id}, ${inv.user_id}, this.previousElementSibling.value, ${parseFloat(inv.amount)})" 
                                    class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                💾
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[inv.status] || 'bg-gray-100 text-gray-800'}">
                            ${inv.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <p class="text-sm text-gray-900">${new Date(inv.created_at).toLocaleDateString('it-IT')}</p>
                            ${inv.activated_at ? `<p class="text-xs text-gray-500">Attivato: ${new Date(inv.activated_at).toLocaleDateString('it-IT')}</p>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${kycColors[inv.kyc_status] || 'bg-gray-100 text-gray-800'}">
                            ${inv.kyc_status}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async saveProject() {
        const form = document.getElementById('project-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        // Map field names to match backend expectations
        const mappedData = {
            code: data.code,
            title: data.title,  // Backend mapperà title -> name nel database
            description: data.description,
            project_details: data.project_details,
            status: data.status,
            total_amount: data.total_amount,
            start_date: data.start_date,
        };
        
        console.log('Sending data:', mappedData);
        
        const saveBtn = document.getElementById('save-btn');
        this.setButtonLoading(saveBtn, true, 'Salvando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}/edit`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(mappedData)
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Success response:', result);
                this.showAlert('success', 'Progetto aggiornato con successo');
                this.originalData = { ...mappedData };
                
                // Refresh project data
                await this.loadProjectData();
            } else {
                const result = await response.json();
                console.error('Error response:', result);
                this.showAlert('error', result.error || 'Errore nel salvataggio');
            }
        } catch (error) {
            console.error('Network error:', error);
            this.showAlert('error', 'Errore di connessione: ' + error.message);
        } finally {
            this.setButtonLoading(saveBtn, false);
        }
    }
    
    async deleteProject() {
        if (!confirm('Sei sicuro di voler eliminare questo progetto? Questa azione è irreversibile.')) {
            return;
        }
        
        const deleteBtn = document.getElementById('delete-btn');
        this.setButtonLoading(deleteBtn, true, 'Eliminando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            
            if (response.ok && result.deleted) {
                this.showAlert('success', result.message || 'Progetto eliminato con successo');
                setTimeout(() => {
                    window.location.href = '/admin/projects';
                }, 2000);
            } else {
                this.showAlert('error', result.error || 'Errore nell\'eliminazione');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            this.setButtonLoading(deleteBtn, false);
        }
    }
    
    bindEvents() {
        // File input preview
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    this.previewFile(file);
                }
            });
        }
    }
    
    previewFile(file) {
        const preview = document.getElementById('file-preview');
        const content = document.getElementById('preview-content');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                content.innerHTML = `<img src="${e.target.result}" alt="Preview" class="max-w-full h-32 object-contain">`;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            content.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${file.name}</p>
                        <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                </div>
            `;
            preview.classList.remove('hidden');
        }
    }
    
    async uploadFile() {
        const form = document.getElementById('upload-form');
        const formData = new FormData(form);
        
        if (!formData.get('file')) {
            this.showAlert('error', 'Seleziona un file da caricare');
            return;
        }
        
        const uploadBtn = document.getElementById('upload-btn');
        this.setButtonLoading(uploadBtn, true, 'Caricando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}/upload`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showAlert('success', 'File caricato con successo');
                closeModal();
                form.reset();
                document.getElementById('file-preview').classList.add('hidden');
                
                // Refresh documents
                await this.loadProjectData();
            } else {
                this.showAlert('error', result.error || 'Errore nel caricamento');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            this.setButtonLoading(uploadBtn, false);
        }
    }
    
    async uploadImage() {
        console.log('=== UPLOAD IMAGE START ===');
        const form = document.getElementById('image-upload-form');
        const formData = new FormData(form);
        
        console.log('Form data:', formData);
        console.log('Image file:', formData.get('image'));
        
        if (!formData.get('image')) {
            console.log('No image selected');
            this.showAlert('error', 'Seleziona un\'immagine da caricare');
            return;
        }
        
        const uploadBtn = document.getElementById('image-upload-btn');
        this.setButtonLoading(uploadBtn, true, 'Caricando...');
        
        try {
            const url = `/admin/projects/${this.projectId}/image`;
            console.log('Upload URL:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            const result = await response.json();
            console.log('Response result:', result);
            
            if (response.ok) {
                console.log('Upload successful, filename:', result.filename);
                // Mostra popup di successo
                this.showSuccessModal('Immagine aggiornata con successo!', 'L\'immagine principale del progetto è stata cambiata correttamente.');
                
                // Chiudi il modal di upload
                closeImageModal();
                form.reset();
                document.getElementById('image-preview').classList.add('hidden');
                
                // Aggiorna l'immagine visualizzata immediatamente
                this.updateProjectImage(result.filename);
                
                // Refresh project data
                await this.loadProjectData();
            } else {
                console.log('Upload failed:', result);
                // Mostra popup di errore
                this.showErrorModal('Errore nel cambio immagine', result.error || 'Si è verificato un errore durante il caricamento dell\'immagine.');
            }
        } catch (error) {
            console.error('Upload error:', error);
            this.showErrorModal('Errore di connessione', 'Impossibile connettersi al server. Riprova più tardi.');
        } finally {
            this.setButtonLoading(uploadBtn, false);
        }
    }
    
    updateProjectImage(filename) {
        // Pulisci eventuali messaggi di errore precedenti
        const currentImageContainer = document.getElementById('current-image');
        const errorMessages = currentImageContainer.querySelectorAll('.error-message');
        errorMessages.forEach(msg => msg.remove());
        
        // Aggiorna l'immagine nel projectData
        if (this.projectData && this.projectData.project) {
            this.projectData.project.image_url = filename;
        } else if (this.projectData) {
            this.projectData.image_url = filename;
        }
        
        console.log('Updated project data with new image:', filename);
        console.log('Project data after update:', this.projectData);
        
        // Rendi l'immagine aggiornata
        this.renderCurrentImage();
    }
    
    showSuccessModal(title, message) {
        this.showModal('success', title, message);
    }
    
    showErrorModal(title, message) {
        this.showModal('error', title, message);
    }
    
    showModal(type, title, message) {
        // Crea il modal se non esiste
        let modal = document.getElementById('image-change-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'image-change-modal';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                            <!-- Icon will be inserted here -->
                        </div>
                        <h3 id="modal-title" class="text-lg font-medium text-gray-900 mb-2"></h3>
                        <div id="modal-message" class="mt-2 px-7 py-3 text-sm text-gray-500"></div>
                        <div class="items-center px-4 py-3">
                            <button id="modal-close" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Aggiungi event listener per chiudere
            document.getElementById('modal-close').addEventListener('click', () => {
                modal.remove();
            });
            
            // Chiudi cliccando fuori dal modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Aggiorna il contenuto del modal
        const icon = document.getElementById('modal-icon');
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');
        
        if (type === 'success') {
            icon.innerHTML = `
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            `;
            icon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-green-100';
        } else {
            icon.innerHTML = `
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
            icon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-red-100';
        }
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        // Mostra il modal
        modal.classList.remove('hidden');
    }
    
    setButtonLoading(button, loading, text) {
        if (loading) {
            button.disabled = true;
            button.innerHTML = `
                <svg class="w-4 h-4 mr-2 animate-spin inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                ${text}
            `;
        } else {
            button.disabled = false;
            button.innerHTML = `
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Salva Modifiche
            `;
        }
    }
    
    showAlert(type, message) {
        const container = document.getElementById('alerts-container');
        const alertId = 'alert-' + Date.now();
        
        const alertColors = {
            success: 'bg-green-100 border-green-400 text-green-700',
            error: 'bg-red-100 border-red-400 text-red-700',
            warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
            info: 'bg-blue-100 border-blue-400 text-blue-700'
        };
        
        container.innerHTML = `
            <div id="${alertId}" class="border-l-4 p-4 mb-4 ${alertColors[type] || alertColors.info}">
                <div class="flex items-start">
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm opacity-70 hover:opacity-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, 5000);
    }
    
    renderProjectDetails() {
        const project = this.projectData.project;
        const detailsField = document.getElementById('field-project_details');
        
        if (detailsField && project.project_details) {
            detailsField.value = project.project_details;
        }
    }
    
    renderGallery() {
        const project = this.projectData.project;
        const gallery = project.gallery || [];
        
        // Usa la funzione globale displayGallery
        if (typeof displayGallery === 'function') {
            displayGallery(gallery);
        }
    }
}

// Global variables and functions
let projectDetailManager;

function saveProject() {
    projectDetailManager.saveProject();
}

function deleteProject() {
    projectDetailManager.deleteProject();
}

function openSellModal() {
    projectDetailManager.openSellModal();
}

function closeSellModal() {
    projectDetailManager.closeSellModal();
}

function updateSalePreview() {
    projectDetailManager.updateSalePreview();
}

function confirmSale() {
    projectDetailManager.confirmSale();
}

function openImageUploadModal() {
    document.getElementById('image-upload-modal').classList.remove('hidden');
    
    // Setup image preview
    const imageInput = document.getElementById('image-input');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('image-preview').classList.add('hidden');
        }
    });
}

function closeImageModal() {
    document.getElementById('image-upload-modal').classList.add('hidden');
    // Reset form
    document.getElementById('image-upload-form').reset();
    document.getElementById('image-preview').classList.add('hidden');
}

function submitImageUpload() {
    projectDetailManager.uploadImage();
}

function openImagePreview(src, title) {
    window.open(src, '_blank');
}

function deleteDocument(docId) {
    if (confirm('Sei sicuro di voler eliminare questo documento?')) {
        alert('Funzionalità in sviluppo');
    }
}


async function updateInvestmentAmount(investmentId, userId, newAmount, originalAmount) {
    const newAmountFloat = parseFloat(newAmount);
    const originalAmountFloat = parseFloat(originalAmount);
    
    // Validazione
    if (isNaN(newAmountFloat) || newAmountFloat < 0) {
        alert('Inserisci un importo valido maggiore o uguale a 0');
        return;
    }
    
    if (newAmountFloat === originalAmountFloat) {
        alert('L\'importo non è cambiato');
        return;
    }
    
    const button = event.target;
    const input = button.previousElementSibling;
    
    // Mostra loading
    const originalButtonText = button.innerHTML;
    button.innerHTML = '⏳';
    button.disabled = true;
    input.disabled = true;
    
    try {
        const response = await fetch(`/admin/api/admin/users/${userId}/portfolio/investments/${investmentId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                amount: newAmountFloat
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Successo - aggiorna l'interfaccia
            input.setAttribute('data-original-amount', newAmountFloat);
            
            // Ricarica i dati del progetto per aggiornare la barra di progresso
            await projectDetailManager.loadProjectData();
            
            // Mostra messaggio di successo
            projectDetailManager.showAlert('success', `Investimento aggiornato: €${originalAmountFloat.toLocaleString()} → €${newAmountFloat.toLocaleString()}`);
            
            button.innerHTML = '✅';
            setTimeout(() => {
                button.innerHTML = originalButtonText;
            }, 2000);
        } else {
            throw new Error(result.error || 'Errore durante l\'aggiornamento');
        }
    } catch (error) {
        console.error('Errore aggiornamento investimento:', error);
        
        // Ripristina il valore originale
        input.value = originalAmountFloat;
        
        // Mostra errore
        projectDetailManager.showAlert('error', `Errore: ${error.message}`);
        
        button.innerHTML = '❌';
        setTimeout(() => {
            button.innerHTML = originalButtonText;
        }, 2000);
    } finally {
        // Riabilita i controlli
        button.disabled = false;
        input.disabled = false;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const projectId = parseInt(document.getElementById('page-loading').getAttribute('data-project-id'));
    projectDetailManager = new ProjectDetailManager(projectId);
    
});

// ---- Gestione Galleria Immagini ----
function openGalleryUploadModal() {
    document.getElementById('galleryUploadModal').classList.remove('hidden');
}

function closeGalleryUploadModal() {
    document.getElementById('galleryUploadModal').classList.add('hidden');
    document.getElementById('galleryUploadForm').reset();
}

// Funzioni rimosse - duplicate

// Carica la galleria immagini
async function loadGallery() {
    try {
        const response = await fetch(`/admin/api/projects/${projectDetailManager.projectId}`);
        if (response.ok) {
            const data = await response.json();
            const gallery = data.project.gallery || [];
            displayGallery(gallery);
        }
    } catch (error) {
        console.error('Errore nel caricamento galleria:', error);
    }
}

// Mostra la galleria
function displayGallery(gallery) {
    console.log('=== DISPLAY GALLERY ===');
    console.log('Gallery data:', gallery);
    
    const container = document.getElementById('gallery-container');
    const noMessage = document.getElementById('no-gallery-message');
    
    if (!container) {
        console.error('Gallery container not found!');
        return;
    }
    
    if (gallery.length === 0) {
        container.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
    }
    
    noMessage.classList.add('hidden');
    
    // Filtra solo le immagini che esistono realmente
    const validImages = gallery.filter(image => {
        // Per ora mostriamo tutte, ma potremmo aggiungere un controllo
        return true;
    });
    
    const galleryHTML = validImages.map((image, index) => {
        const imageUrl = `/admin/projects/images/${image}`;
        console.log(`Creating image ${index + 1}: ${imageUrl}`);
        return `
        <div class="relative group">
            <img src="${imageUrl}" 
                 alt="Gallery image ${index + 1}" 
                 class="w-full h-32 object-cover rounded-lg"
                 onerror="this.style.display='none';"
                 onload="console.log('✅ Image loaded successfully:', '${imageUrl}')"
                 onloadstart="console.log('🔄 Loading image:', '${imageUrl}')">
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-200 rounded-lg flex items-center justify-center">
                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex space-x-2">
                    <button onclick="deleteGalleryImage('${image}')" 
                            class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `;
    }).join('');
    
    console.log('Gallery HTML:', galleryHTML);
    container.innerHTML = galleryHTML;
}

// Gestisce errori di caricamento immagini - ora semplicemente nasconde l'immagine

// Rimuove immagine mancante dal database
async function removeMissingImage(imageName) {
    if (!confirm('Rimuovere questa immagine mancante dalla galleria?')) return;
    
    try {
        const response = await fetch(`/admin/projects/${projectDetailManager.projectId}/gallery/${imageName}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            const result = await response.json();
            displayGallery(result.gallery);
            projectDetailManager.showAlert('success', 'Immagine mancante rimossa dalla galleria');
        } else {
            const error = await response.json();
            projectDetailManager.showAlert('error', error.error);
        }
    } catch (error) {
        projectDetailManager.showAlert('error', 'Errore durante la rimozione');
    }
}

// Elimina immagine dalla galleria
async function deleteGalleryImage(filename) {
    if (!confirm('Sei sicuro di voler eliminare questa immagine?')) return;
    
    try {
        const response = await fetch(`/admin/projects/${projectDetailManager.projectId}/gallery/${filename}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            const result = await response.json();
            displayGallery(result.gallery);
            projectDetailManager.showAlert('success', 'Immagine eliminata con successo');
        } else {
            const error = await response.json();
            projectDetailManager.showAlert('error', error.error);
        }
    } catch (error) {
        projectDetailManager.showAlert('error', 'Errore durante l\'eliminazione');
    }
}

// Upload immagine galleria - VERSIONE SEMPLIFICATA E ROBUSTA
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up gallery upload form listener...');
    const galleryForm = document.getElementById('galleryUploadForm');
    
    if (!galleryForm) {
        console.error('Gallery upload form not found!');
        return;
    }
    
    console.log('Gallery upload form found, adding listener...');
    
    galleryForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('=== GALLERY UPLOAD STARTED ===');
        
        const fileInput = this.querySelector('input[type="file"]');
        const file = fileInput.files[0];
        
        if (!file) {
            projectDetailManager.showAlert('error', 'Seleziona un file prima di caricare!');
            return;
        }
        
        console.log('File selected:', file.name, file.size, file.type);
        
        const formData = new FormData();
        formData.append('file', file);
        
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg> Caricamento...';
        
        try {
            const url = `/admin/projects/${projectDetailManager.projectId}/gallery/upload`;
            console.log('Upload URL:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            
            console.log('Response status:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Upload success:', result);
                
                // Aggiorna la galleria
                if (result.gallery) {
                    displayGallery(result.gallery);
                }
                
                projectDetailManager.showAlert('success', 'Immagine caricata con successo!');
                closeGalleryUploadModal();
                
                // Ricarica i dati del progetto
                await projectDetailManager.loadProjectData();
            } else {
                const error = await response.json();
                console.error('Upload error:', error);
                projectDetailManager.showAlert('error', `Errore: ${error.error || 'Errore sconosciuto'}`);
            }
        } catch (error) {
            console.error('Upload network error:', error);
            projectDetailManager.showAlert('error', `Errore di rete: ${error.message}`);
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        }
    });
});

// Le informazioni dettagliate sono ora gestite dal form principale

// Funzioni per il modal di modifica titolo
function openEditTitleModal() {
    const modal = document.getElementById('edit-title-modal');
    const input = document.getElementById('edit-title-input');
    const currentTitle = document.getElementById('project-title').textContent;
    
    // Popola il campo con il titolo corrente
    input.value = currentTitle;
    
    // Mostra il modal
    modal.style.display = 'flex';
    
    // Focus sul campo input
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

// Gestione form di modifica titolo
document.addEventListener('DOMContentLoaded', function() {
    const editTitleForm = document.getElementById('edit-title-form');
    if (editTitleForm) {
        editTitleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(editTitleForm);
            const newTitle = formData.get('title').trim();
            
            if (!newTitle) {
                alert('Il titolo non può essere vuoto');
                return;
            }
            
            try {
                const response = await fetch(`/admin/projects/${window.projectDetailManager?.projectId || document.querySelector('[data-project-id]')?.getAttribute('data-project-id')}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: newTitle
                    })
                });
                
                if (response.ok) {
                    // Aggiorna il titolo nella pagina
                    document.getElementById('project-title').textContent = newTitle;
                    
                    // Chiudi il modal
                    closeModal('edit-title-modal');
                    
                    // Mostra messaggio di successo
                    if (window.projectDetailManager) {
                        window.projectDetailManager.showAlert('success', 'Titolo aggiornato con successo!');
                    }
                } else {
                    const error = await response.json();
                    alert('Errore: ' + (error.error || 'Errore sconosciuto'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore di connessione: ' + error.message);
            }
        });
    }
});
</script>

<!-- Modali per gestione immagini -->
<!-- Modal Vendita Progetto -->
<div id="sellModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h2 class="text-xl font-bold mb-4">Vendi Progetto</h2>
        <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo di Vendita (€)</label>
            <input type="number" id="sellPrice" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Es. 300000" min="0" step="0.01" oninput="updateSalePreview()">
        </div>
        <div id="sellPreview" class="mb-4"></div>
        <div class="flex justify-end space-x-3">
            <button onclick="closeSellModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Annulla</button>
            <button id="sellConfirmBtn" onclick="confirmSale()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Conferma Vendita</button>
        </div>
    </div>
    
</div>
<!-- Modal Upload Galleria -->
<div id="galleryUploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">Aggiungi Immagine alla Galleria</h3>
            <button onclick="closeGalleryUploadModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="galleryUploadForm" enctype="multipart/form-data">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Seleziona Immagine</label>
                <input type="file" name="file" accept="image/*" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">Formati supportati: JPG, PNG, GIF, WebP (max 5MB)</p>
            </div>
            
            <div class="flex space-x-3">
                <button type="button" onclick="closeGalleryUploadModal()" 
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium">
                    Annulla
                </button>
                <button type="submit" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium">
                    Carica Immagine
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Modifica Titolo -->
<div id="edit-title-modal" class="admin-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: transparent; align-items: center; justify-content: center;">
    <div class="admin-modal-backdrop" onclick="closeModal('edit-title-modal')" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);"></div>
    <div class="admin-modal-container" style="position: relative; background: white; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); overflow: hidden;">
        <div class="admin-modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: white;">Modifica Titolo Progetto</h3>
                    <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: rgba(255,255,255,0.8);">Aggiorna il titolo del progetto</p>
                </div>
            </div>
            <button type="button" onclick="closeModal('edit-title-modal')" style="background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="admin-modal-body" style="padding: 24px;">
            <form id="edit-title-form" style="display: flex; flex-direction: column; gap: 16px;">
                <div style="display: flex; flex-direction: column;">
                    <label style="margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 0.875rem;">Titolo Progetto *</label>
                    <input type="text" name="title" id="edit-title-input" 
                           placeholder="Inserisci il titolo del progetto" required
                           style="padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: all 0.2s; background: #fafafa;" 
                           onfocus="this.style.borderColor='#3b82f6'; this.style.background='white'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" 
                           onblur="this.style.borderColor='#e5e7eb'; this.style.background='#fafafa'; this.style.boxShadow='none'">
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px;">
                    <button type="button" onclick="closeModal('edit-title-modal')" 
                            style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                        Annulla
                    </button>
                    <button type="submit" 
                            style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                        Salva Modifiche
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal duplicato rimosso -->

{% endblock %}

{% endblock %}
