{% extends "layouts/admin_base.html" %}

{% block title %}Dettaglio Progetto - Admin CIP Immobiliare{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="page-loading" class="text-center py-12">
    <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-gray-500 bg-white">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Caricamento progetto...
    </div>
</div>

<!-- Project Content -->
<div id="project-content" class="hidden space-y-6">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900" id="project-title">Dettaglio Progetto</h1>
                <p class="text-sm text-gray-600" id="project-subtitle">Gestione completa progetto immobiliare</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="px-3 py-1 rounded-full text-sm font-medium" id="project-status-badge">Status</span>
                <button onclick="deleteProject()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium" id="delete-btn">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Elimina
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alerts-container"></div>

    <!-- Project Details and Stats -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Project Info -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Informazioni Progetto</h2>
            </div>
            <div class="p-6">
                <form id="project-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Codice Progetto</label>
                            <input type="text" name="code" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-code">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stato</label>
                            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-status">
                                <option value="active">Attivo</option>
                                <option value="completed">Completato</option>
                                <option value="cancelled">Annullato</option>
                                <option value="sold">Venduto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Titolo</label>
                        <input type="text" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-title">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                        <textarea name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-description"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Importo Totale (â‚¬)</label>
                            <input type="number" name="total_amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-total_amount">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Inizio</label>
                            <input type="date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-start_date">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Fine</label>
                            <input type="date" name="end_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="field-end_date">
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="pt-4 border-t border-gray-200 flex justify-end">
                        <button type="button" onclick="saveProject()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium" id="save-btn">
                            <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stats Card -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Statistiche Investimenti</h2>
            </div>
            <div class="p-6">
                <div class="space-y-4" id="project-stats">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cambia Immagine -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Cambia Immagine</h2>
                <button onclick="openImageUploadModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Cambia Immagine
                </button>
            </div>
        </div>
        <div class="p-6">
            <!-- Current Image Display -->
            <div id="current-image-container" class="mb-6">
                <div class="text-center">
                    <div id="current-image" class="inline-block relative">
                        <!-- Current image will be loaded here -->
                    </div>
                    <div id="no-image-message" class="hidden">
                        <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">Nessuna immagine</h3>
                        <p class="text-sm text-gray-400">Clicca "Cambia Immagine" per aggiungere una foto al progetto</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Investors List -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Investitori</h2>
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium" id="investors-count">0 investitori</span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="investors-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Investitore</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KYC</th>
                    </tr>
                </thead>
                <tbody id="investors-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Investors will be loaded here -->
                </tbody>
            </table>
            
            <div id="investors-empty" class="hidden text-center py-8">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-500">Nessun investitore</h3>
                <p class="text-sm text-gray-400">Non ci sono ancora investimenti per questo progetto</p>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div id="image-upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Cambia Immagine Progetto</h3>
                <button onclick="closeImageModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="image-upload-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Seleziona Immagine <span class="text-red-500">*</span></label>
                    <input type="file" name="image" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" accept=".jpg,.jpeg,.png" required id="image-input">
                    <p class="text-xs text-gray-500 mt-1">Formati supportati: JPG, PNG (max 5MB)</p>
                </div>
                
                <!-- Preview -->
                <div id="image-preview" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Anteprima</label>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <img id="preview-img" class="w-full h-32 object-cover rounded-lg" alt="Anteprima immagine">
                    </div>
                </div>
            </form>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeImageModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Annulla
                </button>
                <button type="button" onclick="submitImageUpload()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="image-upload-btn">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Cambia Immagine
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Project Detail Manager
class ProjectDetailManager {
    constructor(projectId) {
        this.projectId = projectId;
        this.projectData = null;
        this.originalData = {};
        
        this.init();
    }
    
    async init() {
        await this.loadProjectData();
        this.bindEvents();
    }
    
    async loadProjectData() {
        const pageLoading = document.getElementById('page-loading');
        const projectContent = document.getElementById('project-content');
        
        try {
            console.log(`Loading project data for ID: ${this.projectId}`);
            const response = await fetch(`/admin/projects/${this.projectId}?format=json`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            this.projectData = await response.json();
            console.log('Project data loaded:', this.projectData);
            
            this.renderProject();
            this.renderStats();
            this.renderCurrentImage();
            this.renderInvestors();
            
        } catch (error) {
            console.error('Error loading project:', error);
            this.showAlert('error', 'Errore nel caricamento del progetto: ' + error.message);
        } finally {
            if (pageLoading) pageLoading.classList.add('hidden');
            if (projectContent) projectContent.classList.remove('hidden');
        }
    }
    
    renderProject() {
        const project = this.projectData.project;
        
        // Update page title and breadcrumb
        const titleEl = document.getElementById('project-title');
        if (titleEl) titleEl.textContent = project.name || project.title || 'Progetto Senza Titolo';
        
        const subtitleEl = document.getElementById('project-subtitle');
        if (subtitleEl) subtitleEl.textContent = `Codice: ${project.code || 'N/A'}`;
        
        // Update status badge
        const statusBadge = document.getElementById('project-status-badge');
        const statusColors = {
            active: 'bg-blue-100 text-blue-800',
            completed: 'bg-purple-100 text-purple-800',
            sold: 'bg-green-100 text-green-800',
            cancelled: 'bg-red-100 text-red-800'
        };
        const statusLabels = {
            active: 'Attivo',
            completed: 'Completato',
            sold: 'Venduto',
            cancelled: 'Annullato'
        };
        
        statusBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${statusColors[project.status] || 'bg-gray-100 text-gray-800'}`;
        statusBadge.textContent = statusLabels[project.status] || project.status;
        
        // Fill form fields
        document.getElementById('field-code').value = project.code || '';
        document.getElementById('field-title').value = project.name || project.title || '';
        document.getElementById('field-description').value = project.description || '';
        document.getElementById('field-status').value = project.status || 'active';
        document.getElementById('field-total_amount').value = project.total_amount || project.target_amount || '';
        document.getElementById('field-start_date').value = project.start_date || '';
        document.getElementById('field-end_date').value = project.end_date || '';
        
        // Store original data
        this.originalData = {
            code: project.code || '',
            title: project.name || project.title || '',
            description: project.description || '',
            status: project.status || 'active',
            total_amount: project.total_amount || project.target_amount || '',
            start_date: project.start_date || '',
            end_date: project.end_date || ''
        };
    }
    
    renderStats() {
        const stats = this.projectData.stats;
        const project = this.projectData.project;
        
        const targetAmount = parseFloat(project.total_amount || project.target_amount) || 0;
        const totalInvested = parseFloat(stats.total_invested) || 0;
        const percentage = targetAmount > 0 ? (totalInvested / targetAmount * 100) : 0;
        
        document.getElementById('project-stats').innerHTML = `
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Investitori:</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${stats.investors_count || 0}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Totale Investito:</span>
                    <span class="text-sm font-medium">â‚¬${totalInvested.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Target:</span>
                    <span class="text-sm">â‚¬${targetAmount.toLocaleString()}</span>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Progresso:</span>
                        <span class="text-sm font-medium">${percentage.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                             style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                </div>
                ${stats.avg_investment ? `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Media Investimento:</span>
                    <span class="text-sm">â‚¬${parseFloat(stats.avg_investment).toLocaleString()}</span>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    renderCurrentImage() {
        const imageUrl = this.projectData.image_url;
        const currentImageContainer = document.getElementById('current-image');
        const noImageMessage = document.getElementById('no-image-message');
        
        if (imageUrl) {
            // Show current image
            noImageMessage.classList.add('hidden');
            currentImageContainer.classList.remove('hidden');
            
            currentImageContainer.innerHTML = `
                <div class="relative">
                    <img src="/uploads/projects/${imageUrl}" alt="Immagine progetto" class="w-64 h-48 object-cover rounded-lg shadow-md">
                    <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all duration-200 rounded-lg flex items-center justify-center">
                        <div class="opacity-0 hover:opacity-100 transition-opacity text-center text-white">
                            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <p class="text-sm">Clicca per ingrandire</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click to enlarge
            currentImageContainer.querySelector('img').addEventListener('click', () => {
                window.open(`/uploads/projects/${imageUrl}`, '_blank');
            });
        } else {
            // Show no image message
            currentImageContainer.classList.add('hidden');
            noImageMessage.classList.remove('hidden');
        }
    }
    
    renderDocumentCard(doc) {
        const isImage = ['jpg', 'jpeg', 'png'].includes(doc.file_type?.toLowerCase());
        const isPDF = doc.file_type?.toLowerCase() === 'pdf';
        
        return `
            <div class="bg-white border border-gray-200 rounded-lg p-4">
                <div class="aspect-square mb-3 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                    ${isImage ? `
                        <img src="/admin/uploads/${doc.file_path}" alt="${doc.title}" 
                             class="w-full h-full object-cover cursor-pointer"
                             onclick="openImagePreview('/admin/uploads/${doc.file_path}', '${doc.title}')">
                    ` : `
                        <div class="text-center">
                            <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-xs text-gray-500">${doc.file_type?.toUpperCase() || 'FILE'}</span>
                        </div>
                    `}
                </div>
                <h4 class="text-sm font-medium mb-1 line-clamp-2">${doc.title || 'Documento'}</h4>
                <p class="text-xs text-gray-500 mb-3">
                    ${new Date(doc.uploaded_at).toLocaleDateString('it-IT')}
                </p>
                <div class="flex space-x-1">
                    <a href="/admin/uploads/${doc.file_path}" target="_blank" 
                       class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs text-center">
                        Visualizza
                    </a>
                    <button onclick="deleteDocument(${doc.id})" 
                            class="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded text-xs">
                        Ã—
                    </button>
                </div>
            </div>
        `;
    }
    
    renderInvestors() {
        const investments = this.projectData.investments || [];
        const tbody = document.getElementById('investors-tbody');
        const empty = document.getElementById('investors-empty');
        const count = document.getElementById('investors-count');
        
        count.textContent = `${investments.length} investitori`;
        
        if (investments.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        
        empty.classList.add('hidden');
        
        tbody.innerHTML = investments.map(inv => {
            const statusColors = {
                pending: 'bg-yellow-100 text-yellow-800',
                active: 'bg-green-100 text-green-800',
                completed: 'bg-blue-100 text-blue-800',
                cancelled: 'bg-red-100 text-red-800'
            };
            
            const kycColors = {
                verified: 'bg-green-100 text-green-800',
                pending: 'bg-yellow-100 text-yellow-800',
                rejected: 'bg-red-100 text-red-800',
                unverified: 'bg-gray-100 text-gray-800'
            };
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <p class="text-sm font-medium text-gray-900">${inv.full_name}</p>
                            <p class="text-sm text-gray-500">${inv.email}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <input type="number" 
                                   value="${parseFloat(inv.amount)}" 
                                   class="investment-amount-input w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" 
                                   data-investment-id="${inv.id}"
                                   data-user-id="${inv.user_id}"
                                   data-original-amount="${parseFloat(inv.amount)}"
                                   min="0" 
                                   step="0.01">
                            <button onclick="updateInvestmentAmount(${inv.id}, ${inv.user_id}, this.previousElementSibling.value, ${parseFloat(inv.amount)})" 
                                    class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                ðŸ’¾
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[inv.status] || 'bg-gray-100 text-gray-800'}">
                            ${inv.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <p class="text-sm text-gray-900">${new Date(inv.created_at).toLocaleDateString('it-IT')}</p>
                            ${inv.activated_at ? `<p class="text-xs text-gray-500">Attivato: ${new Date(inv.activated_at).toLocaleDateString('it-IT')}</p>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${kycColors[inv.kyc_status] || 'bg-gray-100 text-gray-800'}">
                            ${inv.kyc_status}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async saveProject() {
        const form = document.getElementById('project-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        // Map field names to match backend expectations
        const mappedData = {
            code: data.code,
            title: data.title,  // Backend mapperÃ  title -> name nel database
            description: data.description,
            status: data.status,
            total_amount: data.total_amount,
            start_date: data.start_date,
            end_date: data.end_date
        };
        
        console.log('Sending data:', mappedData);
        
        const saveBtn = document.getElementById('save-btn');
        this.setButtonLoading(saveBtn, true, 'Salvando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}/edit`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(mappedData)
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Success response:', result);
                this.showAlert('success', 'Progetto aggiornato con successo');
                this.originalData = { ...mappedData };
                
                // Refresh project data
                await this.loadProjectData();
            } else {
                const result = await response.json();
                console.error('Error response:', result);
                this.showAlert('error', result.error || 'Errore nel salvataggio');
            }
        } catch (error) {
            console.error('Network error:', error);
            this.showAlert('error', 'Errore di connessione: ' + error.message);
        } finally {
            this.setButtonLoading(saveBtn, false);
        }
    }
    
    async deleteProject() {
        if (!confirm('Sei sicuro di voler eliminare questo progetto? Questa azione Ã¨ irreversibile.')) {
            return;
        }
        
        const deleteBtn = document.getElementById('delete-btn');
        this.setButtonLoading(deleteBtn, true, 'Eliminando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            
            if (response.ok && result.deleted) {
                this.showAlert('success', result.message || 'Progetto eliminato con successo');
                setTimeout(() => {
                    window.location.href = '/admin/projects';
                }, 2000);
            } else {
                this.showAlert('error', result.error || 'Errore nell\'eliminazione');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            this.setButtonLoading(deleteBtn, false);
        }
    }
    
    bindEvents() {
        // File input preview
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    this.previewFile(file);
                }
            });
        }
    }
    
    previewFile(file) {
        const preview = document.getElementById('file-preview');
        const content = document.getElementById('preview-content');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                content.innerHTML = `<img src="${e.target.result}" alt="Preview" class="max-w-full h-32 object-contain">`;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            content.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${file.name}</p>
                        <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                </div>
            `;
            preview.classList.remove('hidden');
        }
    }
    
    async uploadFile() {
        const form = document.getElementById('upload-form');
        const formData = new FormData(form);
        
        if (!formData.get('file')) {
            this.showAlert('error', 'Seleziona un file da caricare');
            return;
        }
        
        const uploadBtn = document.getElementById('upload-btn');
        this.setButtonLoading(uploadBtn, true, 'Caricando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}/upload`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showAlert('success', 'File caricato con successo');
                closeModal();
                form.reset();
                document.getElementById('file-preview').classList.add('hidden');
                
                // Refresh documents
                await this.loadProjectData();
            } else {
                this.showAlert('error', result.error || 'Errore nel caricamento');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            this.setButtonLoading(uploadBtn, false);
        }
    }
    
    async uploadImage() {
        const form = document.getElementById('image-upload-form');
        const formData = new FormData(form);
        
        if (!formData.get('image')) {
            this.showAlert('error', 'Seleziona un\'immagine da caricare');
            return;
        }
        
        const uploadBtn = document.getElementById('image-upload-btn');
        this.setButtonLoading(uploadBtn, true, 'Caricando...');
        
        try {
            const response = await fetch(`/admin/projects/${this.projectId}/image`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showAlert('success', 'Immagine aggiornata con successo');
                closeImageModal();
                form.reset();
                document.getElementById('image-preview').classList.add('hidden');
                
                // Refresh project data
                await this.loadProjectData();
            } else {
                this.showAlert('error', result.error || 'Errore nel caricamento dell\'immagine');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            this.setButtonLoading(uploadBtn, false);
        }
    }
    
    setButtonLoading(button, loading, text) {
        if (loading) {
            button.disabled = true;
            button.innerHTML = `
                <svg class="w-4 h-4 mr-2 animate-spin inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                ${text}
            `;
        } else {
            button.disabled = false;
            button.innerHTML = `
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Salva Modifiche
            `;
        }
    }
    
    showAlert(type, message) {
        const container = document.getElementById('alerts-container');
        const alertId = 'alert-' + Date.now();
        
        const alertColors = {
            success: 'bg-green-100 border-green-400 text-green-700',
            error: 'bg-red-100 border-red-400 text-red-700',
            warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
            info: 'bg-blue-100 border-blue-400 text-blue-700'
        };
        
        container.innerHTML = `
            <div id="${alertId}" class="border-l-4 p-4 mb-4 ${alertColors[type] || alertColors.info}">
                <div class="flex items-start">
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm opacity-70 hover:opacity-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, 5000);
    }
}

// Global variables and functions
let projectDetailManager;

function saveProject() {
    projectDetailManager.saveProject();
}

function deleteProject() {
    projectDetailManager.deleteProject();
}

function openImageUploadModal() {
    document.getElementById('image-upload-modal').classList.remove('hidden');
    
    // Setup image preview
    const imageInput = document.getElementById('image-input');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('image-preview').classList.add('hidden');
        }
    });
}

function closeImageModal() {
    document.getElementById('image-upload-modal').classList.add('hidden');
    // Reset form
    document.getElementById('image-upload-form').reset();
    document.getElementById('image-preview').classList.add('hidden');
}

function submitImageUpload() {
    projectDetailManager.uploadImage();
}

function openImagePreview(src, title) {
    window.open(src, '_blank');
}

function deleteDocument(docId) {
    if (confirm('Sei sicuro di voler eliminare questo documento?')) {
        alert('FunzionalitÃ  in sviluppo');
    }
}

async function updateInvestmentAmount(investmentId, userId, newAmount, originalAmount) {
    const newAmountFloat = parseFloat(newAmount);
    const originalAmountFloat = parseFloat(originalAmount);
    
    // Validazione
    if (isNaN(newAmountFloat) || newAmountFloat < 0) {
        alert('Inserisci un importo valido maggiore o uguale a 0');
        return;
    }
    
    if (newAmountFloat === originalAmountFloat) {
        alert('L\'importo non Ã¨ cambiato');
        return;
    }
    
    const button = event.target;
    const input = button.previousElementSibling;
    
    // Mostra loading
    const originalButtonText = button.innerHTML;
    button.innerHTML = 'â³';
    button.disabled = true;
    input.disabled = true;
    
    try {
        const response = await fetch(`/admin/api/admin/users/${userId}/portfolio/investments/${investmentId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                amount: newAmountFloat
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Successo - aggiorna l'interfaccia
            input.setAttribute('data-original-amount', newAmountFloat);
            
            // Ricarica i dati del progetto per aggiornare la barra di progresso
            await projectDetailManager.loadProjectData();
            
            // Mostra messaggio di successo
            projectDetailManager.showAlert('success', `Investimento aggiornato: â‚¬${originalAmountFloat.toLocaleString()} â†’ â‚¬${newAmountFloat.toLocaleString()}`);
            
            button.innerHTML = 'âœ…';
            setTimeout(() => {
                button.innerHTML = originalButtonText;
            }, 2000);
        } else {
            throw new Error(result.error || 'Errore durante l\'aggiornamento');
        }
    } catch (error) {
        console.error('Errore aggiornamento investimento:', error);
        
        // Ripristina il valore originale
        input.value = originalAmountFloat;
        
        // Mostra errore
        projectDetailManager.showAlert('error', `Errore: ${error.message}`);
        
        button.innerHTML = 'âŒ';
        setTimeout(() => {
            button.innerHTML = originalButtonText;
        }, 2000);
    } finally {
        // Riabilita i controlli
        button.disabled = false;
        input.disabled = false;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const projectId = {{ project_id }};
    projectDetailManager = new ProjectDetailManager(projectId);
});
</script>
{% endblock %}
{% endblock %}
