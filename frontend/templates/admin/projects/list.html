{% extends "layouts/admin_base.html" %}

{% block title %}Progetti - Admin{% endblock %}

{% block content %}
<div class="admin-card admin-card-body mb-6">
    <div class="admin-flex admin-flex--between">
        <div>
            <h1 class="admin-heading-1">Progetti</h1>
            <p class="admin-text-small">Gestisci foto, descrizione e raccolta</p>
        </div>
        <div class="mt-4 md:mt-0 flex gap-3">
            <button id="create-project-btn" class="admin-btn admin-btn--primary" data-original-text="Crea Progetto" style="background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openCreateProjectModal();">
                <span style="margin-right: 8px;">+</span>
                Crea Progetto
            </button>
        </div>
    </div>
</div>

<div id="projects-grid-hero" class="admin-grid admin-grid--3"></div>
<div id="projects-empty-hero" class="text-center text-gray-500 admin-card admin-card-body hidden">Nessun progetto</div>

<!-- Filtri e Statistiche -->
<div class="hidden">
    <!-- Filtri -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Filtri Progetti</h2>
        </div>
        <div class="admin-card-body">
            <div class="space-y-4">
                <div class="admin-form-group">
                    <label class="admin-label">Stato Progetto</label>
                    <select id="status-filter" class="admin-input admin-select">
                        <option value="">Tutti gli stati</option>
                        <option value="active">Attivo</option>
                        <option value="completed">Completato</option>
                        <option value="sold">Venduto</option>
                        <option value="cancelled">Annullato</option>
                    </select>
                </div>
                
                <div class="admin-form-group">
                    <label class="admin-label">Ricerca Testuale</label>
                    <input type="text" id="search-input" class="admin-input" 
                           placeholder="Cerca per codice, titolo o descrizione...">
                </div>
                
                <div class="admin-form-group">
                    <label class="admin-label">Ordinamento</label>
                    <select id="sort-filter" class="admin-input admin-select">
                        <option value="created_at-desc">Pi√π recenti</option>
                        <option value="created_at-asc">Pi√π vecchi</option>
                        <option value="title-asc">Nome A-Z</option>
                        <option value="title-desc">Nome Z-A</option>
                        <option value="target_amount-desc">Importo ‚Üì</option>
                        <option value="target_amount-asc">Importo ‚Üë</option>
                    </select>
                </div>
                
                <button onclick="applyFilters()" class="admin-btn admin-btn--primary w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"/>
                    </svg>
                    Applica Filtri
                </button>
                
                <button onclick="resetFilters()" class="admin-btn admin-btn--secondary w-full">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiche Progetti -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Statistiche</h2>
        </div>
        <div class="admin-card-body">
            <div class="space-y-4">
                <div id="projects-stats">
                    {% with loading_skeleton=true, loading_skeleton_lines=4 %}
                        {% include 'admin/components/loading.html' %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista Progetti -->
<div class="admin-card">
    <div class="admin-card-header">
        <div class="admin-flex admin-flex--between">
            <h2 class="admin-heading-3">Progetti Immobiliari</h2>
            <div class="admin-flex">
                <span class="admin-badge admin-badge--info" id="projects-count">0 progetti</span>
                <button onclick="refreshProjects()" class="admin-btn admin-btn--secondary admin-btn--sm ml-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <div class="admin-card-body">
        <!-- Loading State -->
        <div id="projects-loading" class="hidden">
            {% with loading_text='Caricamento progetti...', loading_size='lg' %}
                {% include 'admin/components/loading.html' %}
            {% endwith %}
        </div>
        
        <!-- Empty State -->
        <div id="projects-empty" class="hidden text-center py-12">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            <h3 class="admin-heading-3 text-gray-500">Nessun progetto trovato</h3>
            <p class="admin-text-body text-gray-400 mb-4">Non ci sono progetti che corrispondono ai filtri selezionati</p>
            <button onclick="resetFilters()" class="admin-btn admin-btn--secondary">Reset Filtri</button>
        </div>
        
        <!-- Projects Info Bar -->
        <div class="admin-card admin-card-body mb-6">
            <div class="admin-flex admin-flex--between">
                <div class="admin-flex">
                    <span class="admin-text-small text-gray-500 mr-4" id="total-projects-indicator">
                        <span id="total-projects-count">0</span> progetti totali
                    </span>
                </div>
            </div>
        </div>

        <!-- Projects Grid -->
        <div id="projects-grid" class="admin-grid admin-grid--3"></div>
        
        <!-- Pagination -->
        <div id="projects-pagination" class="mt-6 hidden">
            <div class="admin-flex admin-flex--between">
                <div class="admin-text-small text-gray-600">
                    Mostrando <span id="page-info">0-0 di 0</span> progetti
                </div>
                <div class="admin-flex" id="pagination-controls"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuovo Progetto -->
{% include 'admin/projects/create_project_modal.html' %}


<!-- Modal Annullamento Progetto -->
<div id="cancel-project-modal" class="admin-modal" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
">
    <div class="admin-modal-content" style="
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 600px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    ">
        <div class="admin-modal-header" style="
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        ">
            <h3 class="admin-heading-3" style="
                margin: 0;
                color: #dc2626;
                display: flex;
                align-items: center;
                gap: 8px;
            ">
                ‚ö†Ô∏è Annulla Progetto
            </h3>
            <p class="admin-text-small text-gray-600 mt-2">
                Questa azione restituir√† tutti i fondi investiti al capitale libero degli utenti
            </p>
        </div>
        
        <div class="admin-modal-body" style="
            max-height: 70vh;
            overflow-y: auto;
            padding: 24px;
            background: white;
        ">
            <div id="cancel-project-content">
                <div class="mb-6">
                    <h4 class="admin-heading-4 mb-4">Dettagli Progetto</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-text-small text-gray-600">Nome Progetto</label>
                                <p class="admin-text-body font-medium" id="cancel-project-name">-</p>
                            </div>
                            <div>
                                <label class="admin-text-small text-gray-600">Codice</label>
                                <p class="admin-text-body font-medium" id="cancel-project-code">-</p>
                            </div>
                            <div>
                                <label class="admin-text-small text-gray-600">Investitori</label>
                                <p class="admin-text-body font-medium" id="cancel-project-investors">-</p>
                            </div>
                            <div>
                                <label class="admin-text-small text-gray-600">Totale Investito</label>
                                <p class="admin-text-body font-medium text-green-600" id="cancel-project-total-invested">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="admin-heading-4 mb-4">Lista Investitori</h4>
                    <div id="cancel-investors-list" class="space-y-2">
                        <!-- Lista dinamica degli investitori -->
                    </div>
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <div>
                            <h5 class="admin-text-body font-medium text-red-800">Attenzione!</h5>
                            <p class="admin-text-small text-red-700 mt-1">
                                L'annullamento del progetto restituir√† tutti i fondi investiti al capitale libero degli utenti. 
                                Questa azione non pu√≤ essere annullata.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="admin-modal-footer" style="
            padding: 16px 24px 24px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        ">
            <button onclick="closeModal('cancel-project-modal')" class="admin-btn admin-btn--secondary" style="
                background: #f3f4f6;
                color: #374151;
                padding: 12px 24px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
            " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                Annulla
            </button>
            <button onclick="confirmProjectCancel()" class="admin-btn admin-btn--danger" id="confirm-cancel-btn" style="
                background: #dc2626;
                color: white;
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                üö´ Conferma Annullamento
            </button>
        </div>
    </div>
</div>

<!-- Modal Eliminazione Progetto -->
<div id="delete-project-modal" class="admin-modal" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
">
    <div class="admin-modal-content" style="
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 90%;
        max-height: 85vh;
        overflow: hidden;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    ">
        <div class="admin-modal-header" style="
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        ">
            <h3 class="admin-heading-3" style="
                margin: 0;
                color: #dc2626;
                display: flex;
                align-items: center;
                gap: 8px;
            ">
                üóëÔ∏è Elimina Progetto
            </h3>
            <p class="admin-text-small text-gray-600 mt-2">
                Questa azione eliminer√† permanentemente il progetto dal sistema
            </p>
        </div>
        
        <div class="admin-modal-body" style="
            max-height: 70vh;
            overflow-y: auto;
            padding: 24px;
            background: white;
        ">
            <div id="delete-project-content">
                <div class="mb-6">
                    <h4 class="admin-heading-4 mb-4">Dettagli Progetto</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-text-small text-gray-600">Nome Progetto</label>
                                <p class="admin-text-body font-medium" id="delete-project-name">-</p>
                            </div>
                            <div>
                                <label class="admin-text-small text-gray-600">Codice</label>
                                <p class="admin-text-body font-medium" id="delete-project-code">-</p>
                            </div>
                            <div>
                                <label class="admin-text-small text-gray-600">Status</label>
                                <p class="admin-text-body font-medium" id="delete-project-status">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <div>
                            <h5 class="admin-text-body font-medium text-red-800">Attenzione!</h5>
                            <p class="admin-text-small text-red-700 mt-1">
                                L'eliminazione del progetto rimuover√† permanentemente tutti i dati associati. 
                                Questa azione non pu√≤ essere annullata.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="admin-modal-footer" style="
            padding: 16px 24px 24px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        ">
            <button onclick="closeModal('delete-project-modal')" class="admin-btn admin-btn--secondary" style="
                background: #f3f4f6;
                color: #374151;
                padding: 12px 24px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.2s;
            " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                Annulla
            </button>
            <button onclick="confirmProjectDelete()" class="admin-btn admin-btn--danger" id="confirm-delete-btn" style="
                background: #dc2626;
                color: white;
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            " onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                üóëÔ∏è Conferma Eliminazione
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// === PROJECT SALE FUNCTIONS REMOVED ===

// === PROJECT CANCEL FUNCTIONS ===
let currentCancelProject = null;

async function cancelProject(projectId) {
    console.log('cancelProject chiamata con ID:', projectId);
    currentCancelProject = projectId;
    
    try {
        // Carica i dettagli del progetto e degli investimenti
        console.log('Caricamento dati per annullamento progetto:', projectId);
        const response = await fetch(`/admin/projects/${projectId}/cancel-data`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Response error:', errorText);
            throw new Error(`Errore HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Dati ricevuti:', data);
        displayCancelModal(data);
        openModal('cancel-project-modal');
        
    } catch (error) {
        console.error('Errore completo:', error);
        alert('Errore nel caricamento dei dati per l\'annullamento: ' + error.message);
    }
}

function displayCancelModal(data) {
    const project = data.project;
    const investments = data.investments;
    
    // Aggiorna il contenuto del modal
    document.getElementById('cancel-project-name').textContent = project.title || project.name || 'Progetto senza nome';
    document.getElementById('cancel-project-code').textContent = project.code || 'N/A';
    document.getElementById('cancel-project-investors').textContent = investments.length;
    document.getElementById('cancel-project-total-invested').textContent = '‚Ç¨' + investments.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0).toLocaleString();
    
    // Mostra la lista degli investitori
    const investorsList = document.getElementById('cancel-investors-list');
    investorsList.innerHTML = investments.map(inv => `
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded mb-2">
            <div>
                <span class="font-medium">${inv.user_name || 'N/A'}</span>
                <span class="text-sm text-gray-500 ml-2">${inv.email || ''}</span>
            </div>
            <span class="font-semibold text-green-600">‚Ç¨${parseFloat(inv.amount || 0).toLocaleString()}</span>
        </div>
    `).join('');
}

async function confirmProjectCancel() {
    if (!currentCancelProject) {
        alert('Errore: progetto non selezionato');
        return;
    }
    
    const confirmBtn = document.getElementById('confirm-cancel-btn');
    setButtonLoading(confirmBtn, true, 'Elaborando annullamento...');
    
    try {
        console.log('Iniziando annullamento progetto:', currentCancelProject);
        
        const response = await fetch('/api/admin/project-cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                project_id: currentCancelProject
            })
        });
        
        console.log('Risposta ricevuta:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Errore HTTP:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }
        
        const result = await response.json();
        console.log('Risultato JSON:', result);
        
        if (result.success) {
            // Chiudi il modal
            closeModal('cancel-project-modal');
            
            // Mostra messaggio di successo
            alert(result.message);
            
            // Ricarica i progetti
            if (typeof projectsManager !== 'undefined' && projectsManager.loadProjects) {
                await projectsManager.loadProjects();
            } else {
                window.location.reload();
            }
        } else {
            throw new Error(result.error || 'Errore sconosciuto durante l\'annullamento');
        }
        
    } catch (error) {
        console.error('Errore durante l\'annullamento:', error);
        alert('Errore di connessione durante l\'annullamento: ' + error.message);
    } finally {
        setButtonLoading(confirmBtn, false, 'Conferma Annullamento');
    }
}

// === PROJECT DELETE FUNCTIONS ===
let currentDeleteProject = null;

async function getProjectData(projectId) {
    try {
        const response = await fetch(`/admin/projects/${projectId}?format=json`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Errore nel caricamento dati progetto:', error);
        return { project: {}, investments: [] };
    }
}

async function deleteProject(projectId) {
    console.log('deleteProject chiamata con ID:', projectId);
    currentDeleteProject = projectId;
    
    try {
        // Carica i dettagli del progetto
        console.log('Caricamento dati per eliminazione progetto:', projectId);
        const response = await fetch(`/admin/projects/${projectId}?format=json`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            if (response.status === 401) {
                alert('Sessione scaduta. Ricarica la pagina e riprova.');
                window.location.reload();
                return;
            }
            const errorText = await response.text();
            console.error('Response error:', errorText);
            throw new Error(`Errore HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Dati ricevuti:', data);
        displayDeleteModal(data);
        openModal('delete-project-modal');
        
    } catch (error) {
        console.error('Errore completo:', error);
        alert('Errore nel caricamento dei dati per l\'eliminazione: ' + error.message);
    }
}

function displayDeleteModal(data) {
    const project = data.project;
    const investmentsCount = data.investments ? data.investments.length : 0;
    const fundedAmount = project.funded_amount || 0;
    
    // Aggiorna il contenuto del modal
    document.getElementById('delete-project-name').textContent = project.title || project.name || 'Progetto senza nome';
    document.getElementById('delete-project-code').textContent = project.code || 'N/A';
    
    const statusElement = document.getElementById('delete-project-status');
    
    if (investmentsCount > 0) {
        // Progetto con investimenti attivi - mostra avviso rimborsi
        statusElement.innerHTML = `${project.status || 'N/A'} <br><small style="color: #dc2626;">‚ö†Ô∏è ${investmentsCount} investimenti attivi (‚Ç¨${fundedAmount.toLocaleString()})</small>`;
    } else {
        // Progetto venduto senza investimenti attivi - mostra solo status
        statusElement.textContent = project.status || 'N/A';
    }
}

async function confirmProjectDelete() {
    if (!currentDeleteProject) {
        alert('Errore: progetto non selezionato');
        return;
    }
    
    const confirmBtn = document.getElementById('confirm-delete-btn');
    setButtonLoading(confirmBtn, true, 'Elaborando eliminazione...');
    
    try {
        console.log('Iniziando eliminazione progetto:', currentDeleteProject);
        
        const response = await fetch(`/admin/projects/${currentDeleteProject}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });
        
        console.log('Risposta ricevuta:', response.status, response.statusText);
        
        if (!response.ok) {
            if (response.status === 401) {
                alert('Sessione scaduta. Ricarica la pagina e riprova.');
                window.location.reload();
                return;
            }
            const errorText = await response.text();
            console.error('Errore HTTP:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }
        
        const result = await response.json();
        console.log('Risultato JSON:', result);
        
        if (result.deleted) {
            // Chiudi il modal
            closeModal('delete-project-modal');
            
            // Mostra messaggio di successo
            alert(result.message || 'Progetto eliminato con successo');
            
            // Ricarica i progetti
            if (typeof projectsManager !== 'undefined' && projectsManager.loadProjects) {
                await projectsManager.loadProjects();
            } else {
                window.location.reload();
            }
        } else {
            throw new Error(result.error || 'Errore sconosciuto durante l\'eliminazione');
        }
        
    } catch (error) {
        console.error('Errore durante l\'eliminazione:', error);
        alert('Errore di connessione durante l\'eliminazione: ' + error.message);
    } finally {
        setButtonLoading(confirmBtn, false, 'Conferma Eliminazione');
    }
}

// === UTILITY FUNCTIONS ===
function setButtonLoading(button, loading, text = '') {
    if (loading) {
        // Salva il testo originale se non √® gi√† salvato
        if (!button.getAttribute('data-original-text')) {
            button.setAttribute('data-original-text', button.innerHTML);
        }
        button.disabled = true;
        button.innerHTML = text || 'Caricamento...';
        button.style.opacity = '0.7';
    } else {
        button.disabled = false;
        // Usa il testo fornito o quello originale salvato
        const originalText = button.getAttribute('data-original-text');
        button.innerHTML = text || originalText || button.innerHTML;
        button.style.opacity = '1';
    }
}

// === MODAL FUNCTIONS ===
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        
        // Per i modal di annullamento, eliminazione e creazione, assicurati che siano centrati
        if (modalId === 'cancel-project-modal' || modalId === 'delete-project-modal' || modalId === 'create-project-modal') {
            const content = modal.querySelector('.admin-modal-content') || modal.querySelector('.admin-modal-container');
            if (content) {
                content.style.position = 'fixed';
                content.style.top = '50%';
                content.style.left = '50%';
                content.style.transform = 'translate(-50%, -50%)';
            }
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        // Non modificare l'overflow del body
    }
}

// Funzione openCreateProjectModal ora √® nel modal create_project_modal.html

// Funzione submitCreateProject ora √® nel modal create_project_modal.html

// Gestione Progetti Admin
class ProjectsManager {
    constructor() {
        this.projects = [];
        this.filteredProjects = [];
        this.currentPage = 1;
        this.projectsPerPage = 9;
        this.filters = {
            status: '',
            search: '',
            sort: 'created_at-desc'
        };
        
        this.init();
    }
    
    async init() {
        await this.loadProjects();
        this.updateStats();
        this.bindEvents();
        
        // Auto-refresh ogni 2 minuti
        setInterval(() => {
            this.loadProjects(false);
        }, 120000);
    }
    
    async loadProjects(showLoading = true) {
        if (showLoading) {
            document.getElementById('projects-loading').classList.remove('hidden');
            document.getElementById('projects-grid').classList.add('hidden');
        }
        
        try {
            const params = new URLSearchParams();
            if (this.filters.status) params.append('status', this.filters.status);
            
            params.append('format', 'json');
            const response = await fetch(`/admin/projects?${params.toString()}`);
            if (response.ok) {
                this.projects = await response.json();
                this.applyFilters();
                this.updateDisplay();
                this.updateStats();
            } else {
                this.showAlert('error', 'Errore nel caricamento dei progetti');
            }
        } catch (error) {
            console.error('Errore:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            if (showLoading) {
                document.getElementById('projects-loading').classList.add('hidden');
                document.getElementById('projects-grid').classList.remove('hidden');
            }
        }
    }
    
    applyFilters() {
        let filtered = [...this.projects];
        
        // Filtro per stato
        if (this.filters.status) {
            filtered = filtered.filter(p => p.status === this.filters.status);
        }
        
        // Filtro per ricerca testuale
        if (this.filters.search) {
            const search = this.filters.search.toLowerCase();
            filtered = filtered.filter(p => 
                p.code?.toLowerCase().includes(search) ||
                p.name?.toLowerCase().includes(search) ||
                p.title?.toLowerCase().includes(search) ||
                p.description?.toLowerCase().includes(search) ||
                p.address?.toLowerCase().includes(search)
            );
        }
        
        // Ordinamento personalizzato: Attivi ‚Üí Completati ‚Üí Venduti ‚Üí Annullati
        filtered.sort((a, b) => {
            // Prima ordina per status secondo la logica richiesta
            const statusOrder = {
                'active': 1,
                'completed': 2,
                'sold': 3,
                'cancelled': 4
            };
            
            const aStatusOrder = statusOrder[a.status] || 99;
            const bStatusOrder = statusOrder[b.status] || 99;
            
            if (aStatusOrder !== bStatusOrder) {
                return aStatusOrder - bStatusOrder;
            }
            
            // Se stesso status, ordina per data di creazione (pi√π recenti prima)
            const aDate = new Date(a.created_at || 0);
            const bDate = new Date(b.created_at || 0);
            return bDate - aDate;
        });
        
        this.filteredProjects = filtered;
        this.currentPage = 1;
    }
    
    updateDisplay() {
        const grid = document.getElementById('projects-grid');
        const empty = document.getElementById('projects-empty');
        const pagination = document.getElementById('projects-pagination');
        
        // Aggiorna contatore
        document.getElementById('projects-count').textContent = 
            `${this.filteredProjects.length} progetti`;
        
        if (this.filteredProjects.length === 0) {
            grid.classList.add('hidden');
            empty.classList.remove('hidden');
            pagination.classList.add('hidden');
            return;
        }
        
        empty.classList.add('hidden');
        grid.classList.remove('hidden');
        
        // Calcola paginazione
        const startIndex = (this.currentPage - 1) * this.projectsPerPage;
        const endIndex = startIndex + this.projectsPerPage;
        const pageProjects = this.filteredProjects.slice(startIndex, endIndex);
        
        // Renderizza progetti
        grid.innerHTML = pageProjects.map(project => this.renderProjectCard(project)).join('');
        
        // Aggiorna paginazione
        this.updatePagination();
    }
    
    renderProjectCard(project) {
        const statusColors = {
            active: 'blue', 
            completed: 'purple',
            sold: 'green',
            cancelled: 'red'
        };
        
        const statusLabels = {
            active: 'Attivo',
            completed: 'Completato',
            sold: 'Venduto',
            cancelled: 'Annullato'
        };
        
        const color = statusColors[project.status] || 'gray';
        const label = statusLabels[project.status] || project.status;
        
        const imgSrc = project.image_url ? `/uploads/projects/${project.image_url.split('/').pop()}` : 'https://via.placeholder.com/640x360?text=Foto+Progetto';
        const target = parseFloat(project.total_amount || 0) || 0;
        const invested = parseFloat(project.funded_amount || 0) || 0;
        const pct = target > 0 ? Math.min(100, Math.round((invested / target) * 100)) : 0;
        return `
            <div class="admin-card hover:shadow-lg transition-all duration-200">
                <div class="admin-card-body">
                    <img src="${imgSrc}" alt="foto" class="w-full h-40 object-cover rounded mb-3"/>
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="admin-heading-3">${project.title || project.name || 'Senza titolo'}</h3>
                            <p class="admin-text-caption">${project.code || 'N/A'}</p>
                        </div>
                        <span class="admin-badge admin-badge--${color}">${label}</span>
                    </div>
                    
                    ${project.address ? `
                        <p class="admin-text-small text-gray-600 mb-2">
                            üìç ${project.address}
                        </p>
                    ` : ''}
                    
                    <div class="mb-4">
                        ${project.status === 'sold' ? `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <span class="admin-text-small text-green-700">Venduto per:</span>
                                    <span class="admin-text-small font-bold text-green-800">‚Ç¨${parseFloat(project.sale_price || 0).toLocaleString()}</span>
                                </div>
                                ${project.sold_at ? `
                                    <div class="flex items-center justify-between mt-1">
                                        <span class="admin-text-small text-green-600">Data vendita:</span>
                                        <span class="admin-text-small text-green-600">${new Date(project.sold_at).toLocaleDateString('it-IT')}</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="w-full bg-gray-200 rounded h-2 mb-2">
                                <div class="bg-blue-600 h-2 rounded" style="width:${pct}%"></div>
                            </div>
                            <div class="admin-text-small text-gray-700">Raccolto: ‚Ç¨${invested.toLocaleString()} / ‚Ç¨${target.toLocaleString()} (${pct}%)</div>
                        `}
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${project.total_amount ? `
                            <div class="flex justify-between">
                                <span class="admin-text-small">Target:</span>
                                <span class="admin-text-small font-medium">‚Ç¨${parseFloat(project.total_amount).toLocaleString()}</span>
                            </div>
                        ` : ''}
                        
                        ${project.min_investment ? `
                            <div class="flex justify-between">
                                <span class="admin-text-small">Min. investimento:</span>
                                <span class="admin-text-small font-medium">‚Ç¨${parseFloat(project.min_investment).toLocaleString()}</span>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between">
                            <span class="admin-text-small">Creato:</span>
                            <span class="admin-text-small">${new Date(project.created_at).toLocaleDateString('it-IT')}</span>
                        </div>
                    </div>
                    
                    <!-- Indicatori file -->
                    <div class="flex gap-2 mb-4">
                        ${project.photo_filename ? `
                            <span class="admin-badge admin-badge--green admin-badge--sm">
                                üì∑ Foto
                            </span>
                        ` : ''}
                        ${project.documents_filename ? `
                            <span class="admin-badge admin-badge--blue admin-badge--sm">
                                üìÑ Documenti
                            </span>
                        ` : ''}
                    </div>
                    
                    <div class="admin-flex">
                        ${project.status === 'active' ? `
                            <button onclick="cancelProject(${project.id})" 
                                    class="admin-btn admin-btn--warning admin-btn--sm flex-1 mr-2">
                                ‚ö†Ô∏è Annulla
                            </button>
                        ` : project.status === 'completed' ? `
                            <button onclick="sellProject(${project.id})" 
                                    class="admin-btn admin-btn--success admin-btn--sm flex-1 mr-2">
                                üí∞ Vendita
                            </button>
                        ` : project.status === 'sold' ? `
                            <div class="flex-1 mr-2">
                                <span class="admin-text-small text-green-600 font-medium">‚úÖ Venduto</span>
                            </div>
                        ` : `
                            <div class="flex-1 mr-2"></div>
                        `}
                        <button onclick="editProject(${project.id})" 
                                class="admin-btn admin-btn--primary admin-btn--sm flex-1">
                            Modifica
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    updatePagination() {
        const pagination = document.getElementById('projects-pagination');
        const pageInfo = document.getElementById('page-info');
        const controls = document.getElementById('pagination-controls');
        
        const totalPages = Math.ceil(this.filteredProjects.length / this.projectsPerPage);
        
        if (totalPages <= 1) {
            pagination.classList.add('hidden');
            return;
        }
        
        pagination.classList.remove('hidden');
        
        const startIndex = (this.currentPage - 1) * this.projectsPerPage + 1;
        const endIndex = Math.min(this.currentPage * this.projectsPerPage, this.filteredProjects.length);
        
        pageInfo.textContent = `${startIndex}-${endIndex} di ${this.filteredProjects.length}`;
        
        // Genera controlli paginazione
        let controlsHTML = '';
        
        // Precedente
        if (this.currentPage > 1) {
            controlsHTML += `<button onclick="projectsManager.changePage(${this.currentPage - 1})" 
                                    class="admin-btn admin-btn--secondary admin-btn--sm">Precedente</button>`;
        }
        
        // Pagine
        for (let i = 1; i <= totalPages; i++) {
            if (i === this.currentPage) {
                controlsHTML += `<span class="admin-btn admin-btn--primary admin-btn--sm">${i}</span>`;
            } else if (i === 1 || i === totalPages || Math.abs(i - this.currentPage) <= 1) {
                controlsHTML += `<button onclick="projectsManager.changePage(${i})" 
                                        class="admin-btn admin-btn--secondary admin-btn--sm">${i}</button>`;
            } else if (Math.abs(i - this.currentPage) === 2) {
                controlsHTML += `<span class="admin-text-body">...</span>`;
            }
        }
        
        // Successivo
        if (this.currentPage < totalPages) {
            controlsHTML += `<button onclick="projectsManager.changePage(${this.currentPage + 1})" 
                                    class="admin-btn admin-btn--secondary admin-btn--sm">Successivo</button>`;
        }
        
        controls.innerHTML = controlsHTML;
    }
    
    changePage(page) {
        this.currentPage = page;
        this.updateDisplay();
        
        // Scroll to top
        document.getElementById('projects-grid').scrollIntoView({ behavior: 'smooth' });
    }
    
    updateStats() {
        const stats = {
            total: this.projects.length,
            active: this.projects.filter(p => p.status === 'active').length,
            completed: this.projects.filter(p => p.status === 'completed').length,
            sold: this.projects.filter(p => p.status === 'sold').length,
            cancelled: this.projects.filter(p => p.status === 'cancelled').length
        };
        
        document.getElementById('projects-stats').innerHTML = `
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="admin-text-small">Totali:</span>
                    <span class="admin-badge admin-badge--gray">${stats.total}</span>
                </div>
                <div class="flex justify-between">
                    <span class="admin-text-small">Attivi:</span>
                    <span class="admin-badge admin-badge--info">${stats.active}</span>
                </div>
                <div class="flex justify-between">
                    <span class="admin-text-small">Completati:</span>
                    <span class="admin-badge admin-badge--success">${stats.completed}</span>
                </div>
                <div class="flex justify-between">
                    <span class="admin-text-small">Venduti:</span>
                    <span class="admin-badge admin-badge--success">${stats.sold}</span>
                </div>
                <div class="flex justify-between">
                    <span class="admin-text-small">Cancellati:</span>
                    <span class="admin-badge admin-badge--error">${stats.cancelled}</span>
                </div>
            </div>
        `;
    }
    
    bindEvents() {
        // Debounce per la ricerca
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.filters.search = e.target.value.trim();
                this.applyFilters();
                this.updateDisplay();
            }, 300);
        });
        
        // Enter key per ricerca
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.filters.search = e.target.value.trim();
                this.applyFilters();
                this.updateDisplay();
            }
        });
    }
    
    showAlert(type, message) {
        const alerts = document.getElementById('projects-alerts');
        const alertId = 'alert-' + Date.now();
        
        alerts.innerHTML = `
            <div id="${alertId}" class="admin-alert admin-alert--${type} admin-fade-in">
                <div class="flex items-start">
                    <div class="flex-shrink-0 mr-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm opacity-70 hover:opacity-100">√ó</button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, 5000);
    }
}

// Funzioni globali
function applyFilters() {
    projectsManager.filters.status = document.getElementById('status-filter').value;
    projectsManager.filters.sort = document.getElementById('sort-filter').value;
    projectsManager.applyFilters();
    projectsManager.updateDisplay();
}

function resetFilters() {
    document.getElementById('status-filter').value = '';
    document.getElementById('search-input').value = '';
    document.getElementById('sort-filter').value = 'created_at-desc';
    
    projectsManager.filters = {
        status: '',
        search: '',
        sort: 'created_at-desc'
    };
    
    projectsManager.applyFilters();
    projectsManager.updateDisplay();
}

function refreshProjects() {
    projectsManager.loadProjects(true);
}

function editProject(id) {
    window.location.href = `/admin/projects/${id}`;
}

// Aggiorna il contatore progetti totali
function updateTotalProjectsCount() {
    if (projectsManager && projectsManager.projects) {
        document.getElementById('total-projects-count').textContent = projectsManager.projects.length;
    }
}

// === EXTENDED PROJECT MANAGER ===
// Estendo il ProjectsManager per supportare funzionalit√† aggiuntive
const originalUpdateDisplay = ProjectsManager.prototype.updateDisplay;
ProjectsManager.prototype.updateDisplay = function() {
    originalUpdateDisplay.call(this);
    updateTotalProjectsCount();
};

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('admin-modal-backdrop')) {
        const modal = e.target.closest('.admin-modal');
        if (modal) {
            closeModal(modal.id);
        }
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.admin-modal[style*="flex"]');
        if (openModal) {
            closeModal(openModal.id);
        }
    }
});

// Close modal when clicking outside (solo per modal con background)
document.addEventListener('click', function(e) {
    // Per il modal di annullamento, chiudi solo se si clicca sul contenitore principale
    if (e.target.id === 'cancel-project-modal') {
        closeModal('cancel-project-modal');
    }
    // Per il modal di eliminazione, chiudi solo se si clicca sul contenitore principale
    if (e.target.id === 'delete-project-modal') {
        closeModal('delete-project-modal');
    }
    // Per il modal di creazione, chiudi solo se si clicca sul contenitore principale
    if (e.target.id === 'create-project-modal') {
        closeModal('create-project-modal');
    }
});

// Funzioni globali
function sellProject(projectId) {
    // Reindirizza alla pagina di dettaglio del progetto per la vendita
    window.location.href = `/admin/projects/${projectId}`;
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    projectsManager = new ProjectsManager();
    
    // Event listener per il tasto Crea Progetto
    const createBtn = document.getElementById('create-project-btn');
    if (createBtn) {
        createBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openCreateProjectModal();
        });
    }
});
</script>
{% endblock %}