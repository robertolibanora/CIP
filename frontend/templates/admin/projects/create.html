{% extends "layouts/admin_base.html" %}

{% block title %}Wizard Nuovo Progetto - Admin CIP Immobiliare{% endblock %}





{% block content %}
<!-- Wizard Progress Header -->
<div class="admin-card admin-card-body mb-6">
    <div class="admin-flex admin-flex--between">
        <div>
            <h1 class="admin-heading-1">Wizard Nuovo Progetto</h1>
            <p class="admin-text-small">Creazione guidata progetto immobiliare</p>
    </div>
        <div class="admin-flex">
            <span class="admin-badge admin-badge--info" id="step-indicator">Step 1 di 4</span>
            <a href="{{ url_for('admin.projects_list') }}" class="admin-btn admin-btn--secondary admin-btn--sm ml-3">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
                Annulla
        </a>
    </div>
</div>
    
    <!-- Progress Bar -->
    <div class="mt-6">
        <div class="flex items-center">
            <div class="flex items-center flex-1">
                <div class="flex items-center w-full">
                    <!-- Step 1 -->
                    <div class="flex items-center">
                        <div id="step-1-circle" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">1</span>
                        </div>
                        <span class="ml-2 admin-text-small font-medium text-blue-600">Informazioni Base</span>
                    </div>
                    <div id="step-1-line" class="flex-1 h-1 bg-gray-200 mx-4"></div>
                    
                    <!-- Step 2 -->
                    <div class="flex items-center">
                        <div id="step-2-circle" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                            <span class="text-gray-500 text-sm font-medium">2</span>
                        </div>
                        <span class="ml-2 admin-text-small text-gray-500">Dettagli Finanziari</span>
                    </div>
                    <div id="step-2-line" class="flex-1 h-1 bg-gray-200 mx-4"></div>
                    
                    <!-- Step 3 -->
                    <div class="flex items-center">
                        <div id="step-3-circle" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                            <span class="text-gray-500 text-sm font-medium">3</span>
                        </div>
                        <span class="ml-2 admin-text-small text-gray-500">Documenti e Media</span>
                    </div>
                    <div id="step-3-line" class="flex-1 h-1 bg-gray-200 mx-4"></div>
                    
                    <!-- Step 4 -->
                    <div class="flex items-center">
                        <div id="step-4-circle" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                            <span class="text-gray-500 text-sm font-medium">4</span>
                        </div>
                        <span class="ml-2 admin-text-small text-gray-500">Anteprima e Conferma</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="wizard-alerts" class="mb-6"></div>

<!-- Wizard Form Container -->
<div class="admin-card">
    <form id="wizard-form" class="wizard-container">
        
        <!-- STEP 1: Informazioni Base -->
        <div id="step-1" class="wizard-step active">
            <div class="admin-card-header">
                <h2 class="admin-heading-2">Step 1: Informazioni Base</h2>
                <p class="admin-text-small">Inserisci le informazioni principali del progetto</p>
            </div>
            <div class="admin-card-body">
                <div class="space-y-6">
                    <div class="admin-grid admin-grid--2">
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Codice Progetto</label>
                            <input type="text" name="code" class="admin-input" required 
                                   placeholder="es. PROJ001" id="field-code">
                            <p class="admin-help-text">Codice univoco per identificare il progetto</p>
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Titolo Progetto</label>
                            <input type="text" name="title" class="admin-input" required 
                                   placeholder="Nome del progetto" id="field-title">
                        </div>
                    </div>
                    
                    <div class="admin-form-group">
                        <label class="admin-label admin-label--required">Descrizione</label>
                        <textarea name="description" class="admin-input admin-textarea" required rows="4"
                                  placeholder="Descrizione dettagliata del progetto immobiliare..." id="field-description"></textarea>
                        <p class="admin-help-text">Minimo 50 caratteri, massimo 2000</p>
                </div>
                
                    <div class="admin-grid admin-grid--2">
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Località</label>
                            <input type="text" name="location" class="admin-input" required 
                                   placeholder="es. Milano, Via Roma 123" id="field-location">
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Tipologia</label>
                            <select name="type" class="admin-input admin-select" required id="field-type">
                                <option value="">Seleziona tipologia</option>
                        <option value="residential">Residenziale</option>
                        <option value="commercial">Commerciale</option>
                        <option value="industrial">Industriale</option>
                        <option value="mixed">Misto</option>
                    </select>
                </div>
                </div>
                </div>
                </div>
            </div>
            
        <!-- STEP 2: Dettagli Finanziari -->
        <div id="step-2" class="wizard-step hidden">
            <div class="admin-card-header">
                <h2 class="admin-heading-2">Step 2: Dettagli Finanziari</h2>
                <p class="admin-text-small">Configura gli aspetti economici del progetto</p>
            </div>
            <div class="admin-card-body">
                <div class="space-y-6">
                    <div class="admin-grid admin-grid--2">
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Importo Target (€)</label>
                            <input type="number" name="target_amount" class="admin-input" required 
                                   min="1000" step="0.01" placeholder="100000" id="field-target_amount">
                            <p class="admin-help-text">Capitale totale da raccogliere</p>
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Investimento Minimo (€)</label>
                            <input type="number" name="min_investment" class="admin-input" required 
                                   min="100" step="0.01" placeholder="1000" id="field-min_investment">
                            <p class="admin-help-text">Importo minimo per singolo investimento</p>
            </div>
        </div>

                    <div class="admin-grid admin-grid--3">
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">ROI Atteso (%)</label>
                            <input type="number" name="roi" class="admin-input" required 
                                   min="0.1" max="99.9" step="0.1" placeholder="8.5" id="field-roi">
                            <p class="admin-help-text">Rendimento annuo atteso</p>
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Durata (mesi)</label>
                            <input type="number" name="duration" class="admin-input" required 
                                   min="1" max="120" placeholder="24" id="field-duration">
                            <p class="admin-help-text">Durata del progetto</p>
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Stato Iniziale</label>
                            <select name="status" class="admin-input admin-select" required id="field-status">
                                <option value="draft">Bozza</option>
                                <option value="funding">In Finanziamento</option>
                                <option value="active">Attivo</option>
                            </select>
                        </div>
                </div>
                
                    <div class="admin-grid admin-grid--2">
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Data Inizio</label>
                            <input type="date" name="start_date" class="admin-input" required id="field-start_date">
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label admin-label--required">Data Fine</label>
                            <input type="date" name="end_date" class="admin-input" required id="field-end_date">
                        </div>
                </div>
                
                    <!-- Preview Calcoli -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="admin-heading-3 text-blue-800">Anteprima Calcoli</h3>
                        <div class="admin-grid admin-grid--3 mt-3">
                            <div>
                                <p class="admin-text-caption text-blue-700">ROI Totale</p>
                                <p class="admin-text-body font-medium text-blue-900" id="calc-total-roi">-</p>
                            </div>
                            <div>
                                <p class="admin-text-caption text-blue-700">Rendimento per €1000</p>
                                <p class="admin-text-body font-medium text-blue-900" id="calc-yield-1000">-</p>
                            </div>
                <div>
                                <p class="admin-text-caption text-blue-700">N° Investitori Min</p>
                                <p class="admin-text-body font-medium text-blue-900" id="calc-min-investors">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 3: Documenti e Media -->
        <div id="step-3" class="wizard-step hidden">
            <div class="admin-card-header">
                <h2 class="admin-heading-2">Step 3: Documenti e Media</h2>
                <p class="admin-text-small">Carica immagini e documenti del progetto</p>
            </div>
            <div class="admin-card-body">
                <div class="space-y-6">
                    <!-- Immagine Principale -->
                    <div class="admin-form-group">
                        <label class="admin-label">Immagine Principale</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6" id="main-image-dropzone">
                            <div class="text-center" id="main-image-placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div class="mt-4">
                                    <label for="main-image" class="cursor-pointer">
                                        <span class="admin-btn admin-btn--primary admin-btn--sm">Seleziona Immagine</span>
                                        <input id="main-image" type="file" class="sr-only" accept="image/*">
                    </label>
                                </div>
                                <p class="admin-help-text mt-2">PNG, JPG fino a 10MB</p>
                            </div>
                            <div id="main-image-preview" class="hidden">
                                <img id="main-image-img" class="max-h-48 mx-auto rounded-lg" alt="Anteprima">
                                <div class="mt-2 text-center">
                                    <button type="button" onclick="removeMainImage()" class="admin-btn admin-btn--error admin-btn--sm">
                                        Rimuovi
                                    </button>
                </div>
                </div>
            </div>
        </div>

                    <!-- Galleria Immagini -->
                    <div class="admin-form-group">
                        <label class="admin-label">Galleria Immagini (opzionale)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6" id="gallery-dropzone">
                            <div class="text-center">
                                <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <div class="mt-2">
                                    <label for="gallery-images" class="cursor-pointer">
                                        <span class="admin-btn admin-btn--secondary admin-btn--sm">Aggiungi Immagini</span>
                                        <input id="gallery-images" type="file" class="sr-only" accept="image/*" multiple>
                    </label>
                                </div>
                                <p class="admin-help-text">Trascina o seleziona più immagini</p>
                            </div>
                        </div>
                        <div id="gallery-preview" class="hidden mt-4">
                            <div class="admin-grid admin-grid--4" id="gallery-grid"></div>
                        </div>
                </div>
                
                    <!-- Documenti PDF -->
                    <div class="admin-form-group">
                        <label class="admin-label">Documenti Progetto (opzionale)</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6" id="docs-dropzone">
                            <div class="text-center">
                                <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <div class="mt-2">
                                    <label for="project-docs" class="cursor-pointer">
                                        <span class="admin-btn admin-btn--secondary admin-btn--sm">Aggiungi PDF</span>
                                        <input id="project-docs" type="file" class="sr-only" accept=".pdf" multiple>
                    </label>
                                </div>
                                <p class="admin-help-text">Documenti PDF del progetto</p>
                            </div>
                        </div>
                        <div id="docs-preview" class="hidden mt-4">
                            <div class="space-y-2" id="docs-list"></div>
                        </div>
                </div>
                </div>
            </div>
        </div>

        <!-- STEP 4: Anteprima e Conferma -->
        <div id="step-4" class="wizard-step hidden">
            <div class="admin-card-header">
                <h2 class="admin-heading-2">Step 4: Anteprima e Conferma</h2>
                <p class="admin-text-small">Verifica tutti i dati prima di creare il progetto</p>
                </div>
            <div class="admin-card-body">
                <div id="project-preview" class="space-y-6">
                    <!-- Preview will be populated by JavaScript -->
                </div>
            </div>
        </div>

    </form>
    
    <!-- Wizard Navigation -->
    <div class="admin-card-footer">
        <div class="admin-flex admin-flex--between">
            <button type="button" id="prev-btn" class="admin-btn admin-btn--secondary" onclick="previousStep()" disabled>
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Precedente
            </button>
            
            <div class="admin-flex">
                <button type="button" id="next-btn" class="admin-btn admin-btn--primary" onclick="nextStep()">
                    Avanti
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
                
                <button type="button" id="submit-btn" class="admin-btn admin-btn--success hidden" onclick="submitProject()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Crea Progetto
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Project Creation Wizard Manager
class ProjectWizard {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 4;
        this.projectData = {};
        this.uploadedFiles = {
            mainImage: null,
            gallery: [],
            documents: []
        };
        
        this.init();
    }
    
    init() {
        this.updateStepDisplay();
        this.bindEvents();
        this.setDefaultDates();
        this.setupFileUploads();
    }
    
    bindEvents() {
        // Auto-generate code from title
        document.getElementById('field-title').addEventListener('input', this.generateCode.bind(this));
        
        // Financial calculations
        ['target_amount', 'min_investment', 'roi', 'duration'].forEach(field => {
            document.getElementById(`field-${field}`).addEventListener('input', this.updateCalculations.bind(this));
        });
        
        // Form validation on change
        document.querySelectorAll('.admin-input').forEach(input => {
            input.addEventListener('blur', this.validateField.bind(this));
        });
    }
    
    generateCode() {
        const title = document.getElementById('field-title').value;
        const codeField = document.getElementById('field-code');
        
        if (!codeField.value && title && title.length >= 3) {
            const code = 'PROJ' + title.substring(0, 3).toUpperCase() + Date.now().toString().slice(-3);
            codeField.value = code;
        }
    }
    
    setDefaultDates() {
        const today = new Date();
        const nextYear = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
        
        document.getElementById('field-start_date').value = today.toISOString().split('T')[0];
        document.getElementById('field-end_date').value = nextYear.toISOString().split('T')[0];
    }
    
    updateCalculations() {
        const targetAmount = parseFloat(document.getElementById('field-target_amount').value) || 0;
        const minInvestment = parseFloat(document.getElementById('field-min_investment').value) || 0;
        const roi = parseFloat(document.getElementById('field-roi').value) || 0;
        const duration = parseInt(document.getElementById('field-duration').value) || 0;
        
        if (targetAmount && roi && duration) {
            // ROI totale (annualizzato per durata)
            const totalRoi = (roi * duration / 12);
            document.getElementById('calc-total-roi').textContent = `${totalRoi.toFixed(1)}%`;
            
            // Rendimento per €1000
            const yield1000 = (1000 * totalRoi / 100);
            document.getElementById('calc-yield-1000').textContent = `€${yield1000.toFixed(0)}`;
            
            // Numero minimo investitori
            if (minInvestment > 0) {
                const minInvestors = Math.ceil(targetAmount / minInvestment);
                document.getElementById('calc-min-investors').textContent = minInvestors;
            }
        }
    }
    
    setupFileUploads() {
        // Main image upload
        document.getElementById('main-image').addEventListener('change', (e) => {
            this.handleMainImageUpload(e.target.files[0]);
        });
        
        // Gallery images upload
        document.getElementById('gallery-images').addEventListener('change', (e) => {
            this.handleGalleryUpload(Array.from(e.target.files));
        });
        
        // Documents upload
        document.getElementById('project-docs').addEventListener('change', (e) => {
            this.handleDocumentsUpload(Array.from(e.target.files));
        });
    }
    
    handleMainImageUpload(file) {
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
            this.showAlert('error', 'File troppo grande. Massimo 10MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('main-image-placeholder').classList.add('hidden');
            document.getElementById('main-image-preview').classList.remove('hidden');
            document.getElementById('main-image-img').src = e.target.result;
            this.uploadedFiles.mainImage = file;
        };
        reader.readAsDataURL(file);
    }
    
    handleGalleryUpload(files) {
        files.forEach(file => {
            if (file.size <= 10 * 1024 * 1024) {
                this.uploadedFiles.gallery.push(file);
                this.addGalleryPreview(file);
            }
        });
        
        if (this.uploadedFiles.gallery.length > 0) {
            document.getElementById('gallery-preview').classList.remove('hidden');
        }
    }
    
    addGalleryPreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const grid = document.getElementById('gallery-grid');
            const div = document.createElement('div');
            div.className = 'relative';
            div.innerHTML = `
                <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg">
                <button type="button" onclick="removeGalleryImage(this)" 
                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                    ×
                </button>
            `;
            grid.appendChild(div);
        };
        reader.readAsDataURL(file);
    }
    
    handleDocumentsUpload(files) {
        files.forEach(file => {
            if (file.type === 'application/pdf' && file.size <= 10 * 1024 * 1024) {
                this.uploadedFiles.documents.push(file);
                this.addDocumentPreview(file);
            }
        });
        
        if (this.uploadedFiles.documents.length > 0) {
            document.getElementById('docs-preview').classList.remove('hidden');
        }
    }
    
    addDocumentPreview(file) {
        const list = document.getElementById('docs-list');
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
        div.innerHTML = `
            <div class="flex items-center">
                <svg class="w-6 h-6 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <div>
                    <p class="admin-text-body">${file.name}</p>
                    <p class="admin-text-caption">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            </div>
            <button type="button" onclick="removeDocument(this)" class="admin-btn admin-btn--error admin-btn--sm">
                Rimuovi
            </button>
        `;
        list.appendChild(div);
    }
    
    validateStep(step) {
        let isValid = true;
        const requiredFields = this.getRequiredFieldsForStep(step);
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                this.markFieldInvalid(field);
                isValid = false;
            } else {
                this.markFieldValid(field);
            }
        });
        
        // Validazioni specifiche per step
        if (step === 1) {
            const description = document.getElementById('field-description').value;
            if (description.length < 50) {
                this.showAlert('error', 'La descrizione deve essere di almeno 50 caratteri');
                isValid = false;
            }
        }
        
        if (step === 2) {
            const targetAmount = parseFloat(document.getElementById('field-target_amount').value);
            const minInvestment = parseFloat(document.getElementById('field-min_investment').value);
            
            if (minInvestment >= targetAmount) {
                this.showAlert('error', 'L\'investimento minimo deve essere inferiore al target');
                isValid = false;
            }
        }
        
        return isValid;
    }
    
    getRequiredFieldsForStep(step) {
        const fields = {
            1: ['field-code', 'field-title', 'field-description', 'field-location', 'field-type'],
            2: ['field-target_amount', 'field-min_investment', 'field-roi', 'field-duration', 'field-status', 'field-start_date', 'field-end_date'],
            3: [], // No required fields in step 3
            4: []  // No fields in step 4
        };
        return fields[step] || [];
    }
    
    markFieldInvalid(field) {
        field.classList.add('admin-input--error');
        field.classList.remove('admin-input--success');
    }
    
    markFieldValid(field) {
        field.classList.remove('admin-input--error');
        field.classList.add('admin-input--success');
    }
    
    validateField(e) {
        const field = e.target;
        if (field.value.trim()) {
            this.markFieldValid(field);
        }
    }
    
    nextStep() {
        if (!this.validateStep(this.currentStep)) {
            return;
        }
        
        if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.updateStepDisplay();
            
            if (this.currentStep === 4) {
                this.generatePreview();
            }
        }
    }
    
    previousStep() {
        if (this.currentStep > 1) {
            this.currentStep--;
            this.updateStepDisplay();
        }
    }
    
    updateStepDisplay() {
        // Hide all steps
        for (let i = 1; i <= this.totalSteps; i++) {
            document.getElementById(`step-${i}`).classList.add('hidden');
            
            // Update progress bar
            const circle = document.getElementById(`step-${i}-circle`);
            const line = document.getElementById(`step-${i}-line`);
            
            if (i < this.currentStep) {
                // Completed step
                circle.className = 'w-8 h-8 bg-green-600 rounded-full flex items-center justify-center';
                circle.innerHTML = '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                if (line) line.className = 'flex-1 h-1 bg-green-600 mx-4';
            } else if (i === this.currentStep) {
                // Current step
                circle.className = 'w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center';
                circle.innerHTML = `<span class="text-white text-sm font-medium">${i}</span>`;
                if (line) line.className = 'flex-1 h-1 bg-gray-200 mx-4';
            } else {
                // Future step
                circle.className = 'w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center';
                circle.innerHTML = `<span class="text-gray-500 text-sm font-medium">${i}</span>`;
                if (line) line.className = 'flex-1 h-1 bg-gray-200 mx-4';
            }
        }
        
        // Show current step
        document.getElementById(`step-${this.currentStep}`).classList.remove('hidden');
        
        // Update step indicator
        document.getElementById('step-indicator').textContent = `Step ${this.currentStep} di ${this.totalSteps}`;
        
        // Update navigation buttons
        document.getElementById('prev-btn').disabled = this.currentStep === 1;
        
        if (this.currentStep === this.totalSteps) {
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('submit-btn').classList.remove('hidden');
        } else {
            document.getElementById('next-btn').classList.remove('hidden');
            document.getElementById('submit-btn').classList.add('hidden');
        }
    }
    
    generatePreview() {
        const formData = new FormData(document.getElementById('wizard-form'));
        const data = Object.fromEntries(formData);
        
        const preview = document.getElementById('project-preview');
        preview.innerHTML = `
            <!-- Project Header Preview -->
            <div class="admin-card admin-card--info mb-6">
                <div class="admin-card-body">
                    <div class="admin-flex admin-flex--between">
                        <div>
                            <h2 class="admin-heading-2">${data.title || 'Titolo non inserito'}</h2>
                            <p class="admin-text-body text-gray-600">${data.code || 'Codice non generato'}</p>
                            <span class="admin-badge admin-badge--${this.getStatusColor(data.status)} mt-2">
                                ${this.getStatusLabel(data.status)}
                            </span>
                        </div>
                        <div class="text-right">
                            <p class="admin-text-large font-bold text-green-600">€${parseInt(data.target_amount || 0).toLocaleString()}</p>
                            <p class="admin-text-small text-gray-500">Target finanziamento</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Project Details Grid -->
            <div class="admin-grid admin-grid--2 mb-6">
                <!-- Basic Information -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-heading-3">Informazioni Base</h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="space-y-3">
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Località:</span>
                                <span class="admin-text-small font-medium">${data.location || 'Non specificata'}</span>
                            </div>
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Tipologia:</span>
                                <span class="admin-text-small font-medium">${data.type || 'Non specificata'}</span>
                            </div>
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Data inizio:</span>
                                <span class="admin-text-small font-medium">${data.start_date || 'Non specificata'}</span>
                            </div>
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Data fine:</span>
                                <span class="admin-text-small font-medium">${data.end_date || 'Non specificata'}</span>
                            </div>
                        </div>
                        
                        ${data.description ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="admin-text-small font-medium text-gray-700 mb-2">Descrizione:</h4>
                                <p class="admin-text-small text-gray-600">${data.description}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Financial Details -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-heading-3">Dettagli Finanziari</h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="space-y-3">
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Target:</span>
                                <span class="admin-text-small font-bold text-green-600">€${parseInt(data.target_amount || 0).toLocaleString()}</span>
                            </div>
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Min. investimento:</span>
                                <span class="admin-text-small font-medium">€${parseInt(data.min_investment || 0).toLocaleString()}</span>
                            </div>
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">ROI annuo:</span>
                                <span class="admin-text-small font-bold text-blue-600">${data.roi || 0}%</span>
                            </div>
                            <div class="admin-flex admin-flex--between">
                                <span class="admin-text-small text-gray-600">Durata:</span>
                                <span class="admin-text-small font-medium">${data.duration || 0} mesi</span>
                            </div>
                        </div>
                        
                        <!-- Calculated Metrics -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h4 class="admin-text-small font-medium text-gray-700 mb-3">Metriche Calcolate:</h4>
                            <div class="admin-grid admin-grid--3 text-center">
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <p class="admin-text-large font-bold text-blue-600">${this.calculateTotalROI(data)}%</p>
                                    <p class="admin-text-caption text-blue-500">ROI Totale</p>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <p class="admin-text-large font-bold text-green-600">€${this.calculateYield1000(data)}</p>
                                    <p class="admin-text-caption text-green-500">Resa €1000</p>
                                </div>
                                <div class="p-3 bg-orange-50 rounded-lg">
                                    <p class="admin-text-large font-bold text-orange-600">${this.calculateMinInvestors(data)}</p>
                                    <p class="admin-text-caption text-orange-500">Min Investitori</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Media Preview -->
            ${this.renderMediaPreview()}
            
            <!-- Documents Preview -->
            ${this.renderDocumentsPreview()}
            
            <!-- Project Card Preview -->
            <div class="admin-card mb-6">
                <div class="admin-card-header">
                    <h3 class="admin-heading-3">Anteprima Card Progetto</h3>
                    <p class="admin-text-small">Come apparirà agli utenti nella lista progetti</p>
                </div>
                <div class="admin-card-body">
                    <div class="max-w-md mx-auto">
                        ${this.renderProjectCardPreview(data)}
                    </div>
                </div>
            </div>
            
            <!-- Validation Summary -->
            <div class="admin-card admin-card--${this.getValidationSummaryColor()}">
                <div class="admin-card-body">
                    <h3 class="admin-heading-3 mb-4">Riepilogo Validazione</h3>
                    <div id="validation-summary">
                        ${this.generateValidationSummary(data)}
                    </div>
                </div>
            </div>
        `;
    }
    
    async submitProject() {
        const submitBtn = document.getElementById('submit-btn');
        setButtonLoading(submitBtn, true, 'Creando...');
        
        try {
            // Prepare form data
            const formData = new FormData(document.getElementById('wizard-form'));
            
            // Add files
            if (this.uploadedFiles.mainImage) {
                formData.append('main_image', this.uploadedFiles.mainImage);
            }
            
            this.uploadedFiles.gallery.forEach((file, index) => {
                formData.append(`gallery_${index}`, file);
            });
            
            this.uploadedFiles.documents.forEach((file, index) => {
                formData.append(`document_${index}`, file);
            });
            
            // Convert to JSON (excluding files for basic project creation)
            const projectData = {};
            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('gallery_') && !key.startsWith('document_') && key !== 'main_image') {
                    projectData[key] = value;
                }
            }
            
            const response = await fetch('/admin/projects/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showAlert('success', `Progetto "${projectData.title}" creato con successo!`);
                
                // TODO: Upload files to the created project
                
                setTimeout(() => {
                    window.location.href = '/admin/projects';
                }, 2000);
            } else {
                this.showAlert('error', result.error || 'Errore nella creazione del progetto');
            }
        } catch (error) {
            console.error('Errore:', error);
            this.showAlert('error', 'Errore di connessione');
        } finally {
            setButtonLoading(submitBtn, false);
        }
    }
    
    showAlert(type, message) {
        const container = document.getElementById('wizard-alerts');
        const alertId = 'alert-' + Date.now();
        
        container.innerHTML = `
            <div id="${alertId}" class="admin-alert admin-alert--${type} admin-fade-in">
                <div class="flex items-start">
                    <div class="flex-1">
                        <p class="text-sm">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${alertId}').remove()" class="ml-3 text-sm opacity-70 hover:opacity-100">×</button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, 5000);
    }
    
    // Preview helper functions
    calculateTotalROI(data) {
        const roi = parseFloat(data.roi) || 0;
        const duration = parseInt(data.duration) || 0;
        return duration > 0 ? (roi * duration / 12).toFixed(1) : '0.0';
    }
    
    calculateYield1000(data) {
        const totalRoi = this.calculateTotalROI(data);
        return (1000 * parseFloat(totalRoi) / 100).toFixed(0);
    }
    
    calculateMinInvestors(data) {
        const target = parseFloat(data.target_amount) || 0;
        const min = parseFloat(data.min_investment) || 0;
        return min > 0 ? Math.ceil(target / min) : 0;
    }
    
    renderMediaPreview() {
        if (!this.uploadedFiles.mainImage && this.uploadedFiles.gallery.length === 0) {
            return '';
        }
        
        return `
            <div class="admin-card mb-6">
                <div class="admin-card-header">
                    <h3 class="admin-heading-3">Media Caricati</h3>
                </div>
                <div class="admin-card-body">
                    ${this.uploadedFiles.mainImage ? `
                        <div class="mb-4">
                            <h4 class="admin-text-small font-medium mb-2">Immagine Principale:</h4>
                            <div class="w-32 h-32 rounded-lg overflow-hidden">
                                <img src="${this.uploadedFiles.mainImage.preview}" alt="Immagine principale" class="w-full h-full object-cover">
                            </div>
                        </div>
                    ` : ''}
                    
                    ${this.uploadedFiles.gallery.length > 0 ? `
                        <div>
                            <h4 class="admin-text-small font-medium mb-2">Galleria (${this.uploadedFiles.gallery.length} immagini):</h4>
                            <div class="admin-grid admin-grid--6">
                                ${this.uploadedFiles.gallery.map(img => `
                                    <div class="w-16 h-16 rounded overflow-hidden">
                                        <img src="${img.preview}" alt="Galleria" class="w-full h-full object-cover">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    renderDocumentsPreview() {
        if (this.uploadedFiles.documents.length === 0) {
            return '';
        }
        
        return `
            <div class="admin-card mb-6">
                <div class="admin-card-header">
                    <h3 class="admin-heading-3">Documenti Caricati</h3>
                </div>
                <div class="admin-card-body">
                    <div class="space-y-2">
                        ${this.uploadedFiles.documents.map(doc => `
                            <div class="admin-flex admin-flex--between p-3 bg-gray-50 rounded-lg">
                                <div class="admin-flex admin-flex--center">
                                    <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span class="admin-text-small font-medium">${doc.name}</span>
                                </div>
                                <span class="admin-text-caption text-gray-500">${this.formatFileSize(doc.size)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    renderProjectCardPreview(data) {
        return `
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                <div class="relative">
                    ${this.uploadedFiles.mainImage ? `
                        <img src="${this.uploadedFiles.mainImage.preview}" alt="Progetto" class="w-full h-48 object-cover">
                    ` : `
                        <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    `}
                    <div class="absolute top-2 right-2">
                        <span class="admin-badge admin-badge--${this.getStatusColor(data.status)}">
                            ${this.getStatusLabel(data.status)}
                        </span>
                    </div>
                </div>
                
                <div class="p-4">
                    <h3 class="admin-text-body font-bold mb-2">${data.title || 'Titolo Progetto'}</h3>
                    <p class="admin-text-small text-gray-600 mb-3">${data.location || 'Località'} • ${data.type || 'Tipologia'}</p>
                    
                    <div class="space-y-2 mb-4">
                        <div class="admin-flex admin-flex--between">
                            <span class="admin-text-caption">Target:</span>
                            <span class="admin-text-caption font-medium">€${parseInt(data.target_amount || 0).toLocaleString()}</span>
                        </div>
                        <div class="admin-flex admin-flex--between">
                            <span class="admin-text-caption">Min. investimento:</span>
                            <span class="admin-text-caption font-medium">€${parseInt(data.min_investment || 0).toLocaleString()}</span>
                        </div>
                        <div class="admin-flex admin-flex--between">
                            <span class="admin-text-caption">ROI:</span>
                            <span class="admin-text-caption font-bold text-green-600">${data.roi || 0}% annuo</span>
                        </div>
                        <div class="admin-flex admin-flex--between">
                            <span class="admin-text-caption">Durata:</span>
                            <span class="admin-text-caption font-medium">${data.duration || 0} mesi</span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="admin-flex admin-flex--between mb-1">
                            <span class="admin-text-caption">Finanziamento</span>
                            <span class="admin-text-caption">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="admin-flex admin-flex--between">
                        <button class="admin-btn admin-btn--primary admin-btn--sm flex-1 mr-2">
                            Investi Ora
                        </button>
                        <button class="admin-btn admin-btn--secondary admin-btn--sm">
                            Dettagli
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    generateValidationSummary(data) {
        const validations = [];
        
        // Required fields validation
        if (!data.code) validations.push({ type: 'error', message: 'Codice progetto mancante' });
        if (!data.title) validations.push({ type: 'error', message: 'Titolo progetto mancante' });
        if (!data.description) validations.push({ type: 'error', message: 'Descrizione progetto mancante' });
        if (!data.location) validations.push({ type: 'warning', message: 'Località non specificata' });
        if (!data.type) validations.push({ type: 'warning', message: 'Tipologia non specificata' });
        
        // Financial validation
        if (!data.target_amount || parseFloat(data.target_amount) <= 0) {
            validations.push({ type: 'error', message: 'Target amount deve essere maggiore di 0' });
        }
        if (!data.min_investment || parseFloat(data.min_investment) <= 0) {
            validations.push({ type: 'error', message: 'Investimento minimo deve essere maggiore di 0' });
        }
        if (!data.roi || parseFloat(data.roi) <= 0) {
            validations.push({ type: 'error', message: 'ROI deve essere maggiore di 0' });
        }
        if (!data.duration || parseInt(data.duration) <= 0) {
            validations.push({ type: 'error', message: 'Durata deve essere maggiore di 0 mesi' });
        }
        
        // Business logic validation
        if (data.min_investment && data.target_amount && parseFloat(data.min_investment) > parseFloat(data.target_amount)) {
            validations.push({ type: 'error', message: 'Investimento minimo non può essere maggiore del target' });
        }
        
        if (data.description && data.description.length < 50) {
            validations.push({ type: 'warning', message: 'Descrizione molto breve (consigliato almeno 50 caratteri)' });
        }
        
        // Media validation
        if (!this.uploadedFiles.mainImage) {
            validations.push({ type: 'warning', message: 'Nessuna immagine principale caricata' });
        }
        
        if (this.uploadedFiles.gallery.length === 0) {
            validations.push({ type: 'info', message: 'Nessuna immagine galleria caricata' });
        }
        
        if (this.uploadedFiles.documents.length === 0) {
            validations.push({ type: 'info', message: 'Nessun documento PDF caricato' });
        }
        
        // Generate summary HTML
        if (validations.length === 0) {
            return `
                <div class="admin-flex admin-flex--center text-green-600">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="admin-text-body font-medium">Tutti i controlli superati! Il progetto è pronto per la creazione.</span>
                </div>
            `;
        }
        
        const errors = validations.filter(v => v.type === 'error');
        const warnings = validations.filter(v => v.type === 'warning');
        const infos = validations.filter(v => v.type === 'info');
        
        return `
            <div class="space-y-3">
                ${errors.length > 0 ? `
                    <div class="space-y-2">
                        <h4 class="admin-text-small font-medium text-red-600">🚨 Errori da correggere (${errors.length}):</h4>
                        ${errors.map(error => `
                            <div class="admin-flex admin-flex--start">
                                <svg class="w-4 h-4 text-red-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                                </svg>
                                <span class="admin-text-small text-red-600">${error.message}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${warnings.length > 0 ? `
                    <div class="space-y-2">
                        <h4 class="admin-text-small font-medium text-orange-600">⚠️ Avvisi (${warnings.length}):</h4>
                        ${warnings.map(warning => `
                            <div class="admin-flex admin-flex--start">
                                <svg class="w-4 h-4 text-orange-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                                <span class="admin-text-small text-orange-600">${warning.message}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${infos.length > 0 ? `
                    <div class="space-y-2">
                        <h4 class="admin-text-small font-medium text-blue-600">ℹ️ Informazioni (${infos.length}):</h4>
                        ${infos.map(info => `
                            <div class="admin-flex admin-flex--start">
                                <svg class="w-4 h-4 text-blue-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="admin-text-small text-blue-600">${info.message}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${errors.length === 0 ? `
                    <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="admin-flex admin-flex--center text-green-600">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span class="admin-text-body font-medium">Il progetto può essere creato!</span>
                        </div>
                    </div>
                ` : `
                    <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="admin-flex admin-flex--center text-red-600">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                            </svg>
                            <span class="admin-text-body font-medium">Correggi gli errori prima di procedere</span>
                        </div>
                    </div>
                `}
            </div>
        `;
    }
    
    getValidationSummaryColor() {
        const data = Object.fromEntries(new FormData(document.getElementById('wizard-form')));
        const hasErrors = !data.code || !data.title || !data.description || 
                         !data.target_amount || parseFloat(data.target_amount) <= 0 ||
                         !data.min_investment || parseFloat(data.min_investment) <= 0 ||
                         !data.roi || parseFloat(data.roi) <= 0 ||
                         !data.duration || parseInt(data.duration) <= 0;
        
        return hasErrors ? 'error' : 'success';
    }
    
    getStatusColor(status) {
        const colors = {
            'draft': 'gray',
            'active': 'success',
            'funded': 'info',
            'completed': 'success',
            'cancelled': 'error'
        };
        return colors[status] || 'gray';
    }
    
    getStatusLabel(status) {
        const labels = {
            'draft': 'Bozza',
            'active': 'Attivo',
            'funded': 'Finanziato',
            'completed': 'Completato',
            'cancelled': 'Annullato'
        };
        return labels[status] || status;
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
}

// Global functions
let projectWizard;

function nextStep() {
    projectWizard.nextStep();
}

function previousStep() {
    projectWizard.previousStep();
}

function submitProject() {
    projectWizard.submitProject();
}

function removeMainImage() {
    document.getElementById('main-image-placeholder').classList.remove('hidden');
    document.getElementById('main-image-preview').classList.add('hidden');
    document.getElementById('main-image').value = '';
    projectWizard.uploadedFiles.mainImage = null;
}

function removeGalleryImage(button) {
    const index = Array.from(button.parentElement.parentElement.children).indexOf(button.parentElement);
    projectWizard.uploadedFiles.gallery.splice(index, 1);
    button.parentElement.remove();
    
    if (projectWizard.uploadedFiles.gallery.length === 0) {
        document.getElementById('gallery-preview').classList.add('hidden');
    }
}

function removeDocument(button) {
    const index = Array.from(button.parentElement.parentElement.children).indexOf(button.parentElement);
    projectWizard.uploadedFiles.documents.splice(index, 1);
    button.parentElement.remove();
    
    if (projectWizard.uploadedFiles.documents.length === 0) {
        document.getElementById('docs-preview').classList.add('hidden');
    }
}

// Initialize wizard
document.addEventListener('DOMContentLoaded', function() {
    projectWizard = new ProjectWizard();
});
</script>
{% endblock %}
{% endblock %}
{% endblock %}