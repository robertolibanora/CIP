{% extends "layouts/admin_base.html" %}

{% block title %}Configurazione IBAN - Admin{% endblock %}





{% block content %}
<!-- Dashboard Configurazione IBAN -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div>
                <h1 class="admin-heading-1">Configurazione IBAN Sistema</h1>
                <p class="admin-text-small">Gestisci l'IBAN per le ricariche degli utenti</p>
            </div>
            <!-- Status Badge -->
            <div class="mt-3 sm:mt-0">
                <div class="admin-badge admin-badge--info">
                    <div class="w-2 h-2 bg-blue-400 rounded-full mr-2"></div>
                    Configurazione IBAN
                </div>
            </div>
        </div>
    </div>

    <!-- Configurazione Corrente -->
    {% if current_config %}
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">IBAN Attualmente Attivo</h2>
        </div>
        <div class="admin-card-body">
            <div class="admin-grid admin-grid--3">
                <div>
                    <label class="admin-label">IBAN</label>
                    <p class="admin-text-body font-mono">{{ current_config.iban }}</p>
                </div>
                <div>
                    <label class="admin-label">Banca</label>
                    <p class="admin-text-body">{{ current_config.bank_name or 'N/A' }}</p>
                </div>
                <div>
                    <label class="admin-label">Intestatario</label>
                    <p class="admin-text-body">{{ current_config.account_holder or 'N/A' }}</p>
                </div>
            </div>
            <div class="mt-4">
                <label class="admin-label">Note</label>
                <p class="admin-text-body">{{ current_config.notes or 'Nessuna nota' }}</p>
            </div>
            <div class="mt-4 text-sm text-gray-500">
                <p>Attivato il: {{ current_config.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                {% if current_config.updated_at %}
                <p>Ultimo aggiornamento: {{ current_config.updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Nessuna Configurazione -->
    <div class="admin-card admin-card-body">
        <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
            </svg>
            <h3 class="admin-heading-3 mt-2">Nessuna configurazione IBAN</h3>
            <p class="admin-text-small text-gray-500 mt-1">
                Non è stata ancora configurata un'IBAN per le ricariche.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Form Nuova Configurazione -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Nuova Configurazione IBAN</h2>
        </div>
        <div class="admin-card-body">
            <form id="iban-config-form" class="space-y-4">
                <div class="admin-grid admin-grid--2">
                    <div>
                        <label for="iban" class="admin-label">IBAN *</label>
                        <input type="text" id="iban" name="iban" required 
                               class="admin-input" placeholder="IT60 X054 2811 1010 0000 0123 456"
                               pattern="[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}"
                               title="Formato IBAN valido (es. IT60 X054 2811 1010 0000 0123 456)">
                        <p class="admin-text-small text-gray-500 mt-1">Formato: IT60 X054 2811 1010 0000 0123 456</p>
                    </div>
                    <div>
                        <label for="bank_name" class="admin-label">Nome Banca</label>
                        <input type="text" id="bank_name" name="bank_name" 
                               class="admin-input" placeholder="Banca Popolare di Milano">
                    </div>
                </div>
                
                <div class="admin-grid admin-grid--2">
                    <div>
                        <label for="account_holder" class="admin-label">Intestatario Conto</label>
                        <input type="text" id="account_holder" name="account_holder" 
                               class="admin-input" placeholder="CIP Immobiliare SRL">
                    </div>
                    <div>
                        <label for="notes" class="admin-label">Note</label>
                        <input type="text" id="notes" name="notes" 
                               class="admin-input" placeholder="Note opzionali">
                    </div>
                </div>

                <div class="admin-flex admin-flex--gap-2 pt-4">
                    <button type="submit" class="admin-btn admin-btn--primary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Salva Configurazione
                    </button>
                    <button type="button" onclick="resetForm()" class="admin-btn admin-btn--secondary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Storico Configurazioni -->
    {% if iban_configs %}
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Storico Configurazioni</h2>
        </div>
        <div class="admin-card-body">
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table-th">IBAN</th>
                            <th class="admin-table-th">Banca</th>
                            <th class="admin-table-th">Stato</th>
                            <th class="admin-table-th">Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for config in iban_configs %}
                        <tr class="admin-table-tr">
                            <td class="admin-table-td">
                                <div class="admin-text-body font-mono">{{ config.iban }}</div>
                            </td>
                            <td class="admin-table-td">
                                <div class="admin-text-body">{{ config.bank_name or 'N/A' }}</div>
                            </td>
                            <td class="admin-table-td">
                                {% if config.is_active %}
                                    <span class="admin-badge admin-badge--success">Attivo</span>
                                {% else %}
                                    <span class="admin-badge admin-badge--secondary">Inattivo</span>
                                {% endif %}
                            </td>
                            <td class="admin-table-td">
                                <div class="admin-text-body">{{ config.created_at.strftime('%d/%m/%Y') }}</div>
                                <div class="admin-text-small text-gray-500">{{ config.created_at.strftime('%H:%M') }}</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Modal -->
{% with modal_id="loading-modal", modal_title="Caricamento..." %}
    {% include 'admin/components/loading.html' %}
{% endwith %}

<!-- Success/Error Alerts -->
{% with alert_id="success-alert", alert_type="success", alert_message="Configurazione salvata con successo!" %}
    {% include 'admin/components/alert.html' %}
{% endwith %}

{% with alert_id="error-alert", alert_type="error", alert_message="Si è verificato un errore!" %}
    {% include 'admin/components/alert.html' %}
{% endwith %}

<script>
// Gestione form configurazione IBAN
document.getElementById('iban-config-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        iban: formData.get('iban'),
        bank_name: formData.get('bank_name'),
        account_holder: formData.get('account_holder'),
        notes: formData.get('notes')
    };
    
    try {
        showLoading();
        const response = await fetch('/admin/api/iban-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showSuccess('Configurazione IBAN salvata con successo!');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Errore nel salvataggio');
        }
    } catch (error) {
        console.error('Errore salvataggio:', error);
        showError(error.message || 'Errore nel salvataggio della configurazione');
    } finally {
        hideLoading();
    }
});

// Reset form
function resetForm() {
    document.getElementById('iban-config-form').reset();
}

// Utility functions
function showLoading() {
    document.getElementById('loading-modal').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-modal').classList.add('hidden');
}

function showSuccess(message) {
    const alert = document.getElementById('success-alert');
    alert.querySelector('.admin-alert-message').textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 5000);
}

function showError(message) {
    const alert = document.getElementById('error-alert');
    alert.querySelector('.admin-alert-message').textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 5000);
}
</script>
{% endblock %}
