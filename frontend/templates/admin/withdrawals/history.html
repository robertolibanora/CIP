{% extends "layouts/admin_base.html" %}

{% block title %}Storico Prelievi - Admin{% endblock %}

{% block content %}
<!-- Dashboard Storico Prelievi -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div>
                <h1 class="admin-heading-1">Storico Prelievi</h1>
                <p class="admin-text-small">Visualizza tutti i prelievi processati nel sistema</p>
            </div>
            <div class="admin-flex admin-flex--gap-2">
                <a href="/admin/withdrawals" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Torna ai Prelievi
                </a>
                <button id="delete-history-btn" class="admin-btn admin-btn--error">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Elimina Storico
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiche -->
    <div class="admin-grid admin-grid--4">
        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Totale Prelievi</p>
                    <p class="admin-heading-2 text-blue-600" id="total-count">-</p>
                </div>
                <div class="admin-icon admin-icon--info">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Completati</p>
                    <p class="admin-heading-2 text-green-600" id="completed-count">-</p>
                </div>
                <div class="admin-icon admin-icon--success">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Rifiutati</p>
                    <p class="admin-heading-2 text-red-600" id="rejected-count">-</p>
                </div>
                <div class="admin-icon admin-icon--error">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Importo Totale</p>
                    <p class="admin-heading-2 text-blue-600" id="total-amount">-</p>
                </div>
                <div class="admin-icon admin-icon--info">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtri -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div class="admin-flex admin-flex--gap-4">
                <div>
                    <label for="status-filter" class="admin-label">Stato</label>
                    <select id="status-filter" class="admin-select" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="pending">In attesa</option>
                        <option value="completed">Completati</option>
                        <option value="cancelled">Rifiutati</option>
                    </select>
                </div>
                
                <div>
                    <label for="method-filter" class="admin-label">Metodo</label>
                    <select id="method-filter" class="admin-select" onchange="applyFilters()">
                        <option value="">Tutti i metodi</option>
                        <option value="usdt">USDT (BEP20)</option>
                        <option value="bank">Bonifico Bancario</option>
                    </select>
                </div>
                
                <div>
                    <label for="search-filter" class="admin-label">Ricerca</label>
                    <input type="text" id="search-filter" class="admin-input" placeholder="Nome, email..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <div class="admin-flex admin-flex--gap-2">
                <button onclick="refreshHistory()" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Aggiorna
                </button>
            </div>
        </div>
    </div>

    <!-- Lista Storico -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Storico Prelievi</h2>
            <span class="admin-text-small text-gray-500" id="history-count">0 prelievi trovati</span>
        </div>

        <div class="admin-card-body">
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table-th">Utente</th>
                            <th class="admin-table-th">Importo</th>
                            <th class="admin-table-th">Metodo</th>
                            <th class="admin-table-th">Sezione</th>
                            <th class="admin-table-th">Stato</th>
                            <th class="admin-table-th">Data</th>
                            <th class="admin-table-th">Processato da</th>
                            <th class="admin-table-th">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <tr>
                            <td colspan="8" class="admin-table-td text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="text-gray-500 mt-2">Caricamento storico...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Paginazione -->
        <div class="admin-card-footer">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div class="admin-text-small text-gray-500" id="pagination-info">
                    Caricamento...
                </div>
                <div class="admin-flex admin-flex--gap-2" id="pagination-controls">
                    <!-- Paginazione verrà inserita qui dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay" onclick="hideDeleteModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 class="admin-heading-3">⚠️ Conferma Eliminazione</h3>
            <button onclick="hideDeleteModal()" class="admin-modal-close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="admin-modal-body">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Attenzione: Azione Irreversibile</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>Stai per eliminare <strong>TUTTI</strong> i prelievi dal database. Questa azione:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                <li>Eliminerà tutti i record di prelievi</li>
                                <li>Eliminerà tutte le transazioni correlate</li>
                                <li>Non influenzerà i saldi degli utenti</li>
                                <li><strong>NON PUÒ ESSERE ANNULLATA</strong></p>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="text-gray-700 mb-4">
                Sei sicuro di voler procedere con l'eliminazione di tutto lo storico prelievi?
            </p>
            
            <div class="admin-flex admin-flex--gap-2">
                <button onclick="deleteAllWithdrawals()" class="admin-btn admin-btn--error">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Sì, Elimina Tutto
                </button>
                <button onclick="hideDeleteModal()" class="admin-btn admin-btn--secondary">
                    Annulla
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-body text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Caricamento...</p>
        </div>
    </div>
</div>

<!-- Success/Error Alerts -->
<div id="success-alert" class="admin-alert admin-alert--success hidden">
    <div class="admin-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
    </div>
    <div class="admin-alert-content">
        <h4 class="admin-alert-title">Successo!</h4>
        <p class="admin-alert-message">Operazione completata con successo!</p>
    </div>
</div>

<div id="error-alert" class="admin-alert admin-alert--error hidden">
    <div class="admin-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </div>
    <div class="admin-alert-content">
        <h4 class="admin-alert-title">Errore!</h4>
        <p class="admin-alert-message">Si è verificato un errore!</p>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
let totalPages = 1;
let currentWithdrawals = [];
let currentFilters = {
    status: '',
    method: '',
    search: ''
};

// Load history on page load
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
    
    // Event listener for delete button
    document.getElementById('delete-history-btn').addEventListener('click', showDeleteModal);
});

// Load withdrawals history
async function loadHistory(page = 1) {
    try {
        showLoading();
        currentPage = page;
        
        const params = new URLSearchParams({
            page: page,
            ...currentFilters
        });
        
        const response = await fetch(`/withdrawals/api/admin/history?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            currentWithdrawals = data.withdrawals || [];
            totalPages = data.pagination?.total_pages || 1;
            renderHistory();
            updateStats();
            updatePagination(data.pagination);
        } else {
            throw new Error(data.error || 'Errore nel caricamento');
        }
    } catch (error) {
        console.error('Errore caricamento storico:', error);
        showError('Errore nel caricamento dello storico');
    } finally {
        hideLoading();
    }
}

// Render history table
function renderHistory() {
    const tbody = document.getElementById('history-table-body');
    const countElement = document.getElementById('history-count');
    
    if (currentWithdrawals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="admin-table-td text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun prelievo</h3>
                    <p class="text-gray-600">Non ci sono prelievi nello storico.</p>
                </td>
            </tr>
        `;
        countElement.textContent = '0 prelievi trovati';
        return;
    }
    
    tbody.innerHTML = currentWithdrawals.map(withdrawal => `
        <tr class="admin-table-tr">
            <td class="admin-table-td">
                <div>
                    <div class="admin-text-body font-medium">${withdrawal.full_name}</div>
                    <div class="admin-text-small text-gray-500">${withdrawal.email}</div>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="admin-text-body font-medium">€${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
            </td>
            <td class="admin-table-td">
                <div class="flex items-center">
                    ${withdrawal.method === 'usdt' ? 
                        '<div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center mr-2"><span class="text-white font-bold text-xs">₮</span></div>' :
                        '<div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-2"><span class="text-white font-bold text-xs">€</span></div>'
                    }
                    <span class="admin-text-body">${withdrawal.method === 'usdt' ? 'USDT (BEP20)' : 'Bonifico'}</span>
                </div>
            </td>
            <td class="admin-table-td">
                <div>
                    <div class="admin-text-body font-medium">${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                                                                    withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : 'Profitti'}</div>
                    <div class="admin-text-small text-gray-500">Chiave: ${withdrawal.unique_key}</div>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="admin-badge ${withdrawal.status === 'completed' ? 'admin-badge--success' : 
                                          withdrawal.status === 'cancelled' ? 'admin-badge--error' : 
                                          'admin-badge--warning'}">
                    ${withdrawal.status === 'completed' ? 'Completato' : 
                      withdrawal.status === 'cancelled' ? 'Rifiutato' : 'In attesa'}
                </span>
            </td>
            <td class="admin-table-td">
                <div class="admin-text-body">${new Date(withdrawal.created_at).toLocaleDateString('it-IT')}</div>
                <div class="admin-text-small text-gray-500">${new Date(withdrawal.created_at).toLocaleTimeString('it-IT')}</div>
            </td>
            <td class="admin-table-td">
                <div class="admin-text-body">${withdrawal.approved_by_name || '-'}</div>
                ${withdrawal.approved_at ? `<div class="admin-text-small text-gray-500">${new Date(withdrawal.approved_at).toLocaleDateString('it-IT')}</div>` : ''}
            </td>
            <td class="admin-table-td">
                <button onclick="viewWithdrawalDetails(${withdrawal.id})" class="admin-btn admin-btn--secondary admin-btn--sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </button>
            </td>
        </tr>
    `).join('');
    
    countElement.textContent = `${currentWithdrawals.length} prelievi trovati`;
}

// Update statistics
function updateStats() {
    const total = currentWithdrawals.length;
    const completed = currentWithdrawals.filter(w => w.status === 'completed').length;
    const rejected = currentWithdrawals.filter(w => w.status === 'cancelled').length;
    const totalAmount = currentWithdrawals
        .filter(w => w.status === 'completed')
        .reduce((sum, w) => sum + parseFloat(w.amount), 0);
    
    document.getElementById('total-count').textContent = total;
    document.getElementById('completed-count').textContent = completed;
    document.getElementById('rejected-count').textContent = rejected;
    document.getElementById('total-amount').textContent = `€${totalAmount.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
}

// Update pagination
function updatePagination(pagination) {
    const info = document.getElementById('pagination-info');
    const controls = document.getElementById('pagination-controls');
    
    if (pagination) {
        const start = (pagination.page - 1) * pagination.per_page + 1;
        const end = Math.min(pagination.page * pagination.per_page, pagination.total_count);
        info.textContent = `Mostrando ${start} - ${end} di ${pagination.total_count} risultati`;
        
        controls.innerHTML = '';
        
        // Previous button
        if (pagination.page > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.className = 'admin-btn admin-btn--secondary admin-btn--sm';
            prevBtn.textContent = 'Precedente';
            prevBtn.onclick = () => loadHistory(pagination.page - 1);
            controls.appendChild(prevBtn);
        }
        
        // Page numbers
        for (let i = 1; i <= pagination.total_pages; i++) {
            if (i === pagination.page || i === 1 || i === pagination.total_pages || 
                (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `admin-btn admin-btn--sm ${i === pagination.page ? 'admin-btn--primary' : 'admin-btn--secondary'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadHistory(i);
                controls.appendChild(pageBtn);
            } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                const dots = document.createElement('span');
                dots.className = 'px-2 py-1 text-gray-500';
                dots.textContent = '...';
                controls.appendChild(dots);
            }
        }
        
        // Next button
        if (pagination.page < pagination.total_pages) {
            const nextBtn = document.createElement('button');
            nextBtn.className = 'admin-btn admin-btn--secondary admin-btn--sm';
            nextBtn.textContent = 'Successiva';
            nextBtn.onclick = () => loadHistory(pagination.page + 1);
            controls.appendChild(nextBtn);
        }
    }
}

// Apply filters
function applyFilters() {
    currentFilters.status = document.getElementById('status-filter').value;
    currentFilters.method = document.getElementById('method-filter').value;
    currentFilters.search = document.getElementById('search-filter').value;
    
    loadHistory(1); // Reset to first page
}

// Refresh history
async function refreshHistory() {
    await loadHistory(currentPage);
}

// View withdrawal details (placeholder)
function viewWithdrawalDetails(withdrawalId) {
    const withdrawal = currentWithdrawals.find(w => w.id === withdrawalId);
    if (withdrawal) {
        alert(`Dettagli prelievo ${withdrawalId}:\nUtente: ${withdrawal.full_name}\nImporto: €${withdrawal.amount}\nMetodo: ${withdrawal.method}\nStato: ${withdrawal.status}`);
    }
}

// Show delete modal
function showDeleteModal() {
    document.getElementById('delete-confirm-modal').classList.remove('hidden');
}

// Hide delete modal
function hideDeleteModal() {
    document.getElementById('delete-confirm-modal').classList.add('hidden');
}

// Delete all withdrawals
async function deleteAllWithdrawals() {
    try {
        showLoading();
        const response = await fetch('/withdrawals/api/admin/delete-all', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(result.message || 'Storico prelievi eliminato con successo!');
            hideDeleteModal();
            setTimeout(() => loadHistory(1), 1500);
        } else {
            throw new Error(result.error || 'Errore nell\'eliminazione');
        }
    } catch (error) {
        console.error('Errore eliminazione:', error);
        showError(error.message || 'Errore nell\'eliminazione dello storico');
    } finally {
        hideLoading();
    }
}

// Utility functions
function showLoading() {
    document.getElementById('loading-modal').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-modal').classList.add('hidden');
}

function showSuccess(message) {
    const alert = document.getElementById('success-alert');
    alert.querySelector('.admin-alert-message').textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 5000);
}

function showError(message) {
    const alert = document.getElementById('error-alert');
    alert.querySelector('.admin-alert-message').textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 5000);
}
</script>
{% endblock %}
