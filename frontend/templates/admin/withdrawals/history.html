{% extends "layouts/admin_base.html" %}

{% block title %}Storico Prelievi - Admin{% endblock %}

{% block content %}
<!-- Storico Prelievi Admin -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div>
                <h1 class="admin-heading-1">Storico Prelievi</h1>
                <p class="admin-text-small">Visualizza e gestisci tutti i prelievi del sistema</p>
            </div>
            <div class="mt-3 sm:mt-0">
                <a href="/admin/withdrawals" class="admin-btn admin-btn--primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Torna ai Prelievi
                </a>
            </div>
        </div>
    </div>

    <!-- Filtri e Ricerca -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div class="admin-flex admin-flex--gap-4">
                <div>
                    <label for="status-filter" class="admin-label">Stato</label>
                    <select id="status-filter" class="admin-select" onchange="filterWithdrawals()">
                        <option value="">Tutti gli stati</option>
                        <option value="pending">In attesa</option>
                        <option value="completed">Completati</option>
                        <option value="cancelled">Rifiutati</option>
                    </select>
                </div>
                
                <div>
                    <label for="method-filter" class="admin-label">Metodo</label>
                    <select id="method-filter" class="admin-select" onchange="filterWithdrawals()">
                        <option value="">Tutti i metodi</option>
                        <option value="usdt">USDT (BEP20)</option>
                        <option value="bank">Bonifico Bancario</option>
                    </select>
                </div>
                
                <div>
                    <label for="search-filter" class="admin-label">Ricerca</label>
                    <input type="text" id="search-filter" class="admin-input" placeholder="Nome, cognome, email..." onkeyup="filterWithdrawals()">
                </div>
            </div>
            
            <div class="admin-flex admin-flex--gap-2">
                <button onclick="deleteSelectedWithdrawals()" id="delete-selected-withdrawals-btn" class="admin-btn admin-btn--danger hidden" disabled>
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    <span id="delete-selected-withdrawals-text">Elimina Selezionati (<span id="selected-withdrawals-count">0</span>)</span>
                </button>
                <button onclick="deleteAllWithdrawals()" class="admin-btn admin-btn--danger">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Elimina Storico
                </button>
            </div>
        </div>
    </div>

    <!-- Lista Storico Prelievi -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Storico Completo</h2>
            <span class="admin-text-small text-gray-500" id="withdrawals-count">0 prelievi trovati</span>
        </div>

        <div class="admin-card-body">
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table-th w-12">
                                <input type="checkbox" id="select-all-withdrawals" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="toggleAllWithdrawals()">
                            </th>
                            <th class="admin-table-th">Utente</th>
                            <th class="admin-table-th">Importo</th>
                            <th class="admin-table-th">Metodo</th>
                            <th class="admin-table-th">Sezione</th>
                            <th class="admin-table-th">Stato</th>
                            <th class="admin-table-th">Data Richiesta</th>
                            <th class="admin-table-th">Data Approvazione</th>
                            <th class="admin-table-th">Approvato da</th>
                            <th class="admin-table-th">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table-body">
                        <tr>
                            <td colspan="10" class="admin-table-td text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="text-gray-500 mt-2">Caricamento storico...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginazione -->
            <div id="pagination" class="admin-flex admin-flex--between admin-flex--items-center mt-6">
                <!-- Paginazione sar√† inserita qui dinamicamente -->
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Details Modal -->
<div id="withdrawal-details-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay" onclick="closeWithdrawalModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 class="admin-heading-3">Dettagli Prelievo</h3>
            <button onclick="closeWithdrawalModal()" class="admin-modal-close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="withdrawal-details-content" class="admin-modal-body">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-body text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Caricamento...</p>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {
    status: '',
    method: '',
    search: ''
};

// Carica storico al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    // Verifica autenticazione prima di caricare i dati
    checkAuthentication();
});

// Verifica autenticazione
async function checkAuthentication() {
    try {
        const response = await fetch('/auth/check', {
            method: 'GET',
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.authenticated && data.is_admin) {
                loadWithdrawalsHistory();
            } else {
                showError('Accesso negato. Solo gli amministratori possono visualizzare questa pagina.');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
            }
        } else {
            showError('Errore di autenticazione. Effettua nuovamente il login.');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        }
    } catch (error) {
        console.error('Errore verifica autenticazione:', error);
        showError('Errore di connessione. Verifica la connessione internet e riprova.');
    }
}

// Carica storico prelievi
async function loadWithdrawalsHistory(page = 1) {
    try {
        currentPage = page;
        const params = new URLSearchParams({
            page: page,
            ...currentFilters
        });
        
        console.log('üîÑ Caricamento storico prelievi...', {page, filters: currentFilters});
        
        // Mostra loading
        const tbody = document.getElementById('withdrawals-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="admin-table-td text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-500 mt-2">Caricamento storico...</p>
                </td>
            </tr>
        `;
        
        const response = await fetch(`/withdrawals/api/admin/history?${params}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (response.status === 401) {
            console.error('‚ùå Sessione scaduta');
            showError('Sessione scaduta. Effettua nuovamente il login.');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
            return;
        }
        
        if (response.status === 403) {
            console.error('‚ùå Accesso negato');
            showError('Accesso negato. Non hai i permessi per visualizzare questa pagina.');
            return;
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Errore HTTP:', response.status, errorText);
            showError(`Errore del server (${response.status}): ${errorText}`);
            return;
        }
        
        const data = await response.json();
        console.log('‚úÖ Response data:', data);
        
        if (data.withdrawals && Array.isArray(data.withdrawals)) {
            renderWithdrawals(data.withdrawals);
            renderPagination(data.pagination);
            document.getElementById('withdrawals-count').textContent = `${data.pagination.total_count} prelievi trovati`;
            console.log('‚úÖ Storico caricato con successo:', data.withdrawals.length, 'prelievi');
        } else {
            console.error('‚ùå Formato dati non valido:', data);
            showError('Formato dati non valido ricevuto dal server');
        }
    } catch (error) {
        console.error('‚ùå Errore nel caricamento storico:', error);
        showError('Errore di connessione: ' + error.message);
    }
}

// Renderizza prelievi nella tabella
function renderWithdrawals(withdrawals) {
    const tbody = document.getElementById('withdrawals-table-body');
    
    if (withdrawals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="admin-table-td text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun prelievo</h3>
                    <p class="text-gray-600">Non ci sono prelievi che corrispondono ai filtri selezionati.</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = withdrawals.map(withdrawal => `
        <tr class="admin-table-tr" 
            data-status="${withdrawal.status}" 
            data-method="${withdrawal.method}"
            data-search="${(withdrawal.full_name || '').toLowerCase()} ${(withdrawal.email || '').toLowerCase()}">
            <td class="admin-table-td w-12">
                <input type="checkbox" 
                       class="withdrawal-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                       value="${withdrawal.id}" 
                       onchange="updateSelectedWithdrawalsCount()">
            </td>
            <td class="admin-table-td">
                <div>
                    <p class="font-medium text-gray-900">${withdrawal.full_name || 'Utente'}</p>
                    <p class="text-sm text-gray-500">${withdrawal.email || ''}</p>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="font-semibold text-green-600">‚Ç¨${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits:2})}</span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${withdrawal.method === 'usdt' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                    ${withdrawal.method === 'usdt' ? 'USDT (BEP20)' : 'Bonifico Bancario'}
                </span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                    ${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                      withdrawal.source_section === 'profits' ? 'Profitti' : 
                      withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : withdrawal.source_section}
                </span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${
                    withdrawal.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                    withdrawal.status === 'completed' ? 'bg-green-100 text-green-800' :
                    'bg-red-100 text-red-800'
                }">
                    ${withdrawal.status === 'pending' ? 'In Attesa' :
                      withdrawal.status === 'completed' ? 'Completato' :
                      withdrawal.status === 'cancelled' ? 'Rifiutato' : withdrawal.status}
                </span>
            </td>
            <td class="admin-table-td">
                <div>
                    <p class="text-sm text-gray-900">${new Date(withdrawal.created_at).toLocaleDateString('it-IT')}</p>
                    <p class="text-xs text-gray-500">${new Date(withdrawal.created_at).toLocaleTimeString('it-IT')}</p>
                </div>
            </td>
            <td class="admin-table-td">
                ${withdrawal.approved_at ? `
                    <div>
                        <p class="text-sm text-gray-900">${new Date(withdrawal.approved_at).toLocaleDateString('it-IT')}</p>
                        <p class="text-xs text-gray-500">${new Date(withdrawal.approved_at).toLocaleTimeString('it-IT')}</p>
                    </div>
                ` : '<span class="text-gray-400">-</span>'}
            </td>
            <td class="admin-table-td">
                <span class="text-sm text-gray-900">${withdrawal.approved_by_name || '-'}</span>
            </td>
            <td class="admin-table-td">
                <div class="flex gap-2">
                    <button onclick="deleteWithdrawal(${withdrawal.id})" class="admin-btn admin-btn--danger admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Elimina
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Renderizza paginazione
function renderPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    
    if (pagination.total_pages <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let paginationHTML = `
        <div class="admin-text-small text-gray-500">
            Pagina ${pagination.page} di ${pagination.total_pages} (${pagination.total_count} prelievi totali)
        </div>
        <div class="admin-flex admin-flex--gap-2">
    `;
    
    // Pulsante precedente
    if (pagination.page > 1) {
        paginationHTML += `
            <button onclick="loadWithdrawalsHistory(${pagination.page - 1})" class="admin-btn admin-btn--secondary admin-btn--sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Precedente
            </button>
        `;
    }
    
    // Numeri pagina
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button onclick="loadWithdrawalsHistory(${i})" 
                    class="admin-btn admin-btn--sm ${i === pagination.page ? 'admin-btn--primary' : 'admin-btn--secondary'}">
                ${i}
            </button>
        `;
    }
    
    // Pulsante successivo
    if (pagination.page < pagination.total_pages) {
        paginationHTML += `
            <button onclick="loadWithdrawalsHistory(${pagination.page + 1})" class="admin-btn admin-btn--secondary admin-btn--sm">
                Successivo
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        `;
    }
    
    paginationHTML += '</div>';
    paginationDiv.innerHTML = paginationHTML;
}

// Filtra prelievi
function filterWithdrawals() {
    currentFilters.status = document.getElementById('status-filter').value;
    currentFilters.method = document.getElementById('method-filter').value;
    currentFilters.search = document.getElementById('search-filter').value;
    
    loadWithdrawalsHistory(1); // Ricarica dalla prima pagina
}

// Aggiorna prelievi
function refreshWithdrawals() {
    loadWithdrawalsHistory(currentPage);
    showNotification('Storico aggiornato', 'success');
}

// Elimina tutto lo storico
async function deleteAllWithdrawals() {
    if (!confirm('Sei sicuro di voler eliminare TUTTO lo storico dei prelievi? Questa azione non pu√≤ essere annullata!')) {
        return;
    }
    
    if (!confirm('CONFERMA FINALE: Eliminare tutti i prelievi dal database?')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch('/withdrawals/api/admin/delete-all', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`Eliminati ${data.deleted_count} prelievi`, 'success');
            loadWithdrawalsHistory(1);
        } else {
            showError('Errore nell\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
        }
    } catch (error) {
        console.error('Errore eliminazione:', error);
        showError('Errore nell\'eliminazione dei prelievi');
    } finally {
        hideLoading();
    }
}

// Elimina singolo prelievo
async function deleteWithdrawal(id) {
    if (!confirm('Sei sicuro di voler eliminare questo prelievo? Questa azione non pu√≤ essere annullata!')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch(`/withdrawals/api/admin/delete/${id}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('Prelievo eliminato con successo', 'success');
            loadWithdrawalsHistory(1);
        } else {
            showError('Errore nell\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
        }
    } catch (error) {
        console.error('Errore eliminazione:', error);
        showError('Errore nell\'eliminazione del prelievo');
    } finally {
        hideLoading();
    }
}

// Gestione selezione multipla prelievi
function toggleAllWithdrawals() {
    const selectAllCheckbox = document.getElementById('select-all-withdrawals');
    const checkboxes = document.querySelectorAll('.withdrawal-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedWithdrawalsCount();
}

function updateSelectedWithdrawalsCount() {
    const checkboxes = document.querySelectorAll('.withdrawal-checkbox');
    const selectedCheckboxes = document.querySelectorAll('.withdrawal-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    const totalCount = checkboxes.length;
    
    // Aggiorna il contatore
    document.getElementById('selected-withdrawals-count').textContent = selectedCount;
    
    // Mostra/nascondi il pulsante di eliminazione multipla
    const deleteSelectedBtn = document.getElementById('delete-selected-withdrawals-btn');
    if (selectedCount > 0) {
        deleteSelectedBtn.classList.remove('hidden');
        deleteSelectedBtn.disabled = false;
    } else {
        deleteSelectedBtn.classList.add('hidden');
        deleteSelectedBtn.disabled = true;
    }
    
    // Aggiorna lo stato del checkbox "Seleziona tutto"
    const selectAllCheckbox = document.getElementById('select-all-withdrawals');
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCount) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

async function deleteSelectedWithdrawals() {
    const selectedCheckboxes = document.querySelectorAll('.withdrawal-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (selectedIds.length === 0) {
        showError('Nessun prelievo selezionato');
        return;
    }
    
    if (!confirm(`Sei sicuro di voler eliminare ${selectedIds.length} prelievi selezionati? Questa azione non pu√≤ essere annullata!`)) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch('/withdrawals/api/admin/delete-multiple', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ withdrawal_ids: selectedIds })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`Eliminati ${data.deleted_count} prelievi con successo`, 'success');
            loadWithdrawalsHistory(1);
        } else {
            showError('Errore nell\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
        }
    } catch (error) {
        console.error('Errore eliminazione multipla:', error);
        showError('Errore nell\'eliminazione dei prelievi selezionati');
    } finally {
        hideLoading();
    }
}

// Chiudi modal
function closeWithdrawalModal() {
    document.getElementById('withdrawal-details-modal').classList.add('hidden');
}

// Mostra loading
function showLoading() {
    document.getElementById('loading-modal').classList.remove('hidden');
}

// Nascondi loading
function hideLoading() {
    document.getElementById('loading-modal').classList.add('hidden');
}

// Mostra notifica di successo
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Mostra errore
function showError(message) {
    showNotification(message, 'error');
}
</script>
{% endblock %}