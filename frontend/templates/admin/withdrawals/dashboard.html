{% extends "layouts/admin_base.html" %}

{% block title %}Gestione Prelievi - Admin{% endblock %}

{% block content %}
<!-- Dashboard Gestione Prelievi -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div>
                <h1 class="admin-heading-1">Gestione Prelievi</h1>
                <p class="admin-text-small">Gestisci tutte le richieste di prelievo del sistema</p>
            </div>
            <!-- Status Badge -->
            <div class="mt-3 sm:mt-0">
                <div class="admin-badge admin-badge--info">
                    <div class="w-2 h-2 bg-blue-400 rounded-full mr-2"></div>
                    Sistema Prelievi Attivo
                </div>
            </div>
        </div>
    </div>

    <!-- Metriche Prelievi -->
    <div class="admin-grid admin-grid--4">
        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">In Attesa</p>
                    <p class="admin-heading-2 text-yellow-600" id="pending-count">-</p>
                </div>
                <div class="admin-icon admin-icon--warning">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Completati</p>
                    <p class="admin-heading-2 text-green-600" id="completed-count">-</p>
                </div>
                <div class="admin-icon admin-icon--success">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Rifiutati</p>
                    <p class="admin-heading-2 text-red-600" id="rejected-count">-</p>
                </div>
                <div class="admin-icon admin-icon--error">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="admin-card admin-card-body">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div>
                    <p class="admin-text-small text-gray-500">Totale Prelievi</p>
                    <p class="admin-heading-2 text-blue-600" id="total-amount">-</p>
                </div>
                <div class="admin-icon admin-icon--info">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Prelievi Urgenti -->
    <div id="urgent-alert" class="admin-alert admin-alert--warning hidden">
        <div class="admin-alert-icon">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
        </div>
        <div class="admin-alert-content">
            <h4 class="admin-alert-title">Prelievi Urgenti!</h4>
            <p class="admin-alert-message" id="urgent-message">Ci sono prelievi in attesa da pi√π di 24 ore.</p>
        </div>
    </div>

    <!-- Filtri e Azioni -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div class="admin-flex admin-flex--gap-4">
                <div>
                    <label for="status-filter" class="admin-label">Stato</label>
                    <select id="status-filter" class="admin-select" onchange="filterWithdrawals()">
                        <option value="">Tutti gli stati</option>
                        <option value="pending">In attesa</option>
                        <option value="completed">Completati</option>
                        <option value="cancelled">Rifiutati</option>
                    </select>
                </div>
                
                <div>
                    <label for="method-filter" class="admin-label">Metodo</label>
                    <select id="method-filter" class="admin-select" onchange="filterWithdrawals()">
                        <option value="">Tutti i metodi</option>
                        <option value="usdt">USDT (BEP20)</option>
                        <option value="bank">Bonifico Bancario</option>
                    </select>
                </div>
                
                <div>
                    <label for="search-filter" class="admin-label">Ricerca</label>
                    <input type="text" id="search-filter" class="admin-input" placeholder="Nome, email..." onkeyup="filterWithdrawals()">
                </div>
            </div>
            
            <div class="admin-flex admin-flex--gap-2">
                <a href="/withdrawals/admin/withdrawals/faq" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    FAQ
                </a>
                <a href="/withdrawals/admin/withdrawals/history" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Storico Prelievi
                </a>
                <button onclick="refreshWithdrawals()" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Aggiorna
                </button>
            </div>
        </div>
    </div>

    <!-- Lista Richieste Prelievo -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Richieste di Prelievo</h2>
            <span class="admin-text-small text-gray-500" id="withdrawals-count">0 richieste trovate</span>
        </div>

        <div class="admin-card-body">
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table-th">Utente</th>
                            <th class="admin-table-th">Importo</th>
                            <th class="admin-table-th">Metodo</th>
                            <th class="admin-table-th">Sezione</th>
                            <th class="admin-table-th">Stato</th>
                            <th class="admin-table-th">Data & Urgenza</th>
                            <th class="admin-table-th">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table-body">
                        <tr>
                            <td colspan="7" class="admin-table-td text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="text-gray-500 mt-2">Caricamento prelievi...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Details Modal -->
<div id="withdrawal-details-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay" onclick="closeWithdrawalModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 class="admin-heading-3">Dettagli Prelievo</h3>
            <button onclick="closeWithdrawalModal()" class="admin-modal-close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="withdrawal-details-content" class="admin-modal-body">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-body text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Caricamento...</p>
        </div>
    </div>
</div>

<!-- Success/Error Alerts -->
<div id="success-alert" class="admin-alert admin-alert--success hidden">
    <div class="admin-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
    </div>
    <div class="admin-alert-content">
        <h4 class="admin-alert-title">Successo!</h4>
        <p class="admin-alert-message">Operazione completata con successo!</p>
    </div>
</div>

<div id="error-alert" class="admin-alert admin-alert--error hidden">
    <div class="admin-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </div>
    <div class="admin-alert-content">
        <h4 class="admin-alert-title">Errore!</h4>
        <p class="admin-alert-message">Si √® verificato un errore!</p>
    </div>
</div>

<script>
// Load withdrawals on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPendingWithdrawals();
    loadMetrics();
});

// Load withdrawals from API - versione semplificata come depositi
async function loadPendingWithdrawals() {
    const res = await fetch('/withdrawals/api/admin/pending');
    const data = await res.json();
    const list = document.getElementById('withdrawals-table-body');
    
    if (!res.ok || !data.withdrawals || data.withdrawals.length === 0) {
        list.innerHTML = `
            <tr>
                <td colspan="7" class="admin-table-td text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun prelievo</h3>
                    <p class="text-gray-600">Non ci sono richieste di prelievo in attesa.</p>
                </td>
            </tr>
        `;
        document.getElementById('withdrawals-count').textContent = '0 richieste trovate';
        return;
    }
    
    document.getElementById('withdrawals-count').textContent = `${data.withdrawals.length} richieste trovate`;
    list.innerHTML = data.withdrawals.map(req => `
        <tr class="admin-table-tr">
            <td class="admin-table-td">
                <div>
                    <p class="font-medium text-gray-900">${req.full_name || 'Utente'}</p>
                    <p class="text-sm text-gray-500">${req.email || ''}</p>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="font-semibold text-green-600">‚Ç¨${parseFloat(req.amount).toLocaleString('it-IT', {minimumFractionDigits:2})}</span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${req.method === 'usdt' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                    ${req.method === 'usdt' ? 'USDT (BEP20)' : 'Bonifico Bancario'}
                </span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                    ${req.source_section === 'free_capital' ? 'Capitale Libero' : 
                      req.source_section === 'profits' ? 'Profitti' : 
                      req.source_section === 'referral_bonus' ? 'Bonus Referral' : req.source_section}
                </span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">In Attesa</span>
            </td>
            <td class="admin-table-td">
                <div>
                    <p class="text-sm text-gray-900">${new Date(req.created_at).toLocaleDateString('it-IT')}</p>
                    <p class="text-xs text-gray-500">${Math.round(req.hours_pending || 0)}h fa</p>
                </div>
            </td>
            <td class="admin-table-td">
                <div class="flex gap-2">
                    <button onclick="viewWithdrawalDetails(${req.id})" class="admin-btn admin-btn--secondary admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Dettagli
                    </button>
                    <button onclick="approveWithdrawal(${req.id})" class="admin-btn admin-btn--success admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Approva
                    </button>
                    <button onclick="rejectWithdrawal(${req.id})" class="admin-btn admin-btn--danger admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Rifiuta
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Render withdrawals table
function renderWithdrawals() {
    const tbody = document.getElementById('withdrawals-table-body');
    const countElement = document.getElementById('withdrawals-count');
    
    if (currentWithdrawals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="admin-table-td text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun prelievo</h3>
                    <p class="text-gray-600">Non ci sono richieste di prelievo in attesa.</p>
                </td>
            </tr>
        `;
        countElement.textContent = '0 richieste trovate';
        return;
    }
    
    tbody.innerHTML = currentWithdrawals.map(withdrawal => `
        <tr class="admin-table-tr" 
            data-status="${withdrawal.status}" 
            data-method="${withdrawal.method}"
            data-search="${withdrawal.full_name.toLowerCase()} ${withdrawal.email.toLowerCase()}">
            <td class="admin-table-td">
                <div>
                    <div class="admin-text-body font-medium">${withdrawal.full_name}</div>
                    <div class="admin-text-small text-gray-500">${withdrawal.email}</div>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="admin-text-body font-medium">‚Ç¨${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
            </td>
            <td class="admin-table-td">
                <div class="flex items-center">
                    ${withdrawal.method === 'usdt' ? 
                        '<div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center mr-2"><span class="text-white font-bold text-xs">‚ÇÆ</span></div>' :
                        '<div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-2"><span class="text-white font-bold text-xs">‚Ç¨</span></div>'
                    }
                    <span class="admin-text-body">${withdrawal.method === 'usdt' ? 'USDT (BEP20)' : 'Bonifico'}</span>
                </div>
            </td>
            <td class="admin-table-td">
                <div>
                    <div class="admin-text-body font-medium">${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                                                                    withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : 'Profitti'}</div>
                    <div class="admin-text-small text-gray-500">Chiave: ${withdrawal.unique_key}</div>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="admin-badge admin-badge--warning">In attesa</span>
            </td>
            <td class="admin-table-td">
                <div class="admin-text-body">${new Date(withdrawal.created_at).toLocaleDateString('it-IT')}</div>
                <div class="admin-text-small text-gray-500">${new Date(withdrawal.created_at).toLocaleTimeString('it-IT')}</div>
                <div class="admin-text-small ${withdrawal.hours_pending > 24 ? 'text-red-600 font-medium' : 'text-gray-500'}">
                    ${withdrawal.hours_pending.toFixed(1)}h fa
                    ${withdrawal.hours_pending > 24 ? ' (URGENTE!)' : ''}
                </div>
            </td>
            <td class="admin-table-td">
                <div class="admin-flex admin-flex--gap-2">
                    <button onclick="approveWithdrawal(${withdrawal.id})" class="admin-btn admin-btn--success admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                    <button onclick="rejectWithdrawal(${withdrawal.id})" class="admin-btn admin-btn--error admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                    <button onclick="viewWithdrawalDetails(${withdrawal.id})" class="admin-btn admin-btn--secondary admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    countElement.textContent = `${currentWithdrawals.length} richieste trovate`;
}

// Update metrics
function updateMetrics() {
    const pending = currentWithdrawals.filter(w => w.status === 'pending').length;
    const completed = currentWithdrawals.filter(w => w.status === 'completed').length;
    const rejected = currentWithdrawals.filter(w => w.status === 'cancelled').length;
    const totalAmount = currentWithdrawals
        .filter(w => w.status === 'completed')
        .reduce((sum, w) => sum + parseFloat(w.amount), 0);
    
    document.getElementById('pending-count').textContent = pending;
    document.getElementById('completed-count').textContent = completed;
    document.getElementById('rejected-count').textContent = rejected;
    document.getElementById('total-amount').textContent = `‚Ç¨${totalAmount.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
    
    // Show urgent alert if needed
    const urgentCount = currentWithdrawals.filter(w => w.hours_pending > 24).length;
    const urgentAlert = document.getElementById('urgent-alert');
    const urgentMessage = document.getElementById('urgent-message');
    
    if (urgentCount > 0) {
        urgentMessage.textContent = `Ci sono ${urgentCount} prelievi in attesa da pi√π di 24 ore.`;
        urgentAlert.classList.remove('hidden');
    } else {
        urgentAlert.classList.add('hidden');
    }
}

// Filter withdrawals
function filterWithdrawals() {
    const statusFilter = document.getElementById('status-filter').value;
    const methodFilter = document.getElementById('method-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    
    currentFilters.status = statusFilter;
    currentFilters.method = methodFilter;
    currentFilters.search = searchFilter;
    
    const rows = document.querySelectorAll('#withdrawals-table-body tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const status = row.dataset.status;
        const method = row.dataset.method;
        const searchText = row.dataset.search;
        
        const statusMatch = !statusFilter || status === statusFilter;
        const methodMatch = !methodFilter || method === methodFilter;
        const searchMatch = !searchFilter || searchText.includes(searchFilter);
        
        if (statusMatch && methodMatch && searchMatch) {
            row.classList.remove('hidden');
            visibleCount++;
        } else {
            row.classList.add('hidden');
        }
    });
    
    // Update subtitle
    document.getElementById('withdrawals-count').textContent = `${visibleCount} richieste trovate`;
}

// Refresh withdrawals
async function refreshWithdrawals() {
    await loadWithdrawals();
}

// View withdrawal details
async function viewWithdrawalDetails(withdrawalId) {
    try {
        showLoading();
        const withdrawal = currentWithdrawals.find(w => w.id === withdrawalId);
        if (withdrawal) {
            showWithdrawalDetailsModal(withdrawal);
        } else {
            throw new Error('Prelievo non trovato');
        }
    } catch (error) {
        console.error('Errore dettagli:', error);
        showError('Errore nel caricamento dei dettagli');
    } finally {
        hideLoading();
    }
}

// Show withdrawal details modal
function showWithdrawalDetailsModal(withdrawal) {
    const modal = document.getElementById('withdrawal-details-modal');
    const content = document.getElementById('withdrawal-details-content');
    
    const methodDetails = withdrawal.method === 'usdt' ? 
        `<div>
            <label class="block text-sm font-medium text-gray-700">Indirizzo Wallet</label>
            <p class="mt-1 text-sm text-gray-900 font-mono break-all">${withdrawal.wallet_address}</p>
        </div>` :
        `<div>
            <label class="block text-sm font-medium text-gray-700">Dettagli Bancari</label>
            <p class="mt-1 text-sm text-gray-900">${JSON.stringify(withdrawal.bank_details, null, 2)}</p>
        </div>`;
    
    content.innerHTML = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Utente</label>
                    <p class="mt-1 text-sm text-gray-900">${withdrawal.full_name}</p>
                    <p class="text-sm text-gray-500">${withdrawal.email}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Importo</label>
                    <p class="mt-1 text-lg font-semibold text-gray-900">‚Ç¨${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Metodo</label>
                    <p class="mt-1 text-sm text-gray-900">${withdrawal.method === 'usdt' ? 'USDT (BEP20)' : 'Bonifico Bancario'}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Sezione Fonte</label>
                    <p class="mt-1 text-sm text-gray-900">${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                                                                    withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : 'Profitti'}</p>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Chiave Unica</label>
                <p class="mt-1 text-sm text-gray-900 font-mono">${withdrawal.unique_key}</p>
            </div>
            
            ${methodDetails}
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Data Richiesta</label>
                <p class="mt-1 text-sm text-gray-900">${new Date(withdrawal.created_at).toLocaleString('it-IT')}</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Tempo in Attesa</label>
                <p class="mt-1 text-sm ${withdrawal.hours_pending > 24 ? 'text-red-600 font-medium' : 'text-gray-900'}">
                    ${withdrawal.hours_pending.toFixed(1)} ore
                    ${withdrawal.hours_pending > 24 ? ' (URGENTE!)' : ''}
                </p>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Close withdrawal modal
function closeWithdrawalModal() {
    document.getElementById('withdrawal-details-modal').classList.add('hidden');
}

// Approve withdrawal - versione semplificata come depositi
async function approveWithdrawal(id) {
    if (!confirm('Sei sicuro di voler approvare questo prelievo?')) return;
    
    const r = await fetch(`/withdrawals/api/admin/approve/${id}`, {
            method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });
    
    if (r.ok) { 
        showNotification('Prelievo approvato con successo', 'success');
        loadPendingWithdrawals(); 
        } else {
        const error = await r.json();
        showNotification('Errore: ' + (error.error || 'Errore nell\'approvazione'), 'error');
    }
}

// Reject withdrawal - versione semplificata come depositi
async function rejectWithdrawal(id) {
    const reason = prompt('Motivo del rifiuto (opzionale):');
    if (reason === null) return; // User cancelled
    
    const r = await fetch(`/withdrawals/api/admin/reject/${id}`, {
            method: 'POST',
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({admin_notes: reason || 'Rifiutato da admin'})
    });
    
    if (r.ok) { 
        showNotification('Prelievo rifiutato con successo', 'success');
        loadPendingWithdrawals(); 
        } else {
        const error = await r.json();
        showNotification('Errore: ' + (error.error || 'Errore nel rifiuto'), 'error');
    }
}

// Notification system - come depositi
function showNotification(message, type) {
    // Crea elemento notifica
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Rimuovi dopo 3 secondi
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Load metrics from API
async function loadMetrics() {
    try {
        const response = await fetch('/withdrawals/api/admin/metrics');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('pending-count').textContent = data.pending || 0;
            document.getElementById('completed-count').textContent = data.completed || 0;
            document.getElementById('rejected-count').textContent = data.cancelled || 0;
            document.getElementById('total-amount').textContent = `‚Ç¨${(data.total_amount || 0).toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
        } else {
            console.error('Errore nel caricamento metriche:', data.error);
        }
    } catch (error) {
        console.error('Errore nel caricamento metriche:', error);
    }
}

// Refresh withdrawals and metrics
async function refreshWithdrawals() {
    await loadPendingWithdrawals();
    await loadMetrics();
    showNotification('Dati aggiornati', 'success');
}

// View withdrawal details - versione semplificata
function viewWithdrawalDetails(id) {
    // Per ora mostriamo solo un alert, poi possiamo implementare un modal
    alert('Dettagli prelievo ID: ' + id + '\n\nFunzionalit√† in sviluppo...');
}
</script>
{% endblock %}