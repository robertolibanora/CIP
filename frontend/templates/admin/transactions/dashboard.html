{% extends "layouts/admin_base.html" %}

{% block title %}Transazioni Sistema - Admin{% endblock %}

{% block content %}
<!-- Dashboard Transazioni Sistema -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div>
                <h1 class="admin-heading-1">Transazioni Sistema</h1>
                <p class="admin-text-small">Monitoraggio e tracking di tutte le transazioni</p>
            </div>
            <!-- Status Badge -->
            <div class="mt-3 sm:mt-0">
                <div class="admin-badge admin-badge--info">
                    <div class="w-2 h-2 bg-blue-400 rounded-full mr-2"></div>
                    Sistema Transazioni
                </div>
            </div>
        </div>
    </div>

    <!-- Metriche Transazioni -->
    <div class="admin-grid admin-grid--4">
        {% with 
            metric_title='Transazioni Totali',
            metric_value=metrics.total_transactions or 0,
            metric_icon='chart',
            metric_color='blue',
            metric_subtitle='Tutte le transazioni' %}
            {% include 'admin/components/metrics_widget.html' %}
        {% endwith %}

        {% with 
            metric_title='Oggi',
            metric_value=metrics.today_transactions or 0,
            metric_icon='today',
            metric_color='green',
            metric_subtitle='Transazioni di oggi' %}
            {% include 'admin/components/metrics_widget.html' %}
        {% endwith %}

        {% with 
            metric_title='Volume Totale',
            metric_value='€' + ('{:,.0f}'.format(metrics.total_volume or 0)),
            metric_icon='money',
            metric_color='purple',
            metric_subtitle='Volume totale movimentato' %}
            {% include 'admin/components/metrics_widget.html' %}
        {% endwith %}

        {% with 
            metric_title='In Attesa',
            metric_value=metrics.pending_transactions or 0,
            metric_icon='pending',
            metric_color='warning',
            metric_subtitle='Transazioni pending' %}
            {% include 'admin/components/metrics_widget.html' %}
        {% endwith %}
    </div>

    <!-- Filtri e Azioni -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div class="admin-flex admin-flex--gap-4">
                <div>
                    <label for="type-filter" class="admin-label">Tipo</label>
                    <select id="type-filter" class="admin-select" onchange="filterTransactions()">
                        <option value="">Tutti i tipi</option>
                        <option value="deposit">Ricariche</option>
                        <option value="withdrawal">Prelievi</option>
                        <option value="investment">Investimenti</option>
                        <option value="profit">Profitti</option>
                    </select>
                </div>
                
                <div>
                    <label for="status-filter" class="admin-label">Stato</label>
                    <select id="status-filter" class="admin-select" onchange="filterTransactions()">
                        <option value="">Tutti gli stati</option>
                        <option value="pending">In attesa</option>
                        <option value="completed">Completate</option>
                        <option value="failed">Fallite</option>
                    </select>
                </div>
                
                <div>
                    <label for="search-filter" class="admin-label">Ricerca</label>
                    <input type="text" id="search-filter" class="admin-input" placeholder="Utente, descrizione..." onkeyup="filterTransactions()">
                </div>
            </div>
            
            <div class="admin-flex admin-flex--gap-2">
                <button onclick="refreshTransactions()" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Aggiorna
                </button>
            </div>
        </div>
    </div>

    <!-- Lista Transazioni -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Transazioni Sistema</h2>
            <span class="admin-text-small text-gray-500">{{ transactions|length }} transazioni trovate</span>
        </div>

        <div class="admin-card-body">
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table-th">Utente</th>
                            <th class="admin-table-th">Tipo</th>
                            <th class="admin-table-th">Importo</th>
                            <th class="admin-table-th">Stato</th>
                            <th class="admin-table-th">Data</th>
                            <th class="admin-table-th">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        {% for transaction in transactions %}
                        <tr class="admin-table-tr" 
                            data-type="{{ transaction.type }}" 
                            data-status="{{ transaction.status }}"
                            data-search="{{ transaction.user_name|lower }} {{ transaction.description|lower }}">
                            <td class="admin-table-td">
                                <div>
                                    <div class="admin-text-body font-medium">{{ transaction.user_name }}</div>
                                    <div class="admin-text-small text-gray-500">{{ transaction.user_email }}</div>
                                </div>
                            </td>
                            <td class="admin-table-td">
                                {% if transaction.type == 'deposit' %}
                                    <span class="admin-badge admin-badge--success">Ricarica</span>
                                {% elif transaction.type == 'withdrawal' %}
                                    <span class="admin-badge admin-badge--warning">Prelievo</span>
                                {% elif transaction.type == 'investment' %}
                                    <span class="admin-badge admin-badge--info">Investimento</span>
                                {% elif transaction.type == 'profit' %}
                                    <span class="admin-badge admin-badge--primary">Profitto</span>
                                {% else %}
                                    <span class="admin-badge admin-badge--secondary">{{ transaction.type }}</span>
                                {% endif %}
                            </td>
                            <td class="admin-table-td">
                                <span class="admin-text-body font-medium {% if transaction.amount < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                    €{{ "%.2f"|format(transaction.amount) }}
                                </span>
                            </td>
                            <td class="admin-table-td">
                                {% if transaction.status == 'pending' %}
                                    <span class="admin-badge admin-badge--warning">In attesa</span>
                                {% elif transaction.status == 'completed' %}
                                    <span class="admin-badge admin-badge--success">Completata</span>
                                {% elif transaction.status == 'failed' %}
                                    <span class="admin-badge admin-badge--error">Fallita</span>
                                {% else %}
                                    <span class="admin-badge admin-badge--secondary">{{ transaction.status }}</span>
                                {% endif %}
                            </td>
                            <td class="admin-table-td">
                                <div class="admin-text-body">{{ transaction.created_at.strftime('%d/%m/%Y') }}</div>
                                <div class="admin-text-small text-gray-500">{{ transaction.created_at.strftime('%H:%M') }}</div>
                            </td>
                            <td class="admin-table-td">
                                <div class="admin-flex admin-flex--gap-2">
                                    <button onclick="viewTransactionDetails({{ transaction.id }})" class="admin-btn admin-btn--secondary admin-btn--sm">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Paginazione -->
        {% if total_count > per_page %}
        <div class="admin-card-footer">
            <div class="admin-flex admin-flex--between admin-flex--items-center">
                <div class="admin-text-small text-gray-500">
                    Mostrando {{ (page - 1) * per_page + 1 }} - {{ [page * per_page, total_count]|min }} di {{ total_count }} risultati
                </div>
                <div class="admin-flex admin-flex--gap-2">
                    {% if page > 1 %}
                        <a href="?page={{ page - 1 }}" class="admin-btn admin-btn--secondary admin-btn--sm">Precedente</a>
                    {% endif %}
                    
                    {% for p in range(1, (total_count // per_page) + 2) %}
                        {% if p <= total_count // per_page + 1 %}
                            <a href="?page={{ p }}" class="admin-btn {% if p == page %}admin-btn--primary{% else %}admin-btn--secondary{% endif %} admin-btn--sm">{{ p }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page < (total_count // per_page) %}
                        <a href="?page={{ page + 1 }}" class="admin-btn admin-btn--secondary admin-btn--sm">Successiva</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Modal -->
{% with modal_id="loading-modal", modal_title="Caricamento..." %}
    {% include 'admin/components/loading.html' %}
{% endwith %}

<!-- Success/Error Alerts -->
{% with alert_id="success-alert", alert_type="success", alert_message="Operazione completata con successo!" %}
    {% include 'admin/components/alert.html' %}
{% endwith %}

{% with alert_id="error-alert", alert_type="error", alert_message="Si è verificato un errore!" %}
    {% include 'admin/components/alert.html' %}
{% endwith %}

<script>
// Global variables
let currentTransactions = {{ transactions|tojson }};
let currentFilters = {
    type: '',
    status: '',
    search: ''
};

// Filter transactions based on current filters
function filterTransactions() {
    const typeFilter = document.getElementById('type-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    
    currentFilters.type = typeFilter;
    currentFilters.status = statusFilter;
    currentFilters.search = searchFilter;
    
    const rows = document.querySelectorAll('#transactions-table-body tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const type = row.dataset.type;
        const status = row.dataset.status;
        const searchText = row.dataset.search;
        
        const typeMatch = !typeFilter || type === typeFilter;
        const statusMatch = !statusFilter || status === statusFilter;
        const searchMatch = !searchFilter || searchText.includes(searchFilter);
        
        if (typeMatch && statusMatch && searchMatch) {
            row.classList.remove('hidden');
            visibleCount++;
        } else {
            row.classList.add('hidden');
        }
    });
    
    // Update subtitle
    const subtitle = document.querySelector('.admin-card-subtitle');
    if (subtitle) {
        subtitle.textContent = `${visibleCount} transazioni trovate`;
    }
}

// Refresh transactions list
async function refreshTransactions() {
    try {
        showLoading();
        const response = await fetch('/admin/transactions');
        if (response.ok) {
            window.location.reload();
        } else {
            throw new Error('Errore nel refresh');
        }
    } catch (error) {
        console.error('Errore refresh:', error);
        showError('Errore nell\'aggiornamento della lista');
    } finally {
        hideLoading();
    }
}

// View transaction details
async function viewTransactionDetails(transactionId) {
    try {
        showLoading();
        // TODO: Implementare API per dettagli transazione
        showSuccess('Funzionalità in sviluppo');
    } catch (error) {
        console.error('Errore dettagli:', error);
        showError('Errore nel caricamento dei dettagli');
    } finally {
        hideLoading();
    }
}

// Utility functions
function showLoading() {
    document.getElementById('loading-modal').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-modal').classList.add('hidden');
}

function showSuccess(message) {
    const alert = document.getElementById('success-alert');
    alert.querySelector('.admin-alert-message').textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 5000);
}

function showError(message) {
    const alert = document.getElementById('error-alert');
    alert.querySelector('.admin-alert-message').textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial filter values
    if (currentFilters.type) {
        document.getElementById('type-filter').value = currentFilters.type;
    }
    if (currentFilters.status) {
        document.getElementById('status-filter').value = currentFilters.status;
    }
    if (currentFilters.search) {
        document.getElementById('search-filter').value = currentFilters.search;
    }
    
    // Apply initial filters
    filterTransactions();
});
</script>
{% endblock %}
