{% extends "layouts/admin_base.html" %}

{% block title %}Gestione Utenti{% endblock %}

{% block content %}
<div class="admin-users">
  <style>
    .users-header input{border:1px solid #e5e7eb;border-radius:10px;background:#fafafa}
    .card{border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .table thead th{background:#f8fafc;color:#0f172a;border-bottom:1px solid #e5e7eb;font-weight:600}
    .table tbody tr{border-top:1px solid #f1f5f9}
    .table tbody tr:hover{background:#f8fafc}
    .btn{cursor:pointer}
    .btn-theme{background:#0f766e;color:#fff;border:none;border-radius:8px;padding:8px 12px;transition:all .15s ease}
    .btn-theme:hover{background:#115e59;transform:translateY(-1px)}
    .btn-small{padding:6px 10px;font-size:14px}
    .chip{display:inline-block;padding:4px 10px;border-radius:9999px;font-size:12px;font-weight:600}
    .chip-green{background:#dcfce7;color:#166534}
    .chip-gray{background:#f1f5f9;color:#334155}
    .chip-yellow{background:#fef9c3;color:#854d0e}
    .chip-red{background:#fee2e2;color:#991b1b}
    .chip-blue{background:#e0f2fe;color:#075985}
  </style>
  <div class="users-header" style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
    <input id="user-search" type="text" placeholder="Cerca per email, nome o Telegram" style="flex:1; padding:10px;">
    <button id="view-history" class="btn-theme btn-small" style="background:#334155">Storico</button>
    <button id="bulk-add" class="btn-theme btn-small">Aggiungi</button>
    <button id="bulk-remove" class="btn-theme btn-small" style="background:#b91c1c">Rimuovi</button>
    <button id="refresh-users" class="btn">Aggiorna</button>
  </div>

  <div style="display:flex; gap:16px;">
    <main style="flex:1;">
      <div class="card" style="padding:0; overflow:auto;">
        <table class="table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="padding:14px; width:36px;"><input id="select-all" type="checkbox"></th>
              <th style="text-align:left; padding:14px;">Nome e cognome</th>
              <th style="text-align:left; padding:14px;">Username Telegram</th>
              <th style="text-align:left; padding:14px;">Investitore</th>
              <th style="text-align:left; padding:14px;">KYC</th>
              <th style="text-align:right; padding:14px;">Azioni</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Dettaglio utente modal -->
  <div id="user-detail-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);">
    <div class="modal-content" style="background:#fff; margin:5% auto; padding:20px; width:700px; border-radius:14px; position:relative; box-shadow:0 20px 40px rgba(2,6,23,.18); border:1px solid #e5e7eb;">
      <button id="close-modal" class="btn" style="position:absolute; right:8px; top:8px;">×</button>
      <h3 style="margin:0 0 14px 0; font-size:20px;">Dettaglio utente</h3>
      <form id="user-edit-form" style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
        <input type="hidden" id="detail-id">
        <div>
          <label>Nome</label>
          <input id="detail-nome" type="text" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
        </div>
        <div>
          <label>Cognome</label>
          <input id="detail-cognome" type="text" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
        </div>
        <div>
          <label>Email</label>
          <input id="detail-email" type="email" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
        </div>
        <div>
          <label>Telefono</label>
          <input id="detail-phone" type="text" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
        </div>
        <div>
          <label>Telegram</label>
          <input id="detail-telegram" type="text" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
        </div>
        <div style="grid-column:1/-1; display:flex; justify-content:space-between; gap:8px; margin-top:8px;">
          <button type="button" id="delete-user" class="btn-theme btn-small" style="background:#b91c1c">Elimina</button>
          <div>
            <button type="button" id="save-user" class="btn-theme btn-small">Salva</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="display:none; position:fixed; right:16px; bottom:16px; background:#2d6a4f; color:#fff; padding:10px 12px; border-radius:6px;">Utente aggiornato con successo</div>

  <!-- Portfolio modal -->
  <div id="portfolio-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);">
    <div class="modal-content" style="background:#fff; margin:4% auto; padding:20px; width:760px; border-radius:14px; position:relative; box-shadow:0 20px 40px rgba(2,6,23,.18); border:1px solid #e5e7eb;">
      <button id="close-portfolio" class="btn" style="position:absolute; right:8px; top:8px;">×</button>
      <h3 style="margin:0 0 14px 0; font-size:20px;">Portafoglio utente</h3>
      <div id="portfolio-summary" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; margin-bottom:12px;"></div>
      <div class="card" style="padding:0; overflow:auto;">
        <table class="table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:14px;">Progetto</th>
              <th style="text-align:left; padding:14px;">Importo</th>
              <th style="text-align:left; padding:14px;">Stato</th>
              <th style="text-align:left; padding:14px;">Data</th>
            </tr>
          </thead>
          <tbody id="portfolio-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const tbody = document.getElementById('users-tbody');
  const searchEl = document.getElementById('user-search');
  const refreshBtn = document.getElementById('refresh-users');
  const bulkAddBtn = document.getElementById('bulk-add');
  const bulkRemoveBtn = document.getElementById('bulk-remove');
  const selectAll = document.getElementById('select-all');
  const viewHistoryBtn = document.getElementById('view-history');

  const modal = document.getElementById('user-detail-modal');
  const closeModalBtn = document.getElementById('close-modal');
  const toast = document.getElementById('toast');
  const portfolioModal = document.getElementById('portfolio-modal');
  const closePortfolioBtn = document.getElementById('close-portfolio');
  const portfolioSummary = document.getElementById('portfolio-summary');
  const portfolioTbody = document.getElementById('portfolio-tbody');
  let currentPortfolioUserId = null;
  let currentHistoryItems = [];
  const userNameCache = {};

  const dId = document.getElementById('detail-id');
  const dNome = document.getElementById('detail-nome');
  const dCognome = document.getElementById('detail-cognome');
  const dEmail = document.getElementById('detail-email');
  const dPhone = document.getElementById('detail-phone');
  const dTelegram = document.getElementById('detail-telegram');
  const saveBtn = document.getElementById('save-user');
  const deleteBtn = document.getElementById('delete-user');

  let debounceTimer = null;

  function showToast(msg){
    toast.textContent = msg || 'Operazione completata';
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display='none', 2000);
  }

  function openModal(){ modal.style.display = 'block'; }
  function closeModal(){ modal.style.display = 'none'; }
  function openPortfolio(){ portfolioModal.style.display = 'block'; }
  function closePortfolio(){ portfolioModal.style.display = 'none'; }

  async function fetchUsers(){
    const params = new URLSearchParams();
    if(searchEl.value) params.set('search', searchEl.value);

    const res = await fetch(`/admin/api/admin/users?${params.toString()}`);
    const data = await res.json();
    renderRows(data.items || []);
  }

  function renderRows(items){
    tbody.innerHTML = '';
    for(const u of items){
      const tr = document.createElement('tr');
      const investorBadge = u.investor_status === 'si'
        ? '<span class="chip chip-green">Sì</span>'
        : '<span class="chip chip-gray">No</span>';
      let kycBadge = '<span class="chip chip-gray">—</span>';
      if(u.kyc_status === 'verified') kycBadge = '<span class="chip chip-green">Verified</span>';
      else if(u.kyc_status === 'pending') kycBadge = '<span class="chip chip-yellow">Pending</span>';
      else if(u.kyc_status === 'rejected') kycBadge = '<span class="chip chip-red">Rejected</span>';
      else if(u.kyc_status === 'unverified') kycBadge = '<span class="chip chip-blue">Unverified</span>';
      tr.innerHTML = `
        <td style="padding:14px; text-align:center;"><input type="checkbox" class="row-sel" data-id="${u.id}"></td>
        <td style="padding:14px;">${u.full_name || ''}</td>
        <td style="padding:14px;">${u.telegram_username || ''}</td>
        <td style="padding:14px;">${investorBadge}</td>
        <td style="padding:14px;">${kycBadge}</td>
        <td style="padding:14px; text-align:right; display:flex; gap:8px; justify-content:flex-end;">
          <button data-id="${u.id}" class="btn-theme btn-small btn-portfolio">Portafoglio</button>
          <button data-id="${u.id}" class="btn-theme btn-small btn-details">Dettagli</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadDetail(id){
    const res = await fetch(`/admin/api/admin/users/${id}`);
    const u = await res.json();
    dId.value = u.id;
    dNome.value = u.nome || '';
    dCognome.value = u.cognome || '';
    dEmail.value = u.email || '';
    dPhone.value = u.phone || '';
    dTelegram.value = u.telegram || '';
    openModal();
  }

  async function saveDetail(){
    const id = dId.value;
    const payload = {
      nome: dNome.value,
      cognome: dCognome.value,
      email: dEmail.value,
      phone: dPhone.value,
      telegram: dTelegram.value,
    };
    const res = await fetch(`/admin/api/admin/users/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(res.ok){
      showToast('Utente aggiornato con successo');
      closeModal();
      fetchUsers();
    }
  }

  tbody.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-details');
    if(btn){ loadDetail(btn.getAttribute('data-id')); return; }
    const pbtn = e.target.closest('.btn-portfolio');
    if(pbtn){ loadPortfolio(pbtn.getAttribute('data-id')); }
  });

  closeModalBtn.addEventListener('click', closeModal);
  closePortfolioBtn.addEventListener('click', closePortfolio);
  saveBtn.addEventListener('click', saveDetail);
  deleteBtn.addEventListener('click', async ()=>{
    const id = dId.value;
    const adminPwd = prompt('Inserisci la password dell\'admin per confermare l\'eliminazione');
    if(adminPwd === null || adminPwd === '') return;
    const res = await fetch(`/admin/api/admin/users/${id}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ admin_password: adminPwd })
    });
    if(res.ok){
      showToast('Utente eliminato');
      closeModal();
      fetchUsers();
    } else {
      const err = await res.json().catch(()=>({error:'Errore'}));
      alert(err.error || 'Errore eliminazione');
    }
  });
  // Pulsante Salva Saldi rimosso definitivamente

  // Save a single investment row
  portfolioTbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.inv-save');
    if(!btn) return;
    const invid = btn.getAttribute('data-invid');
    const amount = document.querySelector(`input.inv-amount[data-invid="${invid}"]`).value;
    const status = document.querySelector(`select.inv-status[data-invid="${invid}"]`).value;
    const res = await fetch(`/admin/api/admin/users/${currentPortfolioUserId}/portfolio/investments/${invid}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: parseFloat(amount || '0'), status })
    });
    if(res.ok){
      showToast('Investimento aggiornato');
      fetchUsers();
    }
  });

  function debouncedFetch(){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fetchUsers, 250);
  }

  searchEl.addEventListener('input', debouncedFetch);
  refreshBtn.addEventListener('click', fetchUsers);
  selectAll.addEventListener('change', ()=>{
    document.querySelectorAll('.row-sel').forEach(cb=> cb.checked = selectAll.checked);
  });

  async function runBulk(op){
    const ids = Array.from(document.querySelectorAll('.row-sel:checked')).map(cb=> parseInt(cb.getAttribute('data-id')));
    if(ids.length === 0){ showToast('Seleziona almeno un utente'); return; }
    const amountStr = prompt(op === 'add' ? 'Inserisci importo da aggiungere (EUR)' : 'Inserisci importo da rimuovere (EUR)');
    if(amountStr === null) return;
    const amount = parseFloat(amountStr);
    if(!(amount > 0)){ showToast('Importo non valido'); return; }
    const res = await fetch('/admin/api/admin/users/portfolio/bulk-adjust', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_ids: ids, op, amount })
    });
    if(res.ok){
      showToast('Operazione completata');
      fetchUsers();
    } else {
      const err = await res.json().catch(()=>({error:'Errore'}));
      alert(err.error || 'Errore');
    }
  }

  bulkAddBtn.addEventListener('click', ()=> runBulk('add'));
  bulkRemoveBtn.addEventListener('click', ()=> runBulk('remove'));
  viewHistoryBtn.addEventListener('click', loadGlobalHistory);

  // Auto load latest users on enter of the page
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState === 'visible') fetchUsers();
  });

  // Funzione per salvare le modifiche del portfolio
  async function savePortfolio(userId) {
    try {
      const freeCapital = parseFloat(document.getElementById('pf-free').value) || 0;
      const investedCapital = parseFloat(document.getElementById('pf-invested').value) || 0;
      const referralBonus = parseFloat(document.getElementById('pf-referral').value) || 0;
      const profits = parseFloat(document.getElementById('pf-profits').value) || 0;
      
      const payload = {
        free_capital: freeCapital,
        invested_capital: investedCapital,
        referral_bonus: referralBonus,
        profits: profits
      };
      
      const res = await fetch(`/admin/api/admin/users/${userId}/portfolio`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (res.ok) {
        showToast('Portfolio aggiornato con successo');
        closePortfolio();
        // Ricarica i dati del portfolio per mostrare i valori aggiornati
        loadPortfolio(userId);
      } else {
        const error = await res.json().catch(() => ({ error: 'Errore sconosciuto' }));
        alert('Errore nel salvataggio: ' + (error.error || 'Errore sconosciuto'));
      }
    } catch (error) {
      console.error('Errore nel salvataggio portfolio:', error);
      alert('Errore di connessione durante il salvataggio');
    }
  }

  // Initial load
  fetchUsers();
  
  async function loadPortfolio(id){
    const res = await fetch(`/admin/api/admin/users/${id}/portfolio`);
    const data = await res.json();
    const b = data.balances || {};
    const formatter = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });
    portfolioSummary.innerHTML = `
      <div class="card" style="padding:10px; text-align:center;">
        <div class="chip chip-blue">Disponibile</div>
        <input id="pf-free" type="number" step="0.01" value="${b.free_capital||0}" style="margin-top:6px; width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; text-align:center;" />
      </div>
      <div class="card" style="padding:10px; text-align:center;">
        <div class="chip chip-blue">Investito</div>
        <input id="pf-invested" type="number" step="0.01" value="${b.invested_capital||0}" style="margin-top:6px; width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; text-align:center;" />
      </div>
      <div class="card" style="padding:10px; text-align:center;">
        <div class="chip chip-blue">Referral</div>
        <input id="pf-referral" type="number" step="0.01" value="${b.referral_bonus||0}" style="margin-top:6px; width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; text-align:center;" />
      </div>
      <div class="card" style="padding:10px; text-align:center;">
        <div class="chip chip-blue">Profitti</div>
        <input id="pf-profits" type="number" step="0.01" value="${b.profits||0}" style="margin-top:6px; width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:10px; text-align:center;" />
      </div>
      <div class="card" style="padding:10px; text-align:center;">
        <div class="chip chip-green">Totale</div>
        <div style="margin-top:6px; font-weight:700;">${formatter.format(b.total||0)}</div>
      </div>
    `;
    
    // Aggiungi pulsante Salva
    const saveButton = document.createElement('div');
    saveButton.style.cssText = 'margin-top: 20px; text-align: center;';
    saveButton.innerHTML = `
      <button id="save-portfolio" class="btn" style="background: #10b981; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px;">
        💾 Salva Modifiche
      </button>
      <button id="cancel-portfolio" class="btn" style="background: #6b7280; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        ❌ Annulla
      </button>
    `;
    portfolioSummary.appendChild(saveButton);
    
    // Event listeners per i pulsanti
    document.getElementById('save-portfolio').addEventListener('click', () => savePortfolio(id));
    document.getElementById('cancel-portfolio').addEventListener('click', closePortfolio);
    
    // Aggiorna totale in tempo reale quando si modificano i valori
    const inputs = ['pf-free', 'pf-invested', 'pf-referral', 'pf-profits'];
    inputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      if (input) {
        input.addEventListener('input', updateTotal);
      }
    });
    
    function updateTotal() {
      const free = parseFloat(document.getElementById('pf-free').value) || 0;
      const invested = parseFloat(document.getElementById('pf-invested').value) || 0;
      const referral = parseFloat(document.getElementById('pf-referral').value) || 0;
      const profits = parseFloat(document.getElementById('pf-profits').value) || 0;
      const total = free + invested + referral + profits;
      
      const totalElement = document.querySelector('#portfolio-summary .chip-green').parentElement;
      totalElement.innerHTML = `
        <div class="chip chip-green">Totale</div>
        <div style="margin-top:6px; font-weight:700;">${new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(total)}</div>
      `;
    }
    
    portfolioTbody.innerHTML = '';
    for(const inv of (data.investments||[])){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:14px;">${inv.project_name||'-'}</td>
        <td style="padding:14px;">
          <input type="number" step="0.01" value="${inv.amount||0}" data-invid="${inv.id}" class="inv-amount" style="width:120px; padding:6px; border:1px solid #e5e7eb; border-radius:8px;" />
        </td>
        <td style="padding:14px; text-transform:capitalize;">
          <select data-invid="${inv.id}" class="inv-status" style="padding:6px; border:1px solid #e5e7eb; border-radius:8px;">
            <option value="active" ${inv.status==='active'?'selected':''}>active</option>
            <option value="completed" ${inv.status==='completed'?'selected':''}>completed</option>
            <option value="cancelled" ${inv.status==='cancelled'?'selected':''}>cancelled</option>
          </select>
        </td>
        <td style="padding:14px; display:flex; align-items:center; gap:8px;">
          ${(inv.created_at||'').slice(0,10)}
          <button class="btn-theme btn-small inv-save" data-invid="${inv.id}">Salva</button>
        </td>
      `;
      portfolioTbody.appendChild(tr);
    }
    openPortfolio();
    currentPortfolioUserId = id;
  }

  function humanizeAction(action){
    const map = {
      'portfolio_add': 'Aggiunta fondi al portafoglio',
      'portfolio_remove': 'Rimozione fondi dal portafoglio',
      'profits_add': 'Aggiunta profitti',
      'profits_remove': 'Rimozione profitti',
      'referral_bonus_add': 'Aggiunta bonus referral',
      'referral_bonus_remove': 'Rimozione bonus referral',
      'investment_create': 'Nuovo investimento',
      'investment_update': 'Aggiornamento investimento',
      'investment_delete': 'Eliminazione investimento',
      'withdrawal_request': 'Richiesta di prelievo',
      'withdrawal_complete': 'Prelievo completato',
      'withdrawal_reject': 'Prelievo rifiutato'
    };
    if(!action) return '';
    return map[action] || action.replace(/_/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
  }

  async function getUserName(userId){
    if(!userId) return '';
    if(userNameCache[userId]) return userNameCache[userId];
    try{
      const r = await fetch(`/admin/api/admin/users/${userId}`);
      if(r.ok){
        const u = await r.json();
        const name = (u.full_name || `${u.nome||''} ${u.cognome||''}`).trim();
        userNameCache[userId] = name;
        return name;
      }
    }catch(_){ }
    return '';
  }

  async function loadGlobalHistory(){
    // Show modal immediately with loading state
    portfolioSummary.innerHTML = '<div style="grid-column:1/-1; font-weight:600;">Storico globale utenti</div>';
    portfolioTbody.innerHTML = '<tr><td style="padding:14px;" colspan="4">Caricamento...</td></tr>';
    openPortfolio();
    try {
      const res = await fetch('/admin/api/admin/users/history');
      if(!res.ok){
        portfolioTbody.innerHTML = '<tr><td style="padding:14px; color:#b91c1c;" colspan="4">Errore nel caricamento dello storico</td></tr>';
        return;
      }
      const data = await res.json();
      currentHistoryItems = data.items || [];
      portfolioTbody.innerHTML = '';
      for(const item of currentHistoryItems){
        const tr = document.createElement('tr');
        tr.className = 'history-row';
        tr.setAttribute('data-history-id', String(item.id));
        tr.style.cursor = 'pointer';
        tr.innerHTML = `
          <td style="padding:14px;" colspan="4">
            <div style="display:flex; justify-content:space-between; gap:12px;">
              <span>
                <strong>${humanizeAction(item.action)}</strong>
                <span class="user-inline" data-user-id="${item.target_type==='user'?item.target_id:''}"></span>
                — ${item.details||''} (admin: ${item.admin_email||item.admin_id})
              </span>
              <span style="color:#64748b;">${(item.created_at||'').slice(0,19).replace('T',' ')}</span>
            </div>
          </td>`;
        portfolioTbody.appendChild(tr);
        // Enrich with username asynchronously (solo azioni su singolo utente)
        if(item.target_type === 'user' && item.target_id){
          getUserName(item.target_id).then(name=>{
            const span = tr.querySelector('.user-inline');
            if(span && name) span.textContent = ` per ${name}`;
          });
        }
      }
      if(!portfolioTbody.children.length){
        portfolioTbody.innerHTML = '<tr><td style="padding:14px;" colspan="4">Nessuna azione registrata</td></tr>';
      }
    } catch (err) {
      portfolioTbody.innerHTML = '<tr><td style="padding:14px; color:#b91c1c;" colspan="4">Errore imprevisto</td></tr>';
    }
  }
  async function loadHistory(id){
    const res = await fetch(`/admin/api/admin/users/${id}/history`);
    const data = await res.json();
    currentHistoryItems = data.items || [];
    portfolioSummary.innerHTML = '<div style="grid-column:1/-1; font-weight:600;">Storico modifiche</div>';
    portfolioTbody.innerHTML = '';
    for(const item of currentHistoryItems){
      const tr = document.createElement('tr');
      tr.className = 'history-row';
      tr.setAttribute('data-history-id', String(item.id));
      tr.style.cursor = 'pointer';
      tr.innerHTML = `
        <td style="padding:14px;" colspan="4">
          <div style="display:flex; justify-content:space-between;">
            <span>
              <strong>${humanizeAction(item.action)}</strong>
              <span class="user-inline" data-user-id="${item.target_type==='user'?item.target_id:''}"></span>
              — ${item.details||''}
            </span>
            <span style="color:#64748b;">${(item.created_at||'').slice(0,19).replace('T',' ')}</span>
          </div>
        </td>`;
      portfolioTbody.appendChild(tr);
      if(item.target_type === 'user' && item.target_id){
        getUserName(item.target_id).then(name=>{
          const span = tr.querySelector('.user-inline');
          if(span && name) span.textContent = ` per ${name}`;
        });
      }
    }
    openPortfolio();
  }

  portfolioTbody.addEventListener('click', async (e)=>{
    const row = e.target.closest('tr.history-row');
    if(!row) return;
    const id = parseInt(row.getAttribute('data-history-id')||'0');
    const item = currentHistoryItems.find(x=>x.id===id);
    if(!item) return;
    await showHistoryDetail(item);
  });

  async function showHistoryDetail(item){
    const date = new Date(item.created_at || Date.now());
    const dateStr = date.toLocaleDateString('it-IT');
    const timeStr = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    let userLine = '';
    try{
      if(item.target_type === 'user' && item.target_id){
        const r = await fetch(`/admin/api/admin/users/${item.target_id}`);
        if(r.ok){
          const u = await r.json();
          const name = (u.full_name || `${u.nome||''} ${u.cognome||''}`).trim();
          if(name) userLine = ` per ${name}`;
        }
      }
    }catch(_){ /* ignore */ }

    const details = item.details || '';
    const html = `
      <div style="grid-column:1/-1; font-weight:600;">Dettaglio azione</div>
      <div class="card" style="padding:16px;">
        <div style="font-weight:700; font-size:16px; margin-bottom:8px;">${humanizeAction(item.action)}</div>
        <div style="color:#334155; margin-bottom:6px;">${details}${userLine}</div>
        <div style="color:#64748b;">Eseguito da: ${item.admin_email || item.admin_id} • ${dateStr} alle ${timeStr}</div>
      </div>
    `;
    portfolioSummary.innerHTML = html;
    portfolioTbody.innerHTML = '';
  }
})();
</script>
{% endblock %}
