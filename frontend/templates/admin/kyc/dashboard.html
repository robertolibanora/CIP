{% extends "layouts/admin_base.html" %}

{% block title %}Gestione KYC - Admin CIP Immobiliare{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-card admin-card-body mb-6">
    <div class="admin-flex admin-flex--between">
        <div>
            <h1 class="admin-heading-1">Gestione Verifica KYC</h1>
            <p class="admin-text-small">Approvazione e gestione documenti di identità utenti</p>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="kyc-alerts" class="mb-6"></div>

<!-- KYC Statistics -->
<div class="admin-grid admin-grid--4 mb-6">
    <div class="admin-card admin-card--info">
        <div class="admin-card-body">
            <div class="admin-flex admin-flex--between">
                <div>
                    <h3 class="admin-heading-3 text-blue-800">Totale Utenti</h3>
                    <p class="admin-text-small text-blue-600">Tutti gli utenti registrati</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-4">
                <p class="admin-text-large font-bold text-blue-800" id="total-users">0</p>
            </div>
        </div>
    </div>

    <div class="admin-card admin-card--success">
        <div class="admin-card-body">
            <div class="admin-flex admin-flex--between">
                <div>
                    <h3 class="admin-heading-3 text-green-800">Verificati</h3>
                    <p class="admin-text-small text-green-600">KYC approvato</p>
                </div>
                <div class="p-3 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-4">
                <p class="admin-text-large font-bold text-green-800" id="verified-users">0</p>
            </div>
        </div>
    </div>

    <div class="admin-card admin-card--warning">
        <div class="admin-card-body">
            <div class="admin-flex admin-flex--between">
                <div>
                    <h3 class="admin-heading-3 text-orange-800">In Attesa</h3>
                    <p class="admin-text-small text-orange-600">Documenti caricati</p>
                </div>
                <div class="p-3 bg-orange-100 rounded-lg">
                    <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-4">
                <p class="admin-text-large font-bold text-orange-800" id="pending-users">0</p>
            </div>
        </div>
    </div>

    <div class="admin-card admin-card--error">
        <div class="admin-card-body">
            <div class="admin-flex admin-flex--between">
                <div>
                    <h3 class="admin-heading-3 text-red-800">Rifiutati</h3>
                    <p class="admin-text-small text-red-600">KYC non approvato</p>
                </div>
                <div class="p-3 bg-red-100 rounded-lg">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-4">
                <p class="admin-text-large font-bold text-red-800" id="rejected-users">0</p>
            </div>
        </div>
    </div>
</div>

<!-- KYC Requests Table -->
<div class="admin-card">
    <div class="admin-card-header">
        <div class="admin-flex admin-flex--between">
            <div>
                <h2 class="admin-heading-2">Richieste KYC</h2>
                <p class="admin-text-small">Gestione verifica documenti utenti</p>
            </div>
            <div class="admin-flex">
                <input id="search-filter" type="text" placeholder="Cerca per nome o cognome" class="admin-input admin-btn--sm mr-2" style="min-width:220px" />
                <select id="status-filter" class="admin-input admin-select admin-btn--sm mr-2">
                    <option value="">Tutti gli stati</option>
                    <option value="pending">In attesa</option>
                    <option value="verified">Verificati</option>
                    <option value="rejected">Rifiutati</option>
                    <option value="unverified">Non verificati</option>
                </select>
            </div>
        </div>
    </div>
    <div class="admin-card-body">
        <div class="overflow-x-auto">
            <table class="min-w-full" id="kyc-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left admin-text-caption">Utente</th>
                        <th class="px-4 py-3 text-left admin-text-caption">Stato</th>
                        <th class="px-4 py-3 text-left admin-text-caption">Documenti</th>
                        <th class="px-4 py-3 text-left admin-text-caption">Data Registrazione</th>
                        <th class="px-4 py-3 text-left admin-text-caption">Azioni</th>
                    </tr>
                </thead>
                <tbody id="kyc-tbody">
                    <!-- KYC requests will be loaded here -->
                </tbody>
            </table>
            
            <div id="kyc-empty" class="hidden text-center py-8">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3 class="admin-heading-3 text-gray-500">Nessuna richiesta KYC</h3>
                <p class="admin-text-body text-gray-400">Non ci sono richieste di verifica da visualizzare</p>
            </div>
        </div>
    </div>
</div>

<!-- KYC Detail Modal -->
{% with 
    modal_id='kyc-detail-modal', 
    modal_title='Dettaglio Richiesta KYC', 
    modal_size='xl',
    modal_body='
    <div id="kyc-detail-content">
        <!-- Content will be loaded dynamically -->
    </div>',
    modal_footer="
    <button type=\"button\" class=\"admin-btn admin-btn--secondary\" onclick=\"closeModal('kyc-detail-modal')\">
        Chiudi
    </button>
    <button type=\"button\" class=\"admin-btn admin-btn--error\" onclick=\"kycDashboard.rejectKYC()\" id=\"reject-kyc-btn\">
        <svg class=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z\"/>
        </svg>
        Rifiuta
    </button>
    <button type=\"button\" class=\"admin-btn admin-btn--warning\" onclick=\"kycDashboard.revokeKYC()\" id=\"revoke-kyc-btn\">
        <svg class=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M18.364 5.636l-12.728 12.728M5.636 5.636l12.728 12.728\"/>
        </svg>
        Revoca
    </button>
    <button type=\"button\" class=\"admin-btn admin-btn--success\" onclick=\"kycDashboard.approveKYC()\" id=\"approve-kyc-btn\">
        <svg class=\"w-4 h-4 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/>
        </svg>
        Approva
    </button>"
%}
    {% include 'admin/components/modal.html' %}
{% endwith %}

<!-- Reject KYC Modal -->
{% with 
    modal_id='reject-kyc-modal', 
    modal_title='Rifiuta Verifica KYC', 
    modal_size='md',
    modal_body='
    <form id="reject-kyc-form" class="space-y-4">
        <div class="admin-form-group">
            <label class="admin-label admin-label--required">Motivo del Rifiuto</label>
            <textarea name="reason" class="admin-input admin-textarea" required rows="4"
                      placeholder="Specifica il motivo del rifiuto..." id="reject-reason"></textarea>
        </div>
    </form>',
    modal_footer="
    <button type=\"button\" class=\"admin-btn admin-btn--secondary\" onclick=\"closeModal('reject-kyc-modal')\">
        Annulla
    </button>
    <button type=\"button\" class=\"admin-btn admin-btn--error\" onclick=\"kycDashboard.confirmRejectKYC()\" id=\"confirm-reject-btn\">
        Conferma Rifiuto
    </button>"
%}
    {% include 'admin/components/modal.html' %}
{% endwith %}

{% endblock %}

{% block extra_js %}
<script>
// Lightweight fallback if shared loading helpers are not included
if (typeof setButtonLoading === 'undefined') {
    function setButtonLoading(buttonElement, loading = true, text = 'Caricamento...') {
        if (!buttonElement) return;
        if (loading) {
            buttonElement.disabled = true;
            buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            const originalContent = buttonElement.innerHTML;
            buttonElement.dataset.originalContent = originalContent;
            buttonElement.innerHTML = `
                <div class="admin-spinner w-4 h-4 mr-2"></div>
                ${text}
            `;
        } else {
            buttonElement.disabled = false;
            buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
            if (buttonElement.dataset.originalContent) {
                buttonElement.innerHTML = buttonElement.dataset.originalContent;
                delete buttonElement.dataset.originalContent;
            }
        }
    }
}

// KYC Admin Dashboard Manager
class KYCAdminDashboard {
    constructor() {
        this.currentUserId = null;
        this.requestsCache = [];
        this.init();
    }
    
    async init() {
        await this.loadStats();
        await this.loadRequests();
        this.bindEvents();
    }
    
    async loadStats() {
        try {
            const response = await fetch('/kyc/admin/api/kyc-stats');
            if (response.ok) {
                const stats = await response.json();
                this.renderStats(stats);
            }
        } catch (error) {
            console.error('Errore nel caricamento statistiche:', error);
        }
    }
    
    renderStats(stats) {
        document.getElementById('total-users').textContent = stats.total || 0;
        document.getElementById('verified-users').textContent = stats.verified || 0;
        document.getElementById('pending-users').textContent = stats.pending || 0;
        document.getElementById('rejected-users').textContent = stats.rejected || 0;
    }
    
    async loadRequests() {
        try {
            const response = await fetch('/kyc/admin/api/kyc-requests');
            if (response.ok) {
                const data = await response.json();
                this.requestsCache = data.requests || [];
                this.renderRequests(this.requestsCache);
            }
        } catch (error) {
            console.error('Errore nel caricamento richieste:', error);
        }
    }
    
    renderRequests(requests) {
        const tbody = document.getElementById('kyc-tbody');
        const empty = document.getElementById('kyc-empty');
        
        if (!requests || requests.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        
        empty.classList.add('hidden');
        
        tbody.innerHTML = requests.map(request => {
            const statusColors = {
                'verified': 'success',
                'pending': 'warning',
                'rejected': 'error',
                'unverified': 'gray'
            };
            
            const statusLabels = {
                'verified': 'Verificato',
                'pending': 'In Attesa',
                'rejected': 'Rifiutato',
                'unverified': 'Non Verificato'
            };
            
            return `
                <tr class="border-t border-gray-200 hover:bg-gray-50" data-status="${request.kyc_status}">
                    <td class="px-4 py-3" data-col="name">
                        <p class="admin-text-body font-medium">${request.full_name}</p>
                        <p class="admin-text-caption text-gray-500">${request.email}</p>
                        ${request.telefono ? `<p class="admin-text-caption text-gray-500">${request.telefono}</p>` : ''}
                    </td>
                    <td class="px-4 py-3">
                        <span class="admin-badge admin-badge--${statusColors[request.kyc_status] || 'gray'}">
                            ${statusLabels[request.kyc_status] || request.kyc_status}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="admin-text-body">${request.documents_count || 0} documenti</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="admin-text-small">${new Date(request.created_at).toLocaleDateString('it-IT')}</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="kycDashboard.viewDetail(${request.id})" class="admin-btn admin-btn--secondary admin-btn--sm">
                            Dettagli
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async viewDetail(userId) {
        this.currentUserId = userId;
        
        try {
            const response = await fetch(`/kyc/admin/api/kyc-requests/${userId}`);
            if (response.ok) {
                const user = await response.json();
                this.renderDetail(user);
                openModal('kyc-detail-modal');
            }
        } catch (error) {
            console.error('Errore nel caricamento dettagli:', error);
        }
    }
    
    renderDetail(user) {
        const content = document.getElementById('kyc-detail-content');
        
        const statusColors = {
            'verified': 'success',
            'pending': 'warning',
            'rejected': 'error',
            'unverified': 'gray'
        };
        
        const statusLabels = {
            'verified': 'Verificato',
            'pending': 'In Attesa',
            'rejected': 'Rifiutato',
            'unverified': 'Non Verificato'
        };
        
        content.innerHTML = `
            <div class="space-y-6">
                <!-- User Info -->
                <div class="admin-card admin-card-body">
                    <h3 class="admin-heading-3 mb-4">Informazioni Utente</h3>
                    <div class="admin-grid admin-grid--2">
                        <div>
                            <p class="admin-text-caption text-gray-500">Nome Completo</p>
                            <p class="admin-text-body font-medium">${user.full_name}</p>
                        </div>
                        <div>
                            <p class="admin-text-caption text-gray-500">Email</p>
                            <p class="admin-text-body font-medium">${user.email}</p>
                        </div>
                        <div>
                            <p class="admin-text-caption text-gray-500">Telefono</p>
                            <p class="admin-text-body font-medium">${user.telefono || 'Non fornito'}</p>
                        </div>
                        <div>
                            <p class="admin-text-caption text-gray-500">Stato KYC</p>
                            <span class="admin-badge admin-badge--${statusColors[user.kyc_status] || 'gray'}">
                                ${statusLabels[user.kyc_status] || user.kyc_status}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Documents -->
                <div class="admin-card admin-card-body">
                    <h3 class="admin-heading-3 mb-4">Documenti Caricati</h3>
                    ${user.documents && user.documents.length > 0 ? `
                        <div class="space-y-4">
                            ${user.documents.map(doc => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="admin-flex admin-flex--between items-start">
                                        <div class="flex-1">
                                            <h4 class="admin-text-body font-medium">${doc.category_name}</h4>
                                            <p class="admin-text-caption text-gray-500">
                                                Caricato il ${new Date(doc.uploaded_at).toLocaleDateString('it-IT')}
                                            </p>
                                            ${doc.verified_by_admin ? `
                                                <span class="admin-badge admin-badge--success mt-2">Verificato</span>
                                            ` : `
                                                <span class="admin-badge admin-badge--warning mt-2">In attesa verifica</span>
                                            `}
                                        </div>
                                        <div class="ml-4 admin-flex admin-flex--between">
                                            <a href="/uploads/${doc.file_path}" target="_blank" 
                                               class="admin-btn admin-btn--secondary admin-btn--sm">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                </svg>
                                                Visualizza
                                            </a>
                                            <button class="admin-btn admin-btn--error admin-btn--sm ml-2" onclick="kycDashboard.deleteDocument(${doc.id})">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"/>
                                                </svg>
                                                Elimina
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <p class="admin-text-body text-gray-500">Nessun documento caricato</p>
                    `}
                </div>
            </div>
        `;
        
        // Show/hide action buttons based on status and presence of documents
        const approveBtn = document.getElementById('approve-kyc-btn');
        const rejectBtn = document.getElementById('reject-kyc-btn');
        const revokeBtn = document.getElementById('revoke-kyc-btn');
        
        const hasDocs = Array.isArray(user.documents) && user.documents.length > 0;
        if (user.kyc_status === 'verified') {
            approveBtn.style.display = 'none';
            rejectBtn.style.display = 'none';
            revokeBtn.style.display = 'inline-flex';
        } else {
            // For 'pending', 'rejected' or 'unverified' allow Approva/Rifiuta when documents exist
            approveBtn.style.display = hasDocs ? 'inline-flex' : 'none';
            rejectBtn.style.display = hasDocs ? 'inline-flex' : 'none';
            revokeBtn.style.display = 'none';
        }
    }
    
    async approveKYC() {
        if (!this.currentUserId) return;
        // Rimosso window.confirm: user asked to remove popup template — proceed directly
        const approveBtn = document.getElementById('approve-kyc-btn');
        setButtonLoading(approveBtn, true, 'Approvando...');
        
        try {
            const response = await fetch(`/kyc/admin/api/kyc-requests/${this.currentUserId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            if (response.ok) {
                closeModal('kyc-detail-modal');
                await this.refreshData();
            } else {
                alert(result.error || 'Errore nell\'approvazione');
            }
        } catch (error) {
            console.error('Errore:', error);
            alert('Errore di connessione');
        } finally {
            setButtonLoading(approveBtn, false);
        }
    }

    async deleteDocument(docId) {
        if (!this.currentUserId || !docId) return;
        const confirmed = confirm('Eliminare definitivamente questo documento?');
        if (!confirmed) return;
        try {
            const resp = await fetch(`/kyc/admin/api/kyc-requests/${this.currentUserId}/documents/${docId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (resp.ok && data.ok) {
                // ricarica dettaglio e tabella
                const response = await fetch(`/kyc/admin/api/kyc-requests/${this.currentUserId}`);
                if (response.ok) {
                    const user = await response.json();
                    this.renderDetail(user);
                }
                await this.refreshData();
            } else {
                alert(data.error || 'Errore durante eliminazione');
            }
        } catch (e) {
            alert('Errore di connessione');
        }
    }
    
    async revokeKYC() {
        if (!this.currentUserId) return;
        const revokeBtn = document.getElementById('revoke-kyc-btn');
        setButtonLoading(revokeBtn, true, 'Revocando...');
        try {
            const response = await fetch(`/kyc/admin/api/kyc-requests/${this.currentUserId}/revoke`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            if (response.ok) {
                closeModal('kyc-detail-modal');
                await this.refreshData();
            } else {
                alert(result.error || 'Errore nella revoca');
            }
        } catch (e) { alert('Errore di connessione'); }
        finally { setButtonLoading(revokeBtn, false); }
    }

    async rejectKYC() { openModal('reject-kyc-modal'); }

    async confirmRejectKYC() {
        if (!this.currentUserId) return;
        const reason = document.getElementById('reject-reason').value.trim();
        if (!reason) { alert('Inserisci un motivo per il rifiuto'); return; }
        const rejectBtn = document.getElementById('confirm-reject-btn');
        setButtonLoading(rejectBtn, true, 'Rifiutando...');
        try {
            const response = await fetch(`/kyc/admin/api/kyc-requests/${this.currentUserId}/reject`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reason })
            });
            const result = await response.json();
            if (response.ok) {
                closeModal('reject-kyc-modal');
                closeModal('kyc-detail-modal');
                await this.refreshData();
            } else { alert(result.error || 'Errore nel rifiuto'); }
        } catch (e) { alert('Errore di connessione'); }
        finally { setButtonLoading(rejectBtn, false); }
    }

    async refreshData() { await this.loadStats(); await this.loadRequests(); }
    
    filterByStatus(status) {
        const rows = document.querySelectorAll('#kyc-tbody tr');
        const query = (document.getElementById('search-filter').value || '').trim().toLowerCase();
        rows.forEach(row => {
            const matchesStatus = (status === '' || row.dataset.status === status);
            const name = (row.querySelector('[data-col="name"]').textContent || '').toLowerCase();
            const matchesSearch = !query || name.includes(query);
            row.style.display = (matchesStatus && matchesSearch) ? '' : 'none';
        });
    }
    
    bindEvents() {
        document.getElementById('status-filter').addEventListener('change', (e) => {
            this.filterByStatus(e.target.value);
        });
        const search = document.getElementById('search-filter');
        search.addEventListener('input', () => {
            const status = document.getElementById('status-filter').value;
            this.filterByStatus(status);
        });
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => { window.kycDashboard = new KYCAdminDashboard(); });
function refreshData() { if (window.kycDashboard) window.kycDashboard.refreshData(); }
</script>
{% endblock %}
