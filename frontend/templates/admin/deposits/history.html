{% extends "layouts/admin_base.html" %}

{% block title %}Storico Depositi - Admin{% endblock %}

{% block content %}
<!-- Storico Depositi Admin -->
<div class="space-y-6">
    <!-- Page Header -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div>
                <h1 class="admin-heading-1">Storico Depositi</h1>
                <p class="admin-text-small">Visualizza e gestisci tutti i depositi del sistema</p>
            </div>
            <div class="mt-3 sm:mt-0">
                <a href="/admin/deposits" class="admin-btn admin-btn--primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Torna ai Depositi
                </a>
            </div>
        </div>
    </div>

    <!-- Filtri e Ricerca -->
    <div class="admin-card admin-card-body">
        <div class="admin-flex admin-flex--between">
            <div class="admin-flex admin-flex--gap-4">
                <div>
                    <label for="status-filter" class="admin-label">Stato</label>
                    <select id="status-filter" class="admin-select" onchange="filterDeposits()">
                        <option value="">Tutti gli stati</option>
                        <option value="pending">In attesa</option>
                        <option value="approved">Approvati</option>
                        <option value="rejected">Rifiutati</option>
                    </select>
                </div>
                
                <div>
                    <label for="method-filter" class="admin-label">Metodo</label>
                    <select id="method-filter" class="admin-select" onchange="filterDeposits()">
                        <option value="">Tutti i metodi</option>
                        <option value="usdt">USDT (BEP20)</option>
                        <option value="bank">Bonifico Bancario</option>
                    </select>
                </div>
                
                <div>
                    <label for="search-filter" class="admin-label">Ricerca</label>
                    <input type="text" id="search-filter" class="admin-input" placeholder="Nome, cognome, email..." onkeyup="filterDeposits()">
                </div>
            </div>
            
            <div class="admin-flex admin-flex--gap-2">
                <button onclick="refreshDeposits()" class="admin-btn admin-btn--secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Aggiorna
                </button>
                <button onclick="deleteAllDeposits()" class="admin-btn admin-btn--danger">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Elimina Storico
                </button>
            </div>
        </div>
    </div>

    <!-- Lista Storico Depositi -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2 class="admin-heading-3">Storico Completo</h2>
            <span class="admin-text-small text-gray-500" id="deposits-count">0 depositi trovati</span>
        </div>

        <div class="admin-card-body">
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="admin-table-th">Utente</th>
                            <th class="admin-table-th">Importo</th>
                            <th class="admin-table-th">Metodo</th>
                            <th class="admin-table-th">Dettagli</th>
                            <th class="admin-table-th">Stato</th>
                            <th class="admin-table-th">Data Richiesta</th>
                            <th class="admin-table-th">Data Approvazione</th>
                            <th class="admin-table-th">Approvato da</th>
                            <th class="admin-table-th">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table-body">
                        <tr>
                            <td colspan="9" class="admin-table-td text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="text-gray-500 mt-2">Caricamento storico...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginazione -->
            <div id="pagination" class="admin-flex admin-flex--between admin-flex--items-center mt-6">
                <!-- Paginazione sar√† inserita qui dinamicamente -->
            </div>
        </div>
    </div>
</div>

<!-- Deposit Details Modal -->
<div id="deposit-details-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay" onclick="closeDepositModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3 class="admin-heading-3">Dettagli Deposito</h3>
            <button onclick="closeDepositModal()" class="admin-modal-close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="deposit-details-content" class="admin-modal-body">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="admin-modal hidden">
    <div class="admin-modal-overlay"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-body text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Caricamento...</p>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {
    status: '',
    method: '',
    search: ''
};

// Carica storico al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    // Verifica autenticazione prima di caricare i dati
    checkAuthentication();
});

// Verifica autenticazione
async function checkAuthentication() {
    try {
        const response = await fetch('/auth/check', {
            method: 'GET',
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.authenticated && data.is_admin) {
                loadDepositsHistory();
            } else {
                showError('Accesso negato. Solo gli amministratori possono visualizzare questa pagina.');
                setTimeout(() => {
                    window.location.href = '/auth/login';
                }, 2000);
            }
        } else {
            showError('Errore di autenticazione. Effettua nuovamente il login.');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        }
    } catch (error) {
        console.error('Errore verifica autenticazione:', error);
        showError('Errore di connessione. Verifica la connessione internet e riprova.');
    }
}

// Carica storico depositi
async function loadDepositsHistory(page = 1) {
    try {
        currentPage = page;
        const params = new URLSearchParams({
            page: page,
            ...currentFilters
        });
        
        console.log('üîÑ Caricamento storico depositi...', {page, filters: currentFilters});
        
        // Mostra loading
        const tbody = document.getElementById('deposits-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="admin-table-td text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-500 mt-2">Caricamento storico...</p>
                </td>
            </tr>
        `;
        
        const response = await fetch(`/deposits/api/admin/history?${params}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (response.status === 401) {
            console.error('‚ùå Sessione scaduta');
            showError('Sessione scaduta. Effettua nuovamente il login.');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
            return;
        }
        
        if (response.status === 403) {
            console.error('‚ùå Accesso negato');
            showError('Accesso negato. Non hai i permessi per visualizzare questa pagina.');
            return;
        }
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Errore HTTP:', response.status, errorText);
            showError(`Errore del server (${response.status}): ${errorText}`);
            return;
        }
        
        const data = await response.json();
        console.log('‚úÖ Response data:', data);
        
        if (data.deposits && Array.isArray(data.deposits)) {
            renderDeposits(data.deposits);
            renderPagination(data.pagination);
            document.getElementById('deposits-count').textContent = `${data.pagination.total_count} depositi trovati`;
            console.log('‚úÖ Storico caricato con successo:', data.deposits.length, 'depositi');
        } else {
            console.error('‚ùå Formato dati non valido:', data);
            showError('Formato dati non valido ricevuto dal server');
        }
    } catch (error) {
        console.error('‚ùå Errore nel caricamento storico:', error);
        showError('Errore di connessione: ' + error.message);
    }
}

// Renderizza depositi nella tabella
function renderDeposits(deposits) {
    const tbody = document.getElementById('deposits-table-body');
    
    if (deposits.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="admin-table-td text-center py-8">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun deposito</h3>
                    <p class="text-gray-600">Non ci sono depositi che corrispondono ai filtri selezionati.</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = deposits.map(deposit => `
        <tr class="admin-table-tr" 
            data-status="${deposit.status}" 
            data-method="${deposit.method}"
            data-search="${(deposit.full_name || '').toLowerCase()} ${(deposit.email || '').toLowerCase()}">
            <td class="admin-table-td">
                <div>
                    <p class="font-medium text-gray-900">${deposit.full_name || 'Utente'}</p>
                    <p class="text-sm text-gray-500">${deposit.email || ''}</p>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="font-semibold text-green-600">‚Ç¨${parseFloat(deposit.amount).toLocaleString('it-IT', {minimumFractionDigits:2})}</span>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${deposit.method === 'usdt' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                    ${deposit.method === 'usdt' ? 'USDT (BEP20)' : 'Bonifico Bancario'}
                </span>
            </td>
            <td class="admin-table-td">
                <div class="text-sm">
                    <p class="font-mono text-xs break-all">${deposit.iban || deposit.wallet_address || '-'}</p>
                </div>
            </td>
            <td class="admin-table-td">
                <span class="px-2 py-1 text-xs font-medium rounded-full ${
                    deposit.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                    deposit.status === 'approved' ? 'bg-green-100 text-green-800' :
                    'bg-red-100 text-red-800'
                }">
                    ${deposit.status === 'pending' ? 'In Attesa' :
                      deposit.status === 'approved' ? 'Approvato' :
                      deposit.status === 'rejected' ? 'Rifiutato' : deposit.status}
                </span>
            </td>
            <td class="admin-table-td">
                <div>
                    <p class="text-sm text-gray-900">${new Date(deposit.created_at).toLocaleDateString('it-IT')}</p>
                    <p class="text-xs text-gray-500">${new Date(deposit.created_at).toLocaleTimeString('it-IT')}</p>
                </div>
            </td>
            <td class="admin-table-td">
                ${deposit.approved_at ? `
                    <div>
                        <p class="text-sm text-gray-900">${new Date(deposit.approved_at).toLocaleDateString('it-IT')}</p>
                        <p class="text-xs text-gray-500">${new Date(deposit.approved_at).toLocaleTimeString('it-IT')}</p>
                    </div>
                ` : '<span class="text-gray-400">-</span>'}
            </td>
            <td class="admin-table-td">
                <span class="text-sm text-gray-900">${deposit.approved_by_name || '-'}</span>
            </td>
            <td class="admin-table-td">
                <div class="flex gap-2">
                    <button onclick="viewDepositDetails(${deposit.id})" class="admin-btn admin-btn--secondary admin-btn--sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Dettagli
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Renderizza paginazione
function renderPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    
    if (pagination.total_pages <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let paginationHTML = `
        <div class="admin-text-small text-gray-500">
            Pagina ${pagination.page} di ${pagination.total_pages} (${pagination.total_count} depositi totali)
        </div>
        <div class="admin-flex admin-flex--gap-2">
    `;
    
    // Pulsante precedente
    if (pagination.page > 1) {
        paginationHTML += `
            <button onclick="loadDepositsHistory(${pagination.page - 1})" class="admin-btn admin-btn--secondary admin-btn--sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Precedente
            </button>
        `;
    }
    
    // Numeri pagina
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button onclick="loadDepositsHistory(${i})" 
                    class="admin-btn admin-btn--sm ${i === pagination.page ? 'admin-btn--primary' : 'admin-btn--secondary'}">
                ${i}
            </button>
        `;
    }
    
    // Pulsante successivo
    if (pagination.page < pagination.total_pages) {
        paginationHTML += `
            <button onclick="loadDepositsHistory(${pagination.page + 1})" class="admin-btn admin-btn--secondary admin-btn--sm">
                Successivo
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        `;
    }
    
    paginationHTML += '</div>';
    paginationDiv.innerHTML = paginationHTML;
}

// Filtra depositi
function filterDeposits() {
    currentFilters.status = document.getElementById('status-filter').value;
    currentFilters.method = document.getElementById('method-filter').value;
    currentFilters.search = document.getElementById('search-filter').value;
    
    loadDepositsHistory(1); // Ricarica dalla prima pagina
}

// Aggiorna depositi
function refreshDeposits() {
    loadDepositsHistory(currentPage);
    showNotification('Storico aggiornato', 'success');
}

// Elimina tutto lo storico
async function deleteAllDeposits() {
    if (!confirm('Sei sicuro di voler eliminare TUTTO lo storico dei depositi? Questa azione non pu√≤ essere annullata!')) {
        return;
    }
    
    if (!confirm('CONFERMA FINALE: Eliminare tutti i depositi dal database?')) {
        return;
    }
    
    try {
        showLoading();
        const response = await fetch('/deposits/api/admin/delete-all', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`Eliminati ${data.deleted_count} depositi`, 'success');
            loadDepositsHistory(1);
        } else {
            showError('Errore nell\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
        }
    } catch (error) {
        console.error('Errore eliminazione:', error);
        showError('Errore nell\'eliminazione dei depositi');
    } finally {
        hideLoading();
    }
}

// Visualizza dettagli deposito
function viewDepositDetails(id) {
    // Per ora mostriamo solo un alert, poi possiamo implementare un modal
    alert('Dettagli deposito ID: ' + id + '\n\nFunzionalit√† in sviluppo...');
}

// Chiudi modal
function closeDepositModal() {
    document.getElementById('deposit-details-modal').classList.add('hidden');
}

// Mostra loading
function showLoading() {
    document.getElementById('loading-modal').classList.remove('hidden');
}

// Nascondi loading
function hideLoading() {
    document.getElementById('loading-modal').classList.add('hidden');
}

// Mostra notifica di successo
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Mostra errore
function showError(message) {
    showNotification(message, 'error');
}
</script>
{% endblock %}