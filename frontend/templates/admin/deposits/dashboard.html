{% extends "layouts/admin_base.html" %}

{% block title %}Depositi - Live{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="admin-card admin-card-body">
    <div class="admin-flex admin-flex--between">
      <div>
        <h1 class="admin-heading-1">Depositi</h1>
        <p class="admin-text-small">Richieste in tempo reale</p>
      </div>
      <div class="admin-badge admin-badge--info">Live</div>
    </div>
  </div>

  <div class="admin-grid admin-grid--4" id="metrics">
    <div class="admin-card admin-card-body"><div class="admin-text-small">In attesa</div><div id="m-pending" class="admin-heading-2">0</div></div>
    <div class="admin-card admin-card-body"><div class="admin-text-small">Completate</div><div id="m-completed" class="admin-heading-2">0</div></div>
    <div class="admin-card admin-card-body"><div class="admin-text-small">Rifiutate</div><div id="m-failed" class="admin-heading-2">0</div></div>
    <div class="admin-card admin-card-body"><div class="admin-text-small">Totale Raccolto</div><div id="m-total" class="admin-heading-2">€0</div></div>
  </div>

  <div class="admin-card admin-card-body">
    <div class="admin-flex admin-flex--between">
      <div class="admin-flex admin-flex--gap-4">
        <div>
          <label class="admin-label">Stato</label>
          <select id="status-filter" class="admin-select">
            <option value="">Tutti</option>
            <option value="pending">In attesa</option>
            <option value="completed">Completate</option>
            <option value="failed">Rifiutate</option>
          </select>
        </div>
        <div>
          <label class="admin-label">Ricerca</label>
          <input id="search-filter" class="admin-input" placeholder="Nome, email...">
        </div>
      </div>
      <button id="force-refresh" class="admin-btn admin-btn--secondary">Aggiorna</button>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <h2 class="admin-heading-3">Richieste</h2>
      <span id="rows-count" class="admin-text-small text-gray-500">0 richieste</span>
    </div>
    <div class="admin-card-body">
      <div class="overflow-x-auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th class="admin-table-th">Utente</th>
              <th class="admin-table-th">Importo</th>
              <th class="admin-table-th">Riferimento</th>
              <th class="admin-table-th">Stato</th>
              <th class="admin-table-th">Data</th>
              <th class="admin-table-th">Azioni</th>
            </tr>
          </thead>
          <tbody id="deposits-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
let deposits = [];
let lastId = 0;

async function fetchStats(){
  const r = await fetch('/admin/api/deposit-stats');
  if(!r.ok) return;
  const s = await r.json();
  document.getElementById('m-pending').textContent = s.pending;
  document.getElementById('m-completed').textContent = s.completed;
  document.getElementById('m-failed').textContent = s.failed;
  document.getElementById('m-total').textContent = `€${(s.total_amount||0).toLocaleString('it-IT', {minimumFractionDigits:0})}`;
  lastId = s.last_id || lastId;
}

async function fetchList(){
  const status = document.getElementById('status-filter').value || 'pending';
  const r = await fetch(`/admin/api/deposit-requests?status=${encodeURIComponent(status)}`);
  if(!r.ok) return;
  deposits = await r.json();
  renderTable();
}

function renderTable(){
  const search = (document.getElementById('search-filter').value||'').toLowerCase();
  const tbody = document.getElementById('deposits-table-body');
  const rows = deposits.filter(d=>{
    const txt = `${(d.full_name||'').toLowerCase()} ${(d.email||'').toLowerCase()}`;
    return !search || txt.includes(search);
  }).map(d=>`
    <tr class="admin-table-tr" data-id="${d.id}">
      <td class="admin-table-td"><div><div class="admin-text-body font-medium">${d.full_name||'N/A'}</div><div class="admin-text-small text-gray-500">${d.email||''}</div></div></td>
      <td class="admin-table-td"><span class="admin-text-body font-medium">€${parseFloat(d.amount).toLocaleString('it-IT',{minimumFractionDigits:2})}</span></td>
      <td class="admin-table-td"><div><div class="admin-text-body font-medium">${d.payment_reference||'N/A'}</div><div class="admin-text-small text-gray-500">${(d.unique_key||'').slice(0,8)}...</div></div></td>
      <td class="admin-table-td">${badge(d.status)}</td>
      <td class="admin-table-td"><div class="admin-text-body">${fmtDate(d.created_at)}</div><div class="admin-text-small text-gray-500">${fmtTime(d.created_at)}</div></td>
      <td class="admin-table-td">
        <div class="admin-flex admin-flex--gap-2">
          ${d.status==='pending'?`<button onclick="approve(${d.id})" class="admin-btn admin-btn--success admin-btn--sm">✓</button><button onclick="reject(${d.id})" class="admin-btn admin-btn--error admin-btn--sm">✕</button>`:''}
        </div>
      </td>
    </tr>
  `).join('');
  tbody.innerHTML = rows || `<tr><td class="admin-table-td" colspan="6">Nessun risultato</td></tr>`;
  document.getElementById('rows-count').textContent = `${deposits.length} richieste`;
}

function badge(s){
  if(s==='completed') return '<span class="admin-badge admin-badge--success">Completata</span>';
  if(s==='failed') return '<span class="admin-badge admin-badge--error">Rifiutata</span>';
  return '<span class="admin-badge admin-badge--warning">In attesa</span>';
}
function fmtDate(dt){ try{ return new Date(dt).toLocaleDateString('it-IT'); }catch(_){ return '' } }
function fmtTime(dt){ try{ return new Date(dt).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'}); }catch(_){ return '' } }

async function approve(id){
  const r = await fetch('/admin/api/deposit-requests/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deposit_id:id})});
  if(r.ok){ await fetchStats(); await fetchList(); }
}
async function reject(id){
  const reason = prompt('Motivo (opzionale):') || 'Rifiutata da admin';
  const r = await fetch('/admin/api/deposit-requests/reject',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deposit_id:id,admin_notes:reason})});
  if(r.ok){ await fetchStats(); await fetchList(); }
}

// Polling
let timer;
function startPolling(){
  clearInterval(timer);
  timer = setInterval(async ()=>{ await fetchStats(); await fetchList(); }, 4000);
}

document.getElementById('status-filter').addEventListener('change', fetchList);
document.getElementById('search-filter').addEventListener('input', renderTable);
document.getElementById('force-refresh').addEventListener('click', async ()=>{ await fetchStats(); await fetchList(); });

document.addEventListener('DOMContentLoaded', async ()=>{
  await fetchStats();
  await fetchList();
  startPolling();
});
</script>
{% endblock %}
