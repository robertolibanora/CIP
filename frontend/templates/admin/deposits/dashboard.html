{% extends "layouts/admin_base.html" %}

{% block title %}Depositi{% endblock %}

{% block content %}
<style>
.notification-popup {
  transform: translateX(100%);
  opacity: 0;
}
</style>
<div class="max-w-7xl mx-auto">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Richieste Deposito</h2>
    <div class="flex items-center gap-4">
      <a href="/deposits/admin/deposits/history" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
        Storico Depositi
      </a>
      <span id="pending-indicator" class="hidden animate-pulse inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">Nuove richieste</span>
    </div>
  </div>

  <!-- Metriche Depositi -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-500">In Attesa</p>
          <p class="text-3xl font-bold text-orange-600" id="pending-count">-</p>
        </div>
        <div class="text-orange-600">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-500">Completati</p>
          <p class="text-3xl font-bold text-green-600" id="completed-count">-</p>
        </div>
        <div class="text-green-600">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-500">Rifiutati</p>
          <p class="text-3xl font-bold text-red-600" id="rejected-count">-</p>
        </div>
        <div class="text-red-600">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-500">Totale Depositi</p>
          <p class="text-3xl font-bold text-blue-600" id="total-amount">-</p>
        </div>
        <div class="text-blue-600">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <div id="deposits-list" class="space-y-4">
    <div class="text-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
      <p class="text-gray-500 mt-2">Caricamento richieste...</p>
    </div>
  </div>
</div>

<script>
// Carica metriche al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    loadMetrics();
    loadPendingDeposits();
});

// Carica metriche depositi
async function loadMetrics() {
    try {
        const response = await fetch('/deposits/api/admin/metrics');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('pending-count').textContent = data.pending || 0;
            document.getElementById('completed-count').textContent = data.completed || 0;
            document.getElementById('rejected-count').textContent = data.rejected || 0;
            document.getElementById('total-amount').textContent = `€${(data.total_amount || 0).toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
        } else {
            console.error('Errore nel caricamento metriche:', data.error);
        }
    } catch (error) {
        console.error('Errore nel caricamento metriche:', error);
    }
}

async function loadPendingDeposits() {
  const res = await fetch('/deposits/api/admin/pending');
  const data = await res.json();
  const list = document.getElementById('deposits-list');
  if (!res.ok || !data.pending_deposits || data.pending_deposits.length === 0) {
    list.innerHTML = `
      <div class="text-center py-8">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Nessuna richiesta</h3>
        <p class="text-gray-600">Le richieste appariranno qui.</p>
      </div>`;
    document.getElementById('pending-indicator').classList.add('hidden');
    return;
  }
  document.getElementById('pending-indicator').classList.remove('hidden');
  list.innerHTML = data.pending_deposits.map(req => `
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-sm text-gray-500">Utente</p>
          <p class="font-semibold text-gray-900">${req.full_name || 'Utente'} <span class="text-gray-500 text-sm">(${req.email || ''})</span></p>
        </div>
        <span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">In attesa</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-4 text-sm">
        <div>
          <p class="text-gray-500 mb-1">Importo</p>
          <p class="font-medium">€${parseFloat(req.amount).toLocaleString('it-IT', {minimumFractionDigits:2})}</p>
        </div>
        <div>
          <p class="text-gray-500 mb-1">Metodo</p>
          <p class="font-medium">${String((req.method || '')).toLowerCase() === 'usdt' ? 'USDT (BEP20)' : 'Bonifico Bancario'}</p>
        </div>
        <div class="md:col-span-1">
          <p class="text-gray-500 mb-1">${String((req.method||'')).toLowerCase()==='usdt' ? 'Wallet' : 'IBAN'}</p>
          <p class="font-medium font-mono text-xs break-all leading-relaxed">${req.iban || ''}</p>
        </div>
        <div>
          <p class="text-gray-500 mb-1">Chiave</p>
          <p class="font-mono text-xs">${req.unique_key}</p>
        </div>
      </div>
      <div class="mt-3">
        <textarea id="note-${req.id}" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Note amministratore (obbligatorie in caso di rifiuto)"></textarea>
      </div>
      <div class="mt-3 flex gap-2">
        <button onclick="approve(${req.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Approva</button>
        <button onclick="reject(${req.id})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">Rifiuta</button>
      </div>
    </div>
  `).join('');
}

async function approve(id){
  const notes = document.getElementById(`note-${id}`).value;
  const r = await fetch(`/deposits/api/admin/approve/${id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({admin_notes: notes})});
  if(r.ok){ 
    showNotification('Richiesta approvata con successo', 'success');
    loadPendingDeposits();
    loadMetrics(); // Aggiorna le metriche
  }
  else { 
    const j = await r.json(); 
    showNotification((j.error||'Errore approvazione') + (j.debug?`\nDettagli: ${j.debug}`:''), 'error'); 
  }
}
async function reject(id){
  const notes = document.getElementById(`note-${id}`).value || '';
  if(!notes.trim()){ 
    showNotification('Inserisci il motivo del rifiuto', 'error');
    return; 
  }
  
  const r = await fetch(`/deposits/api/admin/reject/${id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({admin_notes: notes})});
  if(r.ok){ 
    showNotification('Richiesta rifiutata con successo', 'success');
    loadPendingDeposits();
    loadMetrics(); // Aggiorna le metriche
  }
  else { 
    const j = await r.json(); 
    showNotification((j.error||'Errore rifiuto') + (j.debug?`\nDettagli: ${j.debug}`:''), 'error'); 
  }
}

// Funzione per mostrare notifiche
function showNotification(message, type = 'info') {
  // Rimuovi notifiche esistenti
  const existingNotifications = document.querySelectorAll('.notification-popup');
  existingNotifications.forEach(notif => notif.remove());
  
  // Crea la notifica
  const notification = document.createElement('div');
  notification.className = `notification-popup fixed top-4 right-4 z-50 max-w-sm w-full bg-white rounded-lg shadow-lg border-l-4 p-4 transform transition-all duration-300 ease-in-out`;
  
  // Colori in base al tipo
  const colors = {
    success: 'border-green-500 bg-green-50',
    error: 'border-red-500 bg-red-50',
    warning: 'border-yellow-500 bg-yellow-50',
    info: 'border-blue-500 bg-blue-50'
  };
  
  const icons = {
    success: '✅',
    error: '❌',
    warning: '⚠️',
    info: 'ℹ️'
  };
  
  notification.classList.add(...colors[type].split(' '));
  
  notification.innerHTML = `
    <div class="flex items-start">
      <div class="flex-shrink-0 text-lg">${icons[type]}</div>
      <div class="ml-3 flex-1">
        <p class="text-sm font-medium text-gray-900">${message}</p>
      </div>
      <div class="ml-4 flex-shrink-0">
        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
          <span class="sr-only">Chiudi</span>
          <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </div>
  `;
  
  // Aggiungi al DOM
  document.body.appendChild(notification);
  
  // Animazione di entrata
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
    notification.style.opacity = '1';
  }, 100);
  
  // Auto-rimozione dopo 5 secondi
  setTimeout(() => {
    if (notification.parentElement) {
      notification.style.transform = 'translateX(100%)';
      notification.style.opacity = '0';
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }
  }, 5000);
}

document.addEventListener('DOMContentLoaded', loadPendingDeposits);
</script>
{% endblock %}
