<!DOCTYPE html>
<html>
<head>
    <title>Test Withdrawals - Soluzione Finale</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
    </style>
</head>
<body>
    <h1>Test Sistema Prelievi - Soluzione Finale</h1>
    
    <div class="test-section info">
        <h3>üîß Test API Backend</h3>
        <button onclick="testPendingAPI()">Test API Pending</button>
        <button onclick="testDetailsAPI()">Test API Details (ID 1)</button>
        <button onclick="testDetailsAPI(2)">Test API Details (ID 2 - Bancario)</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test-section info">
        <h3>üéØ Test Pulsante Dettagli</h3>
        <button onclick="testDetailsButton(1)">Test Dettagli USDT (ID 1)</button>
        <button onclick="testDetailsButton(2)">Test Dettagli Bancario (ID 2)</button>
        <div id="button-result"></div>
    </div>
    
    <div class="test-section info">
        <h3>üìä Dati Prelievi Disponibili</h3>
        <div id="withdrawals-list"></div>
    </div>

    <!-- Modal per dettagli -->
    <div id="withdrawal-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="withdrawal-details-content"></div>
        </div>
    </div>

    <script>
        let currentWithdrawals = [];

        // Test API pending
        async function testPendingAPI() {
            try {
                const response = await fetch('/withdrawals/api/admin/pending');
                const data = await response.json();
                
                if (response.ok) {
                    currentWithdrawals = data.withdrawals;
                    document.getElementById('api-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ API Pending funziona!</h4>
                            <p>Trovati ${data.withdrawals.length} prelievi</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                    updateWithdrawalsList();
                } else {
                    document.getElementById('api-result').innerHTML = `
                        <div class="error">
                            <h4>‚ùå Errore API Pending</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Errore di rete</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Test API details
        async function testDetailsAPI(id = 1) {
            try {
                const response = await fetch(`/withdrawals/api/admin/details/${id}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('api-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ API Details funziona per ID ${id}!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    document.getElementById('api-result').innerHTML = `
                        <div class="error">
                            <h4>‚ùå Errore API Details per ID ${id}</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('api-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Errore di rete per ID ${id}</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Test pulsante dettagli (simula la funzione del template)
        async function testDetailsButton(withdrawalId) {
            try {
                console.log('testDetailsButton chiamata con ID:', withdrawalId);
                
                // Simula la funzione viewWithdrawalDetails del template
                const response = await fetch(`/withdrawals/api/admin/pending`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const withdrawal = data.withdrawals.find(w => w.id === withdrawalId);
                
                console.log('withdrawal trovato:', withdrawal);
                if (withdrawal) {
                    showWithdrawalDetailsModal(withdrawal);
                    document.getElementById('button-result').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Pulsante Dettagli funziona per ID ${withdrawalId}!</h4>
                            <p>Modal mostrato con successo</p>
                        </div>
                    `;
                } else {
                    throw new Error('Prelievo non trovato');
                }
            } catch (error) {
                console.error('Errore dettagli:', error);
                document.getElementById('button-result').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Errore nel pulsante dettagli per ID ${withdrawalId}</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Mostra modal dettagli (simula la funzione del template)
        function showWithdrawalDetailsModal(withdrawal) {
            console.log('showWithdrawalDetailsModal chiamata con:', withdrawal);
            
            // Dettagli specifici per metodo
            let methodDetails = '';
            if (withdrawal.method === 'usdt') {
                const network = withdrawal.network || 'BEP20';
                const networkLabel = network === 'BEP20' ? 'BSC (BEP20)' : 
                                    network === 'ERC20' ? 'Ethereum (ERC20)' : 
                                    network === 'TRC20' ? 'Tron (TRC20)' : network;
                
                methodDetails = `
                    <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <h4 style="color: #1e40af; margin: 0 0 12px 0;">üí≥ Dettagli USDT</h4>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #1e40af;">Rete:</span>
                                <span style="font-weight: bold; color: #1e3a8a;">${networkLabel}</span>
                            </div>
                            <div>
                                <span style="font-weight: 500; color: #1e40af;">Indirizzo Wallet:</span>
                                <div style="margin-top: 4px; padding: 8px; background: white; border: 1px solid #0ea5e9; border-radius: 4px; font-family: monospace; font-size: 12px; word-break: break-all;">
                                    ${withdrawal.wallet_address}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const bankDetails = withdrawal.bank_details || {};
                methodDetails = `
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <h4 style="color: #166534; margin: 0 0 12px 0;">üè¶ Dettagli Bancari</h4>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #166534;">IBAN:</span>
                                <span style="font-family: monospace; color: #14532d;">${bankDetails.iban || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #166534;">Intestatario:</span>
                                <span style="font-weight: bold; color: #14532d;">${bankDetails.account_holder || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #166534;">Banca:</span>
                                <span style="color: #14532d;">${bankDetails.bank_name || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const content = `
                <div style="padding: 20px;">
                    <h2 style="margin: 0 0 20px 0; color: #1f2937;">Dettagli Prelievo</h2>
                    
                    <!-- Header con info principali -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üë§ Utente</label>
                                <p style="margin: 4px 0; font-weight: bold; color: #111827;">${withdrawal.full_name || 'N/A'}</p>
                                <p style="margin: 4px 0; color: #6b7280;">${withdrawal.email || 'N/A'}</p>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üí∞ Importo</label>
                                <p style="margin: 4px 0; font-size: 18px; font-weight: bold; color: #059669;">‚Ç¨${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info prelievo -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìã Metodo</label>
                            <p style="margin: 4px 0; font-weight: bold; color: #111827;">${withdrawal.method === 'usdt' ? 'USDT' : 'Bonifico Bancario'}</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìÇ Sezione</label>
                            <p style="margin: 4px 0; font-weight: bold; color: #111827;">${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                              withdrawal.source_section === 'profits' ? 'Profitti' : 
                              withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : withdrawal.source_section}</p>
                        </div>
                    </div>
                    
                    <!-- Chiave unica -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üîë Chiave Unica</label>
                        <div style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 14px;">
                            ${withdrawal.unique_key}
                        </div>
                    </div>
                    
                    <!-- Dettagli specifici metodo -->
                    ${methodDetails}
                    
                    <!-- Info temporali -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìÖ Data Richiesta</label>
                            <p style="margin: 4px 0; color: #111827;">${new Date(withdrawal.created_at).toLocaleString('it-IT')}</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">‚è±Ô∏è Tempo in Attesa</label>
                            <p style="margin: 4px 0; color: #111827;">
                                ${withdrawal.hours_pending ? withdrawal.hours_pending.toFixed(1) + ' ore' : 'N/A'}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìä Stato</label>
                        <span style="display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; background: #fef3c7; color: #92400e;">
                            ${withdrawal.status === 'pending' ? 'In Attesa' : 
                              withdrawal.status === 'completed' ? 'Completato' : 
                              withdrawal.status === 'cancelled' ? 'Rifiutato' : withdrawal.status}
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('withdrawal-details-content').innerHTML = content;
            document.getElementById('withdrawal-details-modal').style.display = 'block';
        }

        // Chiudi modal
        function closeModal() {
            document.getElementById('withdrawal-details-modal').style.display = 'none';
        }

        // Aggiorna lista prelievi
        function updateWithdrawalsList() {
            const list = document.getElementById('withdrawals-list');
            if (currentWithdrawals.length === 0) {
                list.innerHTML = '<p>Nessun prelievo disponibile</p>';
                return;
            }
            
            list.innerHTML = currentWithdrawals.map(w => `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                    <strong>ID ${w.id}</strong> - ${w.method.toUpperCase()} - ‚Ç¨${parseFloat(w.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                    <button onclick="testDetailsButton(${w.id})" style="float: right;">Dettagli</button>
                </div>
            `).join('');
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modal = document.getElementById('withdrawal-details-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Carica dati iniziali
        window.onload = function() {
            testPendingAPI();
        };
    </script>
</body>
</html>
