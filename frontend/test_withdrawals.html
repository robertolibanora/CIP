<!DOCTYPE html>
<html>
<head>
    <title>Test Withdrawals</title>
</head>
<body>
    <h1>Test Withdrawals API</h1>
    <button onclick="testWithdrawals()">Test API</button>
    <button onclick="testDetails()">Test Details</button>
    <div id="result"></div>

    <script>
        async function testWithdrawals() {
            try {
                const response = await fetch('/withdrawals/api/admin/pending');
                const data = await response.json();
                document.getElementById('result').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                console.log('Withdrawals data:', data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = 'Error: ' + error.message;
            }
        }

        async function testDetails() {
            try {
                // Simula la chiamata che fa il pulsante dettagli
                const response = await fetch('/withdrawals/api/admin/pending');
                const data = await response.json();
                
                if (data.withdrawals && data.withdrawals.length > 0) {
                    const withdrawal = data.withdrawals[0];
                    console.log('Testing details for withdrawal:', withdrawal);
                    
                    // Simula la funzione viewWithdrawalDetails
                    showWithdrawalDetailsModal(withdrawal);
                } else {
                    document.getElementById('result').innerHTML = 'No withdrawals found';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = 'Error: ' + error.message;
            }
        }

        function showWithdrawalDetailsModal(withdrawal) {
            console.log('showWithdrawalDetailsModal called with:', withdrawal);
            
            // Dettagli specifici per metodo
            let methodDetails = '';
            if (withdrawal.method === 'usdt') {
                const network = withdrawal.network || 'BEP20';
                const networkLabel = network === 'BEP20' ? 'BSC (BEP20)' : 
                                    network === 'ERC20' ? 'Ethereum (ERC20)' : 
                                    network === 'TRC20' ? 'Tron (TRC20)' : network;
                
                methodDetails = `
                    <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <h4 style="color: #1e40af; margin: 0 0 12px 0;">üí≥ Dettagli USDT</h4>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #1e40af;">Rete:</span>
                                <span style="font-weight: bold; color: #1e3a8a;">${networkLabel}</span>
                            </div>
                            <div>
                                <span style="font-weight: 500; color: #1e40af;">Indirizzo Wallet:</span>
                                <div style="margin-top: 4px; padding: 8px; background: white; border: 1px solid #0ea5e9; border-radius: 4px; font-family: monospace; font-size: 12px; word-break: break-all;">
                                    ${withdrawal.wallet_address}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const bankDetails = withdrawal.bank_details || {};
                methodDetails = `
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <h4 style="color: #166534; margin: 0 0 12px 0;">üè¶ Dettagli Bancari</h4>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #166534;">IBAN:</span>
                                <span style="font-family: monospace; color: #14532d;">${bankDetails.iban || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #166534;">Intestatario:</span>
                                <span style="font-weight: bold; color: #14532d;">${bankDetails.account_holder || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 500; color: #166534;">Banca:</span>
                                <span style="color: #14532d;">${bankDetails.bank_name || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const content = `
                <div style="padding: 20px; max-width: 600px; margin: 20px auto; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <h2 style="margin: 0 0 20px 0; color: #1f2937;">Dettagli Prelievo</h2>
                    
                    <!-- Header con info principali -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üë§ Utente</label>
                                <p style="margin: 4px 0; font-weight: bold; color: #111827;">${withdrawal.full_name || 'N/A'}</p>
                                <p style="margin: 4px 0; color: #6b7280;">${withdrawal.email || 'N/A'}</p>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üí∞ Importo</label>
                                <p style="margin: 4px 0; font-size: 18px; font-weight: bold; color: #059669;">‚Ç¨${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info prelievo -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìã Metodo</label>
                            <p style="margin: 4px 0; font-weight: bold; color: #111827;">${withdrawal.method === 'usdt' ? 'USDT' : 'Bonifico Bancario'}</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìÇ Sezione</label>
                            <p style="margin: 4px 0; font-weight: bold; color: #111827;">${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                              withdrawal.source_section === 'profits' ? 'Profitti' : 
                              withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : withdrawal.source_section}</p>
                        </div>
                    </div>
                    
                    <!-- Chiave unica -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üîë Chiave Unica</label>
                        <div style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 14px;">
                            ${withdrawal.unique_key}
                        </div>
                    </div>
                    
                    <!-- Dettagli specifici metodo -->
                    ${methodDetails}
                    
                    <!-- Info temporali -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìÖ Data Richiesta</label>
                            <p style="margin: 4px 0; color: #111827;">${new Date(withdrawal.created_at).toLocaleString('it-IT')}</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">‚è±Ô∏è Tempo in Attesa</label>
                            <p style="margin: 4px 0; color: ${withdrawal.hours_pending > 24 ? '#dc2626' : '#111827'}; font-weight: ${withdrawal.hours_pending > 24 ? 'bold' : 'normal'};">
                                ${withdrawal.hours_pending ? withdrawal.hours_pending.toFixed(1) + ' ore' : 'N/A'}
                                ${withdrawal.hours_pending > 24 ? ' (URGENTE!)' : ''}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 4px;">üìä Stato</label>
                        <span style="display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; background: #fef3c7; color: #92400e;">
                            ${withdrawal.status === 'pending' ? 'In Attesa' : 
                              withdrawal.status === 'completed' ? 'Completato' : 
                              withdrawal.status === 'cancelled' ? 'Rifiutato' : withdrawal.status}
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('result').innerHTML = content;
        }
    </script>
</body>
</html>
