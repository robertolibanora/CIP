<!DOCTYPE html>
<html>
<head>
    <title>Test Prelievi Admin</title>
</head>
<body>
    <h1>Test Prelievi Admin</h1>
    <div id="withdrawals-container">Caricamento...</div>
    <div id="withdrawals-count">0 richieste trovate</div>

    <script>
        let currentWithdrawals = [];

        // Carica prelievi in attesa
        async function loadPendingWithdrawals() {
            try {
                console.log('Caricamento prelievi in corso...');
                const response = await fetch('http://ciprealestate.eu/withdrawals/api/admin/pending', {
                    credentials: 'include'
                });
                console.log('Risposta API:', response.status, response.ok);
                const data = await response.json();
                console.log('Dati ricevuti:', data);
                
                currentWithdrawals = data.withdrawals || [];
                renderWithdrawals();
            } catch (error) {
                console.error('Errore nel caricamento prelievi:', error);
                currentWithdrawals = [];
                renderWithdrawals();
            }
        }

        // Renderizza prelievi
        function renderWithdrawals() {
            const container = document.getElementById('withdrawals-container');
            const countElement = document.getElementById('withdrawals-count');
            
            console.log('Rendering prelievi:', currentWithdrawals);
            
            if (currentWithdrawals.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun prelievo</h3>
                        <p class="text-gray-600">Non ci sono richieste di prelievo in attesa.</p>
                    </div>
                `;
                countElement.textContent = '0 richieste trovate';
                return;
            }
            
            countElement.textContent = `${currentWithdrawals.length} richieste trovate`;
            
            container.innerHTML = currentWithdrawals.map(withdrawal => `
                <div class="withdrawal-card border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Prelievo #${withdrawal.id}</p>
                                    <p class="text-xs text-gray-500">${withdrawal.nome} - ${withdrawal.email}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-4 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">${withdrawal.method === 'bank' ? 'IBAN' : 'Indirizzo'}</label>
                                    <p class="mt-1 text-sm text-gray-900 font-mono">${withdrawal.method === 'bank' ? (withdrawal.bank_details?.iban || 'N/A') : (withdrawal.wallet_address || 'N/A')}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Metodo</label>
                                    <p class="mt-1 text-sm text-gray-900">${withdrawal.method === 'bank' ? 'Bonifico' : 'USDT'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">${withdrawal.method === 'bank' ? 'Intestatario' : 'Rete'}</label>
                                    <p class="mt-1 text-sm text-gray-900 font-mono">${withdrawal.method === 'bank' ? (withdrawal.bank_details?.account_holder || 'N/A') : (withdrawal.network || 'BEP20')}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Sezione</label>
                                    <p class="mt-1 text-sm text-gray-900">${withdrawal.source_section === 'free_capital' ? 'Capitale Libero' : 
                                      withdrawal.source_section === 'profits' ? 'Profitti' : 
                                      withdrawal.source_section === 'referral_bonus' ? 'Bonus Referral' : withdrawal.source_section}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-shrink-0 w-80">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Note Admin</label>
                                <textarea id="admin-notes-${withdrawal.id}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" 
                                        rows="3" 
                                        placeholder="Aggiungi note per questo prelievo...">${withdrawal.admin_notes || ''}</textarea>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button onclick="approveWithdrawal(${withdrawal.id})" 
                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                                    Approva
                                </button>
                                <button onclick="rejectWithdrawal(${withdrawal.id})" 
                                        class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                                    Rifiuta
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                        <div>
                            <span class="text-2xl font-bold text-green-600">â‚¬${parseFloat(withdrawal.amount).toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
                            <p class="text-xs text-gray-500">Chiave: ${withdrawal.unique_key}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-900">${new Date(withdrawal.created_at).toLocaleDateString('it-IT')}</p>
                            <p class="text-xs text-gray-500">${new Date(withdrawal.created_at).toLocaleTimeString('it-IT')}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Funzioni placeholder
        function approveWithdrawal(id) {
            alert('Approvazione prelievo ' + id);
        }

        function rejectWithdrawal(id) {
            alert('Rifiuto prelievo ' + id);
        }

        // Carica dati al caricamento
        document.addEventListener('DOMContentLoaded', function() {
            loadPendingWithdrawals();
        });
    </script>
</body>
</html>
